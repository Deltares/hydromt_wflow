

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>hydromt_wflow.wflow &mdash; hydromt_wflow  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> hydromt_wflow
          

          
          </a>

          
            
            
              <div class="version">
                0.1.2.dev
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/index.html">Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user_guide/wflow/index.html">Wflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user_guide/sediment/index.html">Wflow Sediment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../advanced/workflows.html">Workflows</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References &amp; Help</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/api_index.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Whatâ€™s new</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">hydromt_wflow</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>hydromt_wflow.wflow</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for hydromt_wflow.wflow</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Implement wflow model class&quot;&quot;&quot;</span>
<span class="c1"># Implement model class following model API</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">isfile</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">box</span>
<span class="kn">import</span> <span class="nn">pyproj</span>
<span class="kn">import</span> <span class="nn">toml</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">from</span> <span class="nn">pyflwdir</span> <span class="kn">import</span> <span class="n">core_d8</span><span class="p">,</span> <span class="n">core_ldd</span><span class="p">,</span> <span class="n">core_conversion</span>
<span class="kn">from</span> <span class="nn">dask.diagnostics</span> <span class="kn">import</span> <span class="n">ProgressBar</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">LocalCluster</span><span class="p">,</span> <span class="n">Client</span><span class="p">,</span> <span class="n">performance_report</span>
<span class="kn">from</span> <span class="nn">hydromt.models.model_api</span> <span class="kn">import</span> <span class="n">Model</span>

<span class="c1"># from hydromt.workflows.basin_mask import parse_region</span>
<span class="kn">from</span> <span class="nn">hydromt</span> <span class="kn">import</span> <span class="n">workflows</span><span class="p">,</span> <span class="n">flw</span>
<span class="kn">from</span> <span class="nn">hydromt.io</span> <span class="kn">import</span> <span class="n">open_mfraster</span>

<span class="kn">from</span> <span class="nn">.workflows</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">river</span><span class="p">,</span>
    <span class="n">river_width</span><span class="p">,</span>
    <span class="n">waterbodymaps</span><span class="p">,</span>
    <span class="n">reservoirattrs</span><span class="p">,</span>
    <span class="n">soilgrids</span><span class="p">,</span>
    <span class="n">glaciermaps</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.workflows</span> <span class="kn">import</span> <span class="n">landuse</span><span class="p">,</span> <span class="n">lai</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">DATADIR</span>

<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;WflowModel&quot;</span><span class="p">]</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># specify pcraster map types</span>
<span class="c1"># NOTE non scalar (float) data types only</span>
<span class="n">PCR_VS_MAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;wflow_ldd&quot;</span><span class="p">:</span> <span class="s2">&quot;ldd&quot;</span><span class="p">,</span>
    <span class="s2">&quot;wflow_river&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">,</span>
    <span class="s2">&quot;wflow_streamorder&quot;</span><span class="p">:</span> <span class="s2">&quot;ordinal&quot;</span><span class="p">,</span>
    <span class="s2">&quot;wflow_gauges&quot;</span><span class="p">:</span> <span class="s2">&quot;nominal&quot;</span><span class="p">,</span>  <span class="c1"># to avoid large memory usage in pcraster.aguila</span>
    <span class="s2">&quot;wflow_subcatch&quot;</span><span class="p">:</span> <span class="s2">&quot;nominal&quot;</span><span class="p">,</span>  <span class="c1"># idem.</span>
    <span class="s2">&quot;wflow_landuse&quot;</span><span class="p">:</span> <span class="s2">&quot;nominal&quot;</span><span class="p">,</span>
    <span class="s2">&quot;wflow_soil&quot;</span><span class="p">:</span> <span class="s2">&quot;nominal&quot;</span><span class="p">,</span>
    <span class="s2">&quot;wflow_reservoirareas&quot;</span><span class="p">:</span> <span class="s2">&quot;nominal&quot;</span><span class="p">,</span>
    <span class="s2">&quot;wflow_reservoirlocs&quot;</span><span class="p">:</span> <span class="s2">&quot;nominal&quot;</span><span class="p">,</span>
    <span class="s2">&quot;wflow_lakeareas&quot;</span><span class="p">:</span> <span class="s2">&quot;nominal&quot;</span><span class="p">,</span>
    <span class="s2">&quot;wflow_lakelocs&quot;</span><span class="p">:</span> <span class="s2">&quot;nominal&quot;</span><span class="p">,</span>
    <span class="s2">&quot;wflow_glacierareas&quot;</span><span class="p">:</span> <span class="s2">&quot;nominal&quot;</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="WflowModel"><a class="viewcode-back" href="../../generated/hydromt_wflow.wflow.WflowModel.html#hydromt_wflow.wflow.WflowModel">[docs]</a><span class="k">class</span> <span class="nc">WflowModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is the wflow model class&quot;&quot;&quot;</span>

    <span class="n">_NAME</span> <span class="o">=</span> <span class="s2">&quot;wflow&quot;</span>
    <span class="n">_CONF</span> <span class="o">=</span> <span class="s2">&quot;wflow_sbm.toml&quot;</span>
    <span class="n">_DATADIR</span> <span class="o">=</span> <span class="n">DATADIR</span>
    <span class="n">_GEOMS</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_MAPS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;flwdir&quot;</span><span class="p">:</span> <span class="s2">&quot;wflow_ldd&quot;</span><span class="p">,</span>
        <span class="s2">&quot;uparea&quot;</span><span class="p">:</span> <span class="s2">&quot;wflow_uparea&quot;</span><span class="p">,</span>
        <span class="s2">&quot;strord&quot;</span><span class="p">:</span> <span class="s2">&quot;wflow_streamorder&quot;</span><span class="p">,</span>
        <span class="s2">&quot;basins&quot;</span><span class="p">:</span> <span class="s2">&quot;wflow_subcatch&quot;</span><span class="p">,</span>
        <span class="s2">&quot;elevtn&quot;</span><span class="p">:</span> <span class="s2">&quot;wflow_dem&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rivlen&quot;</span><span class="p">:</span> <span class="s2">&quot;wflow_riverlength&quot;</span><span class="p">,</span>
        <span class="s2">&quot;lndslp&quot;</span><span class="p">:</span> <span class="s2">&quot;Slope&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rivslp&quot;</span><span class="p">:</span> <span class="s2">&quot;RiverSlope&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rivmsk&quot;</span><span class="p">:</span> <span class="s2">&quot;wflow_river&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rivwth&quot;</span><span class="p">:</span> <span class="s2">&quot;wflow_riverwidth&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rivbed&quot;</span><span class="p">:</span> <span class="s2">&quot;RiverZ&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gauges&quot;</span><span class="p">:</span> <span class="s2">&quot;wflow_gauges&quot;</span><span class="p">,</span>
        <span class="s2">&quot;landuse&quot;</span><span class="p">:</span> <span class="s2">&quot;wflow_landuse&quot;</span><span class="p">,</span>
        <span class="s2">&quot;resareas&quot;</span><span class="p">:</span> <span class="s2">&quot;wflow_reservoirareas&quot;</span><span class="p">,</span>
        <span class="s2">&quot;reslocs&quot;</span><span class="p">:</span> <span class="s2">&quot;wflow_reservoirlocs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;lakeareas&quot;</span><span class="p">:</span> <span class="s2">&quot;wflow_lakeareas&quot;</span><span class="p">,</span>
        <span class="s2">&quot;lakelocs&quot;</span><span class="p">:</span> <span class="s2">&quot;wflow_lakelocs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;glacareas&quot;</span><span class="p">:</span> <span class="s2">&quot;wflow_glacierareas&quot;</span><span class="p">,</span>
        <span class="s2">&quot;glacfracs&quot;</span><span class="p">:</span> <span class="s2">&quot;wflow_glacierfrac&quot;</span><span class="p">,</span>
        <span class="s2">&quot;glacstore&quot;</span><span class="p">:</span> <span class="s2">&quot;wflow_glacierstore&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">_FOLDERS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;staticgeoms&quot;</span><span class="p">,</span>
        <span class="s2">&quot;instate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;run_default&quot;</span><span class="p">,</span>
    <span class="p">]</span>

<div class="viewcode-block" id="WflowModel.__init__"><a class="viewcode-back" href="../../generated/hydromt_wflow.wflow.WflowModel.html#hydromt_wflow.wflow.WflowModel.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">root</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
        <span class="n">config_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">data_libs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deltares_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">root</span><span class="o">=</span><span class="n">root</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">config_fn</span><span class="o">=</span><span class="n">config_fn</span><span class="p">,</span>
            <span class="n">data_libs</span><span class="o">=</span><span class="n">data_libs</span><span class="p">,</span>
            <span class="n">deltares_data</span><span class="o">=</span><span class="n">deltares_data</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># wflow specific</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_intbl</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flwdir</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="c1"># COMPONENTS</span>
<div class="viewcode-block" id="WflowModel.setup_basemaps"><a class="viewcode-back" href="../../generated/hydromt_wflow.wflow.WflowModel.setup_basemaps.html#hydromt_wflow.wflow.WflowModel.setup_basemaps">[docs]</a>    <span class="k">def</span> <span class="nf">setup_basemaps</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">region</span><span class="p">,</span>
        <span class="n">res</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="mf">120.0</span><span class="p">,</span>
        <span class="n">hydrography_fn</span><span class="o">=</span><span class="s2">&quot;merit_hydro&quot;</span><span class="p">,</span>
        <span class="n">basin_index_fn</span><span class="o">=</span><span class="s2">&quot;merit_hydro_index&quot;</span><span class="p">,</span>
        <span class="n">upscale_method</span><span class="o">=</span><span class="s2">&quot;ihu&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This component sets the ``region`` of interest and ``res`` (resolution in degrees) of the</span>
<span class="sd">        model. All DEM and flow direction related maps are then build.</span>

<span class="sd">        If the model resolution is larger than the source data resolution,</span>
<span class="sd">        the flow direction is upscaled using the ``upscale_method``, by default the</span>
<span class="sd">        Iterative Hydrography Upscaling (IHU).</span>
<span class="sd">        The default ``hydrography_fn`` is &quot;merit_hydro&quot; (`MERIT hydro &lt;http://hydro.iis.u-tokyo.ac.jp/~yamadai/MERIT_Hydro/index.html&gt;`_</span>
<span class="sd">        at 3 arcsec resolution) Alternative sources include &quot;merit_hydro_1k&quot; at 30 arcsec resolution.</span>
<span class="sd">        Users can also supply their own elevation and flow direction data. Note that only EPSG:4326 base data supported.</span>

<span class="sd">        Adds model layers:</span>

<span class="sd">        * **wflow_ldd** map: flow direction in LDD format [-]</span>
<span class="sd">        * **wflow_subcatch** map: basin ID map [-]</span>
<span class="sd">        * **wflow_uparea** map: upstream area [km2]</span>
<span class="sd">        * **wflow_streamorder** map: Strahler stream order [-]</span>
<span class="sd">        * **wflow_dem** map: average elevation [m]</span>
<span class="sd">        * **Slope** map: average land surface slope [m/m]</span>
<span class="sd">        * **basins** geom: basins boundary vector</span>
<span class="sd">        * **region** geom: region boundary vector</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hydrography_fn : {&#39;merit_hydro&#39;, &#39;merit_hydro_1k&#39;}</span>
<span class="sd">            Name of data source for basemap parameters, see data/data_sources.yml.</span>

<span class="sd">            * Required variables: [&#39;flwdir&#39;, &#39;uparea&#39;, &#39;basins&#39;, &#39;strord&#39;, &#39;elevtn&#39;]</span>

<span class="sd">            * Optional variables: [&#39;lndslp&#39;, &#39;mask&#39;]</span>
<span class="sd">        basin_index_fn : str</span>
<span class="sd">            Name of data source for basin_index data linked to hydrography_fn.</span>
<span class="sd">        region : dict</span>
<span class="sd">            Dictionary describing region of interest.</span>
<span class="sd">            See :py:function:~basin_mask.parse_region for all options</span>
<span class="sd">        res : float</span>
<span class="sd">            Output model resolution</span>
<span class="sd">        upscale_method : {&#39;ihu&#39;, &#39;eam&#39;, &#39;dmm&#39;}</span>
<span class="sd">            Upscaling method for flow direction data, by default &#39;ihu&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing base hydrography basemaps.&quot;</span><span class="p">)</span>
        <span class="c1"># retrieve global data (lazy!)</span>
        <span class="n">ds_org</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_rasterdataset</span><span class="p">(</span><span class="n">hydrography_fn</span><span class="p">)</span>
        <span class="c1"># TODO support and test (user) data from other sources with other crs!</span>
        <span class="k">if</span> <span class="n">ds_org</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ds_org</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">to_epsg</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">4326</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only EPSG:4326 base data supported.&quot;</span><span class="p">)</span>
        <span class="c1"># get basin geometry and clip data</span>
        <span class="n">kind</span><span class="p">,</span> <span class="n">region</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">parse_region</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;basin&quot;</span><span class="p">,</span> <span class="s2">&quot;subbasin&quot;</span><span class="p">,</span> <span class="s2">&quot;outlet&quot;</span><span class="p">]:</span>
            <span class="n">bas_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="p">[</span><span class="n">basin_index_fn</span><span class="p">]</span>
            <span class="n">geom</span><span class="p">,</span> <span class="n">xy</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">get_basin_geometry</span><span class="p">(</span>
                <span class="n">ds</span><span class="o">=</span><span class="n">ds_org</span><span class="p">,</span>
                <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
                <span class="n">basin_index</span><span class="o">=</span><span class="n">bas_index</span><span class="p">,</span>
                <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
                <span class="o">**</span><span class="n">region</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;bbox&quot;</span> <span class="ow">in</span> <span class="n">region</span><span class="p">:</span>
            <span class="n">bbox</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bbox&quot;</span><span class="p">)</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">bbox</span><span class="p">)],</span> <span class="n">crs</span><span class="o">=</span><span class="mi">4326</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;geom&quot;</span> <span class="ow">in</span> <span class="n">region</span><span class="p">:</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;geom&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;wflow region argument not understood: </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">geom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">geom</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;wflow region geometry has no CRS&quot;</span><span class="p">)</span>
        <span class="n">ds_org</span> <span class="o">=</span> <span class="n">ds_org</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">clip_geom</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="n">res</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding basins vector to staticgeoms.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_staticgeoms</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;basins&quot;</span><span class="p">)</span>

        <span class="c1"># setup hydrography maps and set staticmap attribute with renamed maps</span>
        <span class="n">ds_base</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">hydrography</span><span class="p">(</span>
            <span class="n">ds</span><span class="o">=</span><span class="n">ds_org</span><span class="p">,</span>
            <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="n">xy</span><span class="p">,</span>
            <span class="n">upscale_method</span><span class="o">=</span><span class="n">upscale_method</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Convert flow direction from d8 to ldd format</span>
        <span class="n">flwdir_data</span> <span class="o">=</span> <span class="n">ds_base</span><span class="p">[</span><span class="s2">&quot;flwdir&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>  <span class="c1"># force dtype</span>
        <span class="c1"># if d8 convert to ldd</span>
        <span class="k">if</span> <span class="n">core_d8</span><span class="o">.</span><span class="n">isvalid</span><span class="p">(</span><span class="n">flwdir_data</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">core_conversion</span><span class="o">.</span><span class="n">d8_to_ldd</span><span class="p">(</span><span class="n">flwdir_data</span><span class="p">)</span>
            <span class="n">da_flwdir</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;flwdir&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                <span class="n">coords</span><span class="o">=</span><span class="n">ds_base</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                <span class="n">dims</span><span class="o">=</span><span class="n">ds_base</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
                <span class="n">attrs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;ldd flow direction&quot;</span><span class="p">,</span>
                    <span class="n">_FillValue</span><span class="o">=</span><span class="n">core_ldd</span><span class="o">.</span><span class="n">_mv</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">ds_base</span><span class="p">[</span><span class="s2">&quot;flwdir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">da_flwdir</span>
        <span class="c1"># Rename and add to staticmaps</span>
        <span class="n">rmdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ds_base</span><span class="o">.</span><span class="n">data_vars</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_staticmaps</span><span class="p">(</span><span class="n">ds_base</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rmdict</span><span class="p">))</span>

        <span class="c1"># setup topography maps</span>
        <span class="n">ds_topo</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">topography</span><span class="p">(</span>
            <span class="n">ds</span><span class="o">=</span><span class="n">ds_org</span><span class="p">,</span> <span class="n">ds_like</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;average&quot;</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span>
        <span class="p">)</span>
        <span class="n">rmdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ds_topo</span><span class="o">.</span><span class="n">data_vars</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_staticmaps</span><span class="p">(</span><span class="n">ds_topo</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rmdict</span><span class="p">))</span>
        <span class="c1"># set basin geometry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding region vector to staticgeoms.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_staticgeoms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;region&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="WflowModel.setup_rivers"><a class="viewcode-back" href="../../generated/hydromt_wflow.wflow.WflowModel.setup_rivers.html#hydromt_wflow.wflow.WflowModel.setup_rivers">[docs]</a>    <span class="k">def</span> <span class="nf">setup_rivers</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">hydrography_fn</span><span class="o">=</span><span class="s2">&quot;merit_hydro&quot;</span><span class="p">,</span>
        <span class="n">river_upa</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">slope_len</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
        <span class="n">n_river_mapping</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">min_rivlen_ratio</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This component sets the river parameter maps including a boolean river mask,</span>
<span class="sd">        length, slope.</span>

<span class="sd">        The river mask is based on the ``river_upa`` [km2] threshold, by default 30 km2.</span>
<span class="sd">        The length is defined as the distance from the subgrid outlet pixel to the next</span>
<span class="sd">        upstream subgrid outlet pixel. The slope is derived from the subgrid</span>
<span class="sd">        elevation difference between pixels at a half distance ``slope_len`` [km] up- and downstream</span>
<span class="sd">        from the subgrid outlet pixel, by default 2 km. If a pixel has multiple upstream neighbors the pixel</span>
<span class="sd">        with the largest upstream area is selected. The river elevation is based on the elevation of the river</span>
<span class="sd">        bed at outlet pixels of a cell. A dem_adjust step is added to make sure the elevation of the river bed</span>
<span class="sd">        decreases or stays the same as we go downstream along the river network Manning coefficient is derived</span>
<span class="sd">        based on a lookup table of the streamorder map.</span>

<span class="sd">        Adds model layers:</span>

<span class="sd">        * **wflow_river** map: river mask [-]</span>
<span class="sd">        * **wflow_riverlength** map: river length [m]</span>
<span class="sd">        * **RiverSlope** map: river slope [m/m]</span>
<span class="sd">        * **N_River** map: Manning coefficient for river cells [add]</span>
<span class="sd">        * **RiverZ** map: elevation of the river bed for rivercells only [m]</span>
<span class="sd">        * **rivers** geom: river vector based on wflow_river mask</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hydrography_fn : str, path</span>
<span class="sd">            Name of data source for basemap parameters, see data/data_sources.yml.</span>
<span class="sd">            Must be same as setup_basemaps for consitent results.</span>
<span class="sd">        river_upa : float</span>
<span class="sd">            minimum upstream area threshold for the river map [km2]</span>
<span class="sd">        slope_len : float</span>
<span class="sd">            length over which the river slope is calculated [km]</span>
<span class="sd">        min_rivlen_ratio: float</span>
<span class="sd">            minimum global river length to avg. cell resolution ratio, by default 0.1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing river maps.&quot;</span><span class="p">)</span>

        <span class="c1"># derive river mask, length, slope</span>
        <span class="n">ds_base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_rasterdataset</span><span class="p">(</span>
            <span class="n">hydrography_fn</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>
        <span class="n">inv_rename</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">}</span>

        <span class="n">ds_riv</span> <span class="o">=</span> <span class="n">river</span><span class="p">(</span>
            <span class="n">ds</span><span class="o">=</span><span class="n">ds_base</span><span class="p">,</span>
            <span class="n">ds_like</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">inv_rename</span><span class="p">),</span>
            <span class="n">river_upa</span><span class="o">=</span><span class="n">river_upa</span><span class="p">,</span>
            <span class="n">slope_len</span><span class="o">=</span><span class="n">slope_len</span><span class="p">,</span>
            <span class="n">channel_dir</span><span class="o">=</span><span class="s2">&quot;up&quot;</span><span class="p">,</span>
            <span class="n">min_rivlen_ratio</span><span class="o">=</span><span class="n">min_rivlen_ratio</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rmdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ds_riv</span><span class="o">.</span><span class="n">data_vars</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_staticmaps</span><span class="p">(</span><span class="n">ds_riv</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rmdict</span><span class="p">))</span>

        <span class="c1"># Make N_River map from csv file with mapping between streamorder and N_River value</span>
        <span class="k">if</span> <span class="n">n_river_mapping</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fn_map</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">DATADIR</span><span class="p">,</span> <span class="s2">&quot;wflow&quot;</span><span class="p">,</span> <span class="s2">&quot;N_river_mapping.csv&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn_map</span> <span class="o">=</span> <span class="n">n_river_mapping</span>
        <span class="n">strord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;strord&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fn_map</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,|;&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
        <span class="c1"># max streamorder value above which values get the same N_River value</span>
        <span class="n">max_str</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># if streamroder value larger than max_str, assign last value</span>
        <span class="n">strord</span> <span class="o">=</span> <span class="n">strord</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">strord</span> <span class="o">&lt;=</span> <span class="n">max_str</span><span class="p">,</span> <span class="n">max_str</span><span class="p">)</span>
        <span class="c1"># handle missing value (last row of csv is mapping of missing values)</span>
        <span class="n">strord</span> <span class="o">=</span> <span class="n">strord</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">strord</span> <span class="o">!=</span> <span class="n">strord</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">nodata</span><span class="p">,</span> <span class="o">-</span><span class="mi">999</span><span class="p">)</span>
        <span class="n">strord</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">set_nodata</span><span class="p">(</span><span class="o">-</span><span class="mi">999</span><span class="p">)</span>

        <span class="n">ds_nriver</span> <span class="o">=</span> <span class="n">landuse</span><span class="p">(</span>
            <span class="n">da</span><span class="o">=</span><span class="n">strord</span><span class="p">,</span>
            <span class="n">ds_like</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">,</span>
            <span class="n">fn_map</span><span class="o">=</span><span class="n">fn_map</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_staticmaps</span><span class="p">(</span><span class="n">ds_nriver</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding rivers vector to staticgeoms.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">staticgeoms</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;rivers&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># remove old rivers if in staticgeoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rivers</span>  <span class="c1"># add new rivers to staticgeoms</span></div>

<div class="viewcode-block" id="WflowModel.setup_riverwidth"><a class="viewcode-back" href="../../generated/hydromt_wflow.wflow.WflowModel.setup_riverwidth.html#hydromt_wflow.wflow.WflowModel.setup_riverwidth">[docs]</a>    <span class="k">def</span> <span class="nf">setup_riverwidth</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">predictor</span><span class="o">=</span><span class="s2">&quot;discharge&quot;</span><span class="p">,</span>
        <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">min_wth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">precip_fn</span><span class="o">=</span><span class="s2">&quot;chelsa&quot;</span><span class="p">,</span>
        <span class="n">climate_fn</span><span class="o">=</span><span class="s2">&quot;koppen_geiger&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This component sets the river width parameter based on a power-lay relationship with a predictor.</span>

<span class="sd">        By default the riverwidth is estimated based on discharge as ``predictor`` and used to</span>
<span class="sd">        set the riverwidth globally based on pre-defined power-law parameters per climate class.</span>
<span class="sd">        With ``fit`` set to True, the power-law relationsship paramters are set on-the-fly.</span>
<span class="sd">        With ``fill`` set to True, the estimated river widths are only used fill gaps in the</span>
<span class="sd">        observed data. Alternative ``predictor`` values are precip (accumulated precipitation)</span>
<span class="sd">        and uparea (upstream area). For these predictors values ``fit`` default to True.</span>
<span class="sd">        By default the predictor is based on discharge which is estimated through multiple linear</span>
<span class="sd">        regression with precipitation and upstream area per climate zone.</span>

<span class="sd">        * **wflow_riverwidth** map: river width [m]</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        predictor : {&quot;discharge&quot;, &quot;precip&quot;, &quot;uparea&quot;}</span>
<span class="sd">            Predictor used in the power-law equation: width = a * predictor ^ b.</span>
<span class="sd">            Discharge is based on multiple linear regression per climate zone.</span>
<span class="sd">            Precip is based on the 10x the daily average accumulated precipitation [m3/s].</span>
<span class="sd">            Uparea is based on the upstream area grid [km2].</span>
<span class="sd">            Other variables, e.g. bankfull discharge, can also be provided if present in the staticmaps</span>
<span class="sd">        fill : bool, optional</span>
<span class="sd">            If True (default), use estimate to fill gaps, outliers and lake/res areas in observed width data (if present);</span>
<span class="sd">            if False, set all riverwidths based on predictor (automatic choice if no observations found)</span>
<span class="sd">        fit : bool, optional kwarg</span>
<span class="sd">            If True, the power-law parameters are fitted on the fly</span>
<span class="sd">            By default True for all but &quot;discharge&quot; predictor.</span>
<span class="sd">            A-priori derived parameters will be overwritten if True.</span>
<span class="sd">        a, b : float, optional kwarg</span>
<span class="sd">            Manual power-law parameters</span>
<span class="sd">        min_wth : float</span>
<span class="sd">            minimum river width</span>
<span class="sd">        precip_fn : {&#39;chelsa&#39;}</span>
<span class="sd">            Source of long term precipitation grid if the predictor is set to &#39;discharge&#39; or &#39;precip&#39;.</span>
<span class="sd">        climate_fn: {&#39;koppen_geiger&#39;}</span>
<span class="sd">            Source of long-term climate grid if the predictor is set to &#39;discharge&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;rivmsk&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The setup_riverwidth method requies to run setup_river method first.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># derive river width</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">predictor</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;discharge&quot;</span><span class="p">,</span> <span class="s2">&quot;precip&quot;</span><span class="p">]:</span>
            <span class="n">da_precip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_rasterdataset</span><span class="p">(</span>
                <span class="n">precip_fn</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">da_precip</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">precip_fn</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;da_precip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">da_precip</span>
        <span class="k">if</span> <span class="n">predictor</span> <span class="o">==</span> <span class="s2">&quot;discharge&quot;</span><span class="p">:</span>
            <span class="n">da_climate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_rasterdataset</span><span class="p">(</span>
                <span class="n">climate_fn</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">da_climate</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">climate_fn</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;da_climate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">da_climate</span>

        <span class="n">inv_rename</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">}</span>
        <span class="n">da_rivwth</span> <span class="o">=</span> <span class="n">river_width</span><span class="p">(</span>
            <span class="n">ds_like</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">inv_rename</span><span class="p">),</span>
            <span class="n">flwdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flwdir</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">fill</span><span class="o">=</span><span class="n">fill</span><span class="p">,</span>
            <span class="n">fill_outliers</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;fill_outliers&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="p">),</span>
            <span class="n">min_wth</span><span class="o">=</span><span class="n">min_wth</span><span class="p">,</span>
            <span class="n">mask_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lakeareas&quot;</span><span class="p">,</span> <span class="s2">&quot;resareas&quot;</span><span class="p">,</span> <span class="s2">&quot;glacareas&quot;</span><span class="p">],</span>
            <span class="n">predictor</span><span class="o">=</span><span class="n">predictor</span><span class="p">,</span>
            <span class="n">a</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">b</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
            <span class="n">fit</span><span class="o">=</span><span class="n">fit</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_staticmaps</span><span class="p">(</span><span class="n">da_rivwth</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;rivwth&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="WflowModel.setup_lulcmaps"><a class="viewcode-back" href="../../generated/hydromt_wflow.wflow.WflowModel.setup_lulcmaps.html#hydromt_wflow.wflow.WflowModel.setup_lulcmaps">[docs]</a>    <span class="k">def</span> <span class="nf">setup_lulcmaps</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">lulc_fn</span><span class="o">=</span><span class="s2">&quot;globcover&quot;</span><span class="p">,</span>
        <span class="n">lulc_mapping_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">lulc_vars</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;landuse&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Kext&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PathFrac&quot;</span><span class="p">,</span>
            <span class="s2">&quot;RootingDepth&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Sl&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Swood&quot;</span><span class="p">,</span>
            <span class="s2">&quot;WaterFrac&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This component derives several wflow maps are derived based on landuse-</span>
<span class="sd">        landcover (LULC) data. </span>
<span class="sd">        </span>
<span class="sd">        Currently, ``lulc_fn`` can be set to the &quot;vito&quot;, &quot;globcover&quot;</span>
<span class="sd">        or &quot;corine&quot;, fo which lookup tables are constructed to convert lulc classses to</span>
<span class="sd">        model parameters based on literature. The data is remapped at its original</span>
<span class="sd">        resolution and then resampled to the model resolution using the average</span>
<span class="sd">        value, unless noted differently.</span>
<span class="sd">        </span>
<span class="sd">        Adds model layers:</span>

<span class="sd">        * **landuse** map: Landuse class [-]     </span>
<span class="sd">        * **Kext** map: Extinction coefficient in the canopy gap fraction equation [-]</span>
<span class="sd">        * **Sl** map: Specific leaf storage [mm]</span>
<span class="sd">        * **Swood** map: Fraction of wood in the vegetation/plant [-]</span>
<span class="sd">        * **RootingDepth** map: Length of vegetation roots [mm]</span>
<span class="sd">        * **PathFrac** map: The fraction of compacted or urban area per grid cell [-]</span>
<span class="sd">        * **WaterFrac** map: The fraction of open water per grid cell [-]</span>
<span class="sd">        * **N** map: Manning Roughness [-]</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lulc_fn : {&quot;globcover&quot;, &quot;vito&quot;, &quot;corine&quot;}</span>
<span class="sd">            Name of data source in data_sources.yml file.</span>
<span class="sd">        lulc_mapping_fn : str</span>
<span class="sd">            Path to a mapping csv file from landuse in source name to parameter values in lulc_vars.</span>
<span class="sd">        lulc_vars : list</span>
<span class="sd">            List of landuse parameters to keep.\</span>
<span class="sd">            By default [&quot;landuse&quot;,&quot;Kext&quot;,&quot;N&quot;,&quot;PathFrac&quot;,&quot;RootingDepth&quot;,&quot;Sl&quot;,&quot;Swood&quot;,&quot;WaterFrac&quot;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing LULC parameter maps.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lulc_mapping_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fn_map</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">DATADIR</span><span class="p">,</span> <span class="s2">&quot;lulc&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lulc_fn</span><span class="si">}</span><span class="s2">_mapping.csv&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn_map</span> <span class="o">=</span> <span class="n">lulc_mapping_fn</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isfile</span><span class="p">(</span><span class="n">fn_map</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LULC mapping file not found: </span><span class="si">{</span><span class="n">fn_map</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># read landuse map to DataArray</span>
        <span class="n">da</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_rasterdataset</span><span class="p">(</span>
            <span class="n">lulc_fn</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;landuse&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># process landuse</span>
        <span class="n">ds_lulc_maps</span> <span class="o">=</span> <span class="n">landuse</span><span class="p">(</span>
            <span class="n">da</span><span class="o">=</span><span class="n">da</span><span class="p">,</span>
            <span class="n">ds_like</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">,</span>
            <span class="n">fn_map</span><span class="o">=</span><span class="n">fn_map</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">lulc_vars</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">rmdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ds_lulc_maps</span><span class="o">.</span><span class="n">data_vars</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_staticmaps</span><span class="p">(</span><span class="n">ds_lulc_maps</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rmdict</span><span class="p">))</span></div>

<div class="viewcode-block" id="WflowModel.setup_laimaps"><a class="viewcode-back" href="../../generated/hydromt_wflow.wflow.WflowModel.setup_laimaps.html#hydromt_wflow.wflow.WflowModel.setup_laimaps">[docs]</a>    <span class="k">def</span> <span class="nf">setup_laimaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lai_fn</span><span class="o">=</span><span class="s2">&quot;model_lai&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This component sets leaf area index (LAI) climatoloy maps per month.</span>

<span class="sd">        The values are resampled to the model resolution using the average value.</span>
<span class="sd">        The only ``lai_fn`` currently supported is &quot;modis_lai&quot; based on MODIS data.</span>

<span class="sd">        Adds model layers:</span>

<span class="sd">        * **LAI** map: Leaf Area Index climatology [-]</span>
<span class="sd">            Resampled from source data using average. Assuming that missing values</span>
<span class="sd">            correspond to bare soil, these are set to zero before resampling.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lai_fn : {&#39;modis_lai&#39;}</span>
<span class="sd">            Name of data source for LAI parameters, see data/data_sources.yml.</span>

<span class="sd">            * Required variables: [&#39;LAI&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">lai_fn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;modis_lai&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid source &#39;</span><span class="si">{</span><span class="n">lai_fn</span><span class="si">}</span><span class="s2">&#39;, skipping setup_laimaps.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># retrieve data for region</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing LAI maps.&quot;</span><span class="p">)</span>
        <span class="n">da</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_rasterdataset</span><span class="p">(</span><span class="n">lai_fn</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">da_lai</span> <span class="o">=</span> <span class="n">lai</span><span class="p">(</span>
            <span class="n">da</span><span class="o">=</span><span class="n">da</span><span class="p">,</span>
            <span class="n">ds_like</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Rename the first dimension to time</span>
        <span class="n">rmdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">da_lai</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="s2">&quot;time&quot;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_staticmaps</span><span class="p">(</span><span class="n">da_lai</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rmdict</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;LAI&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="WflowModel.setup_gauges"><a class="viewcode-back" href="../../generated/hydromt_wflow.wflow.WflowModel.setup_gauges.html#hydromt_wflow.wflow.WflowModel.setup_gauges">[docs]</a>    <span class="k">def</span> <span class="nf">setup_gauges</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">gauges_fn</span><span class="o">=</span><span class="s2">&quot;grdc&quot;</span><span class="p">,</span>
        <span class="n">source_gdf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">snap_to_river</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">derive_subcatch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">derive_outlet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">basename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">update_toml</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">gauge_toml_header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">gauge_toml_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This components sets the default gauge map based on basin outlets and additional</span>
<span class="sd">        gauge maps based on ``gauges_fn`` data.</span>

<span class="sd">        Supported gauge datasets include &quot;grdc&quot;</span>
<span class="sd">        or &quot;&lt;path_to_source&gt;&quot; for user supplied csv or geometry files with gauge locations.</span>
<span class="sd">        If a csv file is provided, a &quot;x&quot; or &quot;lon&quot; and &quot;y&quot; or &quot;lat&quot; column is required</span>
<span class="sd">        and the first column will be used as IDs in the map. If ``snap_to_river`` is set</span>
<span class="sd">        to True, the gauge location will be snapped to the boolean river mask. If</span>
<span class="sd">        ``derive_subcatch`` is set to True, an additonal subcatch map is derived from</span>
<span class="sd">        the gauge locations.</span>

<span class="sd">        Adds model layers:</span>

<span class="sd">        * **wflow_gauges** map: gauge IDs map from catchment outlets [-]</span>
<span class="sd">        * **wflow_gauges_source** map: gauge IDs map from source [-] (if gauges_fn)</span>
<span class="sd">        * **wflow_subcatch_source** map: subcatchment based on gauge locations [-] (if derive_subcatch)</span>
<span class="sd">        * **gauges** geom: polygon of catchment outlets</span>
<span class="sd">        * **gauges_source** geom: polygon of gauges from source</span>
<span class="sd">        * **subcatch_source** geom: polygon of subcatchment based on gauge locations [-] (if derive_subcatch)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        gauges_fn : str, {&quot;grdc&quot;}, optional</span>
<span class="sd">            Known source name or path to gauges file geometry file, by default None.</span>
<span class="sd">        source_gdf : geopandas.GeoDataFame, optional</span>
<span class="sd">            Direct gauges file geometry, by default None.</span>
<span class="sd">        snap_to_river : bool, optional</span>
<span class="sd">            Snap point locations to the closest downstream river cell, by default True</span>
<span class="sd">        mask : np.boolean, optional</span>
<span class="sd">            If provided snaps to the mask, else snaps to the river (default).</span>
<span class="sd">        derive_subcatch : bool, optional</span>
<span class="sd">            Derive subcatch map for gauges, by default False</span>
<span class="sd">        derive_outlet : bool, optional</span>
<span class="sd">            Derive gaugemap based on catchment outlets, by default True</span>
<span class="sd">        basename : str, optional</span>
<span class="sd">            Map name in staticmaps (wflow_gauges_basename), if None use the gauges_fn basename.</span>
<span class="sd">        update_toml : boolean, optional</span>
<span class="sd">            Update [outputcsv] section of wflow toml file.</span>
<span class="sd">        gauge_toml_header : list, optional</span>
<span class="sd">            Save specific model parameters in csv section. This option defines the header of the csv file./</span>
<span class="sd">            By default saves Q (for lateral.river.q_av) and P (for vertical.precipitation).</span>
<span class="sd">        gauge_toml_param: list, optional</span>
<span class="sd">            Save specific model parameters in csv section. This option defines the wflow variable corresponding to the/</span>
<span class="sd">            names in gauge_toml_header. By default saves lateral.river.q_av (for Q) and vertical.precipitation (for P).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># read existing staticgeoms; important to get the right basin when updating</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">staticgeoms</span>

        <span class="k">if</span> <span class="n">derive_outlet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gauges locations set based on outlets.&quot;</span><span class="p">)</span>
            <span class="n">da</span><span class="p">,</span> <span class="n">idxs</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">flw</span><span class="o">.</span><span class="n">gaugemap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">,</span> <span class="n">idxs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flwdir</span><span class="o">.</span><span class="n">idxs_pit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_staticmaps</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;gauges&quot;</span><span class="p">])</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">points_from_xy</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">idx_to_xy</span><span class="p">(</span><span class="n">idxs</span><span class="p">))</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">points</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_staticgeoms</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;gauges&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gauges map based on catchment outlets added.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">gauges_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">source_gdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># append location from geometry</span>
            <span class="c1"># TODO check snapping locations based on upstream area attribute of the gauge data</span>
            <span class="k">if</span> <span class="n">gauges_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">gauges_fn</span><span class="p">):</span>
                    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
                <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_geodataframe</span><span class="p">(</span>
                    <span class="n">gauges_fn</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="p">,</span> <span class="n">assert_gtype</span><span class="o">=</span><span class="s2">&quot;Point&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>
                <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">source_gdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">basename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Basename is required when setting gauges based on source_gdf&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">source_gdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gauges locations read from source_gdf&quot;</span><span class="p">)</span>
                <span class="n">gdf</span> <span class="o">=</span> <span class="n">source_gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No </span><span class="si">{</span><span class="n">gauges_fn</span><span class="si">}</span><span class="s2"> gauge locations found within domain&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">basename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">basename</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">gauges_fn</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gdf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">basename</span><span class="si">}</span><span class="s2"> gauge locations found within domain&quot;</span>
                <span class="p">)</span>
                <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))(</span>
                    <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">xy_to_idx</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>

                <span class="k">if</span> <span class="n">snap_to_river</span> <span class="ow">and</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;rivmsk&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">da</span><span class="p">,</span> <span class="n">idxs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">flw</span><span class="o">.</span><span class="n">gaugemap</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">,</span>
                    <span class="n">idxs</span><span class="o">=</span><span class="n">idxs</span><span class="p">,</span>
                    <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
                    <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                    <span class="n">flwdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flwdir</span><span class="p">,</span>
                    <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">mapname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;gauges&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">basename</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_staticmaps</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">mapname</span><span class="p">)</span>

                <span class="c1"># geoms</span>
                <span class="n">points</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">points_from_xy</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">idx_to_xy</span><span class="p">(</span><span class="n">idxs</span><span class="p">))</span>
                <span class="c1"># if csv contains additional columns, these are also written in the staticgeoms</span>
                <span class="n">gdf_snapped</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">points</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
                <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf_snapped</span><span class="o">.</span><span class="n">geometry</span>
                <span class="c1"># if first column has no name, give it a default name otherwise column is omitted when written to geojson</span>
                <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">gdf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;fid&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_staticgeoms</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">mapname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;wflow_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

                <span class="c1"># # Add new outputcsv section in the config</span>
                <span class="k">if</span> <span class="n">gauge_toml_param</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">update_toml</span><span class="p">:</span>
                    <span class="n">gauge_toml_header</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">]</span>
                    <span class="n">gauge_toml_param</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lateral.river.q_av&quot;</span><span class="p">,</span> <span class="s2">&quot;vertical.precipitation&quot;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">update_toml</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;input.gauges_</span><span class="si">{</span><span class="n">basename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mapname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;csv&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gauge_toml_param</span><span class="p">)):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;csv&quot;</span><span class="p">][</span><span class="s2">&quot;column&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;header&quot;</span><span class="p">:</span> <span class="n">gauge_toml_header</span><span class="p">[</span><span class="n">o</span><span class="p">],</span>
                                    <span class="s2">&quot;map&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;gauges_</span><span class="si">{</span><span class="n">basename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;parameter&quot;</span><span class="p">:</span> <span class="n">gauge_toml_param</span><span class="p">[</span><span class="n">o</span><span class="p">],</span>
                                <span class="p">}</span>
                            <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gauges map from </span><span class="si">{</span><span class="n">basename</span><span class="si">}</span><span class="s2"> added.&quot;</span><span class="p">)</span>

                <span class="c1"># add subcatch</span>
                <span class="k">if</span> <span class="n">derive_subcatch</span><span class="p">:</span>
                    <span class="n">da_basins</span> <span class="o">=</span> <span class="n">flw</span><span class="o">.</span><span class="n">basin_map</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flwdir</span><span class="p">,</span> <span class="n">idxs</span><span class="o">=</span><span class="n">idxs</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="n">ids</span>
                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">mapname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;basins&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">basename</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_staticmaps</span><span class="p">(</span><span class="n">da_basins</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">mapname</span><span class="p">)</span>
                    <span class="n">gdf_basins</span> <span class="o">=</span> <span class="n">flw</span><span class="o">.</span><span class="n">basin_shape</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flwdir</span><span class="p">,</span> <span class="n">basin_name</span><span class="o">=</span><span class="n">mapname</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_staticgeoms</span><span class="p">(</span><span class="n">gdf_basins</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">mapname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;wflow_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="WflowModel.setup_areamap"><a class="viewcode-back" href="../../generated/hydromt_wflow.wflow_sediment.WflowModel.setup_areamap.html#hydromt_wflow.wflow.WflowModel.setup_areamap">[docs]</a>    <span class="k">def</span> <span class="nf">setup_areamap</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">area_fn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">col2raster</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup area map from vector data to save wflow outputs for specific area.</span>
<span class="sd">        Adds model layer:</span>
<span class="sd">        * **area_fn** map:  output area data map</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        area_fn : str</span>
<span class="sd">            Name of vector data corresponding to wflow output area.</span>
<span class="sd">        col2raster : str</span>
<span class="sd">            Name of the column from the vector file to rasterize.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">area_fn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid source &#39;</span><span class="si">{</span><span class="n">area_fn</span><span class="si">}</span><span class="s2">&#39;, skipping setup_areamap.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing &#39;</span><span class="si">{</span><span class="n">area_fn</span><span class="si">}</span><span class="s2">&#39; map.&quot;</span><span class="p">)</span>
        <span class="n">gdf_org</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_geodataframe</span><span class="p">(</span>
            <span class="n">area_fn</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="p">,</span> <span class="n">dst_crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">gdf_org</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No shapes of </span><span class="si">{</span><span class="n">area_fn</span><span class="si">}</span><span class="s2"> found within region, skipping areamap.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">da_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span>
                <span class="n">gdf</span><span class="o">=</span><span class="n">gdf_org</span><span class="p">,</span>
                <span class="n">col_name</span><span class="o">=</span><span class="n">col2raster</span><span class="p">,</span>
                <span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">all_touched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_staticmaps</span><span class="p">(</span><span class="n">da_area</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">area_fn</span><span class="p">))</span></div>

<div class="viewcode-block" id="WflowModel.setup_lakes"><a class="viewcode-back" href="../../generated/hydromt_wflow.wflow.WflowModel.setup_lakes.html#hydromt_wflow.wflow.WflowModel.setup_lakes">[docs]</a>    <span class="k">def</span> <span class="nf">setup_lakes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lakes_fn</span><span class="o">=</span><span class="s2">&quot;hydro_lakes&quot;</span><span class="p">,</span> <span class="n">min_area</span><span class="o">=</span><span class="mf">10.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This component generates maps of lake areas and outlets as well as parameters</span>
<span class="sd">        with average lake area, depth a discharge values.</span>

<span class="sd">        The data is generated from features with ``min_area`` [km2] from a database with</span>
<span class="sd">        lake geometry, IDs and metadata. Currently, &quot;hydro_lakes&quot; (hydroLakes) is the only</span>
<span class="sd">        supported ``lakes_fn`` data source and we use a default minimum area of 1 km2.</span>

<span class="sd">        Adds model layers:</span>

<span class="sd">        * **wflow_lakeareas** map: lake IDs [-]</span>
<span class="sd">        * **wflow_lakelocs** map: lake IDs at outlet locations [-]</span>
<span class="sd">        * **LakeArea** map: lake area [m2]</span>
<span class="sd">        * **LakeAvgLevel** map: lake average water level [m]</span>
<span class="sd">        * **LakeAvgOut** map: lake average discharge [m3/s]</span>
<span class="sd">        * **Lake_b** map: lake rating curve coefficient [-]</span>
<span class="sd">        * **lakes** geom: polygon with lakes and wflow lake parameters</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lakes_fn : {&#39;hydro_lakes&#39;}</span>
<span class="sd">            Name of data source for lake parameters, see data/data_sources.yml.</span>

<span class="sd">            * Required variables: [&#39;waterbody_id&#39;, &#39;Area_avg&#39;, &#39;Vol_avg&#39;, &#39;Depth_avg&#39;, &#39;Dis_avg&#39;]</span>
<span class="sd">        min_area : float, optional</span>
<span class="sd">            Minimum lake area threshold [km2], by default 1.0 km2.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">lakes_toml</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;model.lakes&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;state.lateral.river.lake.waterlevel&quot;</span><span class="p">:</span> <span class="s2">&quot;waterlevel_lake&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">lakes_fn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;hydro_lakes&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid source &#39;</span><span class="si">{</span><span class="n">lakes_fn</span><span class="si">}</span><span class="s2">&#39;, skipping setup_lakes.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">gdf_org</span><span class="p">,</span> <span class="n">ds_lakes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_waterbodies</span><span class="p">(</span><span class="n">lakes_fn</span><span class="p">,</span> <span class="s2">&quot;lake&quot;</span><span class="p">,</span> <span class="n">min_area</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ds_lakes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rmdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ds_lakes</span><span class="o">.</span><span class="n">data_vars</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_staticmaps</span><span class="p">(</span><span class="n">ds_lakes</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rmdict</span><span class="p">))</span>
            <span class="c1"># add waterbody parameters</span>
            <span class="c1"># rename to param values</span>
            <span class="n">gdf_org</span> <span class="o">=</span> <span class="n">gdf_org</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;Area_avg&quot;</span><span class="p">:</span> <span class="s2">&quot;LakeArea&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Depth_avg&quot;</span><span class="p">:</span> <span class="s2">&quot;LakeAvgLevel&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Dis_avg&quot;</span><span class="p">:</span> <span class="s2">&quot;LakeAvgOut&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">gdf_org</span><span class="p">[</span><span class="s2">&quot;Lake_b&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">gdf_org</span><span class="p">[</span><span class="s2">&quot;LakeAvgOut&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">gdf_org</span><span class="p">[</span><span class="s2">&quot;LakeAvgLevel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">gdf_org</span><span class="p">[</span><span class="s2">&quot;Lake_e&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">gdf_org</span><span class="p">[</span><span class="s2">&quot;LakeStorFunc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">gdf_org</span><span class="p">[</span><span class="s2">&quot;LakeOutflowFunc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">gdf_org</span><span class="p">[</span><span class="s2">&quot;LakeThreshold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">gdf_org</span><span class="p">[</span><span class="s2">&quot;LinkedLakeLocs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">lake_params</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;waterbody_id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;LakeArea&quot;</span><span class="p">,</span>
                <span class="s2">&quot;LakeAvgLevel&quot;</span><span class="p">,</span>
                <span class="s2">&quot;LakeAvgOut&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Lake_b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Lake_e&quot;</span><span class="p">,</span>
                <span class="s2">&quot;LakeStorFunc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;LakeOutflowFunc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;LakeThreshold&quot;</span><span class="p">,</span>
                <span class="s2">&quot;LinkedLakeLocs&quot;</span><span class="p">,</span>
            <span class="p">]</span>

            <span class="n">gdf_org_points</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
                <span class="n">gdf_org</span><span class="p">[</span><span class="n">lake_params</span><span class="p">],</span>
                <span class="n">geometry</span><span class="o">=</span><span class="n">gpd</span><span class="o">.</span><span class="n">points_from_xy</span><span class="p">(</span><span class="n">gdf_org</span><span class="o">.</span><span class="n">xout</span><span class="p">,</span> <span class="n">gdf_org</span><span class="o">.</span><span class="n">yout</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># write lakes with attr tables to static geoms.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_staticgeoms</span><span class="p">(</span><span class="n">gdf_org</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;lakes&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">lake_params</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">da_lake</span> <span class="o">=</span> <span class="n">ds_lakes</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span>
                    <span class="n">gdf_org_points</span><span class="p">,</span> <span class="n">col_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=-</span><span class="mi">999</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_staticmaps</span><span class="p">(</span><span class="n">da_lake</span><span class="p">)</span>

            <span class="c1"># if there are lakes, change True in toml</span>
            <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">lakes_toml</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">lakes_toml</span><span class="p">[</span><span class="n">option</span><span class="p">])</span></div>

<div class="viewcode-block" id="WflowModel.setup_reservoirs"><a class="viewcode-back" href="../../generated/hydromt_wflow.wflow.WflowModel.setup_reservoirs.html#hydromt_wflow.wflow.WflowModel.setup_reservoirs">[docs]</a>    <span class="k">def</span> <span class="nf">setup_reservoirs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">reservoirs_fn</span><span class="o">=</span><span class="s2">&quot;hydro_reservoirs&quot;</span><span class="p">,</span>
        <span class="n">min_area</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">priority_jrc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This component generates maps of lake areas and outlets as well as parameters</span>
<span class="sd">        with average reservoir area, demand, min and max target storage capacities and</span>
<span class="sd">        discharge capacity values.</span>

<span class="sd">        The data is generated from features with ``min_area`` [km2]</span>
<span class="sd">        from a database with reservoir geometry, IDs and metadata.</span>
<span class="sd">        Currently, &quot;hydro_reservoirs&quot; (based on GRAND) is the only supported ``reservoirs_fn``</span>
<span class="sd">        data source and we use a default minimum area of 1 km2.</span>


<span class="sd">        Adds model layers:</span>

<span class="sd">        * **wflow_reservoirareas** map: reservoir IDs [-]</span>
<span class="sd">        * **wflow_reservoirlocs** map: reservoir IDs at outlet locations [-]</span>
<span class="sd">        * **ResSimpleArea** map: reservoir area [m2]</span>
<span class="sd">        * **ResMaxVolume** map: reservoir max volume [m3]</span>
<span class="sd">        * **ResTargetMinFrac** map: reservoir target min frac [m3/m3]</span>
<span class="sd">        * **ResTargetFullFrac** map: reservoir target full frac [m3/m3]</span>
<span class="sd">        * **ResDemand** map: reservoir demand flow [m3/s]</span>
<span class="sd">        * **ResMaxRelease** map: reservoir max release flow [m3/s]</span>
<span class="sd">        * **reservoirs** geom: polygon with reservoirs and wflow reservoir parameters</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        reservoirs_fn : {&#39;hydro_reservoirs&#39;}</span>
<span class="sd">            Name of data source for reservoir parameters, see data/data_sources.yml.</span>

<span class="sd">            * Required variables with hydroengine: [&#39;waterbody_id&#39;, &#39;Hylak_id&#39;, &#39;Vol_avg&#39;, &#39;Depth_avg&#39;, &#39;Dis_avg&#39;, &#39;Dam_height&#39;]</span>

<span class="sd">            * Required variables without hydroengine: [&#39;waterbody_id&#39;, &#39;Area_avg&#39;, &#39;Vol_avg&#39;, &#39;Depth_avg&#39;, &#39;Dis_avg&#39;, &#39;Capacity_max&#39;, &#39;Capacity_norm&#39;, &#39;Capacity_min&#39;, &#39;Dam_height&#39;]</span>
<span class="sd">        min_area : float, optional</span>
<span class="sd">            Minimum reservoir area threshold [km2], by default 1.0 km2.</span>
<span class="sd">        priority_jrc : boolean, optional</span>
<span class="sd">            If True, use JRC water occurence (Pekel,2016) data from GEE to calculate</span>
<span class="sd">            and overwrite the reservoir volume/areas of the data source.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># rename to wflow naming convention</span>
        <span class="n">tbls</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;resarea&quot;</span><span class="p">:</span> <span class="s2">&quot;ResSimpleArea&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resdemand&quot;</span><span class="p">:</span> <span class="s2">&quot;ResDemand&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resfullfrac&quot;</span><span class="p">:</span> <span class="s2">&quot;ResTargetFullFrac&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resminfrac&quot;</span><span class="p">:</span> <span class="s2">&quot;ResTargetMinFrac&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resmaxrelease&quot;</span><span class="p">:</span> <span class="s2">&quot;ResMaxRelease&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resmaxvolume&quot;</span><span class="p">:</span> <span class="s2">&quot;ResMaxVolume&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resid&quot;</span><span class="p">:</span> <span class="s2">&quot;expr1&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">res_toml</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;model.reservoirs&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;state.lateral.river.reservoir.volume&quot;</span><span class="p">:</span> <span class="s2">&quot;volume_reservoir&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># path or filename. get_geodataframe</span>
        <span class="k">if</span> <span class="n">reservoirs_fn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;hydro_reservoirs&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid source &#39;</span><span class="si">{</span><span class="n">reservoirs_fn</span><span class="si">}</span><span class="s2">&#39;, skipping setup_reservoirs.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="n">gdf_org</span><span class="p">,</span> <span class="n">ds_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_waterbodies</span><span class="p">(</span><span class="n">reservoirs_fn</span><span class="p">,</span> <span class="s2">&quot;reservoir&quot;</span><span class="p">,</span> <span class="n">min_area</span><span class="p">)</span>
        <span class="c1"># TODO: check if there are missing values in the above columns of the parameters tbls =</span>
        <span class="c1"># if everything is present, skip calculate reservoirattrs() and directly make the maps</span>
        <span class="k">if</span> <span class="n">ds_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rmdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ds_res</span><span class="o">.</span><span class="n">data_vars</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_staticmaps</span><span class="p">(</span><span class="n">ds_res</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rmdict</span><span class="p">))</span>
            <span class="c1"># add attributes</span>
            <span class="n">intbl_reservoirs</span><span class="p">,</span> <span class="n">reservoir_accuracy</span> <span class="o">=</span> <span class="n">reservoirattrs</span><span class="p">(</span>
                <span class="n">gdf</span><span class="o">=</span><span class="n">gdf_org</span><span class="p">,</span>
                <span class="n">priorityJRC</span><span class="o">=</span><span class="n">priority_jrc</span><span class="p">,</span>
                <span class="n">usehe</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;usehe&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1">#</span>
            <span class="n">intbl_reservoirs</span> <span class="o">=</span> <span class="n">intbl_reservoirs</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">tbls</span><span class="p">)</span>

            <span class="c1"># create a geodf with id of reservoir and gemoetry at outflow location</span>
            <span class="n">gdf_org_points</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
                <span class="n">gdf_org</span><span class="p">[</span><span class="s2">&quot;waterbody_id&quot;</span><span class="p">],</span>
                <span class="n">geometry</span><span class="o">=</span><span class="n">gpd</span><span class="o">.</span><span class="n">points_from_xy</span><span class="p">(</span><span class="n">gdf_org</span><span class="o">.</span><span class="n">xout</span><span class="p">,</span> <span class="n">gdf_org</span><span class="o">.</span><span class="n">yout</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">intbl_reservoirs</span> <span class="o">=</span> <span class="n">intbl_reservoirs</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;expr1&quot;</span><span class="p">:</span> <span class="s2">&quot;waterbody_id&quot;</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="n">gdf_org_points</span> <span class="o">=</span> <span class="n">gdf_org_points</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">intbl_reservoirs</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;waterbody_id&quot;</span>
            <span class="p">)</span>  <span class="c1"># merge</span>
            <span class="c1"># add parameter attributes to polygone gdf:</span>
            <span class="n">gdf_org</span> <span class="o">=</span> <span class="n">gdf_org</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">intbl_reservoirs</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;waterbody_id&quot;</span><span class="p">)</span>

            <span class="c1"># write reservoirs with param values to staticgeoms</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_staticgeoms</span><span class="p">(</span><span class="n">gdf_org</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;reservoirs&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">gdf_org_points</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
                <span class="n">da_res</span> <span class="o">=</span> <span class="n">ds_res</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span>
                    <span class="n">gdf_org_points</span><span class="p">,</span> <span class="n">col_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=-</span><span class="mi">999</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_staticmaps</span><span class="p">(</span><span class="n">da_res</span><span class="p">)</span>

            <span class="c1"># Save accuracy information on reservoir parameters</span>
            <span class="n">reservoir_accuracy</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;reservoir_accuracy.csv&quot;</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">res_toml</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">res_toml</span><span class="p">[</span><span class="n">option</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">_setup_waterbodies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">waterbodies_fn</span><span class="p">,</span> <span class="n">wb_type</span><span class="p">,</span> <span class="n">min_area</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method with the common workflow of setup_lakes and setup_reservoir.</span>
<span class="sd">        See specific methods for more info about the arguments.&quot;&quot;&quot;</span>
        <span class="c1"># retrieve data for basin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing </span><span class="si">{</span><span class="n">wb_type</span><span class="si">}</span><span class="s2"> maps.&quot;</span><span class="p">)</span>
        <span class="n">gdf_org</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_geodataframe</span><span class="p">(</span>
            <span class="n">waterbodies_fn</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;contains&quot;</span>
        <span class="p">)</span>
        <span class="c1"># skip small size waterbodies</span>
        <span class="k">if</span> <span class="s2">&quot;Area_avg&quot;</span> <span class="ow">in</span> <span class="n">gdf_org</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">gdf_org</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">min_area_m2</span> <span class="o">=</span> <span class="n">min_area</span> <span class="o">*</span> <span class="mf">1e6</span>
            <span class="n">gdf_org</span> <span class="o">=</span> <span class="n">gdf_org</span><span class="p">[</span><span class="n">gdf_org</span><span class="o">.</span><span class="n">Area_avg</span> <span class="o">&gt;=</span> <span class="n">min_area_m2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">wb_type</span><span class="si">}</span><span class="s2">&#39;s database has no area attribute. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;All </span><span class="si">{</span><span class="n">wb_type</span><span class="si">}</span><span class="s2">s will be considered.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># get waterbodies maps and parameters</span>
        <span class="n">nb_wb</span> <span class="o">=</span> <span class="n">gdf_org</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">size</span>
        <span class="n">ds_waterbody</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">nb_wb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nb_wb</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">wb_type</span><span class="si">}</span><span class="s2">(s) of sufficient size found within region.&quot;</span>
            <span class="p">)</span>
            <span class="c1"># add waterbody maps</span>
            <span class="n">uparea_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;uparea&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">uparea_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Upstream area map for </span><span class="si">{</span><span class="n">wb_type</span><span class="si">}</span><span class="s2"> outlet setup not found. &quot;</span>
                    <span class="s2">&quot;Database coordinates used instead&quot;</span>
                <span class="p">)</span>
                <span class="n">uparea_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ds_waterbody</span><span class="p">,</span> <span class="n">gdf_wateroutlet</span> <span class="o">=</span> <span class="n">waterbodymaps</span><span class="p">(</span>
                <span class="n">gdf</span><span class="o">=</span><span class="n">gdf_org</span><span class="p">,</span>
                <span class="n">ds_like</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">,</span>
                <span class="n">wb_type</span><span class="o">=</span><span class="n">wb_type</span><span class="p">,</span>
                <span class="n">uparea_name</span><span class="o">=</span><span class="n">uparea_name</span><span class="p">,</span>
                <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># update xout and yout in gdf_org from gdf_wateroutlet:</span>
            <span class="k">if</span> <span class="s2">&quot;xout&quot;</span> <span class="ow">in</span> <span class="n">gdf_org</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;yout&quot;</span> <span class="ow">in</span> <span class="n">gdf_org</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">gdf_org</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;xout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf_wateroutlet</span><span class="p">[</span><span class="s2">&quot;xout&quot;</span><span class="p">]</span>
                <span class="n">gdf_org</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;yout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf_wateroutlet</span><span class="p">[</span><span class="s2">&quot;yout&quot;</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No </span><span class="si">{</span><span class="n">wb_type</span><span class="si">}</span><span class="s2">s of sufficient size found within region! &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">wb_type</span><span class="si">}</span><span class="s2"> procedures!&quot;</span>
            <span class="p">)</span>

        <span class="c1"># rasterize points polygons in raster.rasterize -- you need staticmaps to nkow the grid</span>
        <span class="k">return</span> <span class="n">gdf_org</span><span class="p">,</span> <span class="n">ds_waterbody</span>

<div class="viewcode-block" id="WflowModel.setup_soilmaps"><a class="viewcode-back" href="../../generated/hydromt_wflow.wflow.WflowModel.setup_soilmaps.html#hydromt_wflow.wflow.WflowModel.setup_soilmaps">[docs]</a>    <span class="k">def</span> <span class="nf">setup_soilmaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soil_fn</span><span class="o">=</span><span class="s2">&quot;soilgrids&quot;</span><span class="p">,</span> <span class="n">ptf_ksatver</span><span class="o">=</span><span class="s2">&quot;brakensiek&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This component derives several (layered) soil parameters based on a database with</span>
<span class="sd">        physical soil properties using available point-scale (pedo)transfer functions (PTFs)</span>
<span class="sd">        from literature with upscaling rules to ensure flux matching across scales.</span>

<span class="sd">        Currently, supported ``soil_fn`` is &quot;soilgrids&quot; and &quot;soilgrids_2020&quot;.</span>
<span class="sd">        ``ptf_ksatver`` (PTF for the vertical hydraulic conductivity) options are &quot;brakensiek&quot; and &quot;cosby&quot;.</span>
<span class="sd">        &quot;soilgrids&quot; provides data at 7 specific depths, while &quot;soilgrids_2020&quot; provides data averaged over 6 depth intervals.</span>
<span class="sd">        This leads to small changes in the workflow: (1) M parameter uses midpoint depths in soilgrids_2020 versus specific depths in soilgrids,</span>
<span class="sd">        (2) weighted average of soil properties over soil thickness is done with the trapezoidal rule in soilgrids versus simple block weighted average in soilgrids_2020,</span>
<span class="sd">        (3) the c parameter is computed as weighted average over wflow_sbm soil layers in soilgrids_2020 versus at specific depths for soilgrids.</span>

<span class="sd">        The following maps are added to staticmaps:</span>

<span class="sd">        * **thetaS** map: average saturated soil water content [m3/m3]</span>
<span class="sd">        * **thetaR** map: average residual water content [m3/m3]</span>
<span class="sd">        * **KsatVer** map: vertical saturated hydraulic conductivity at soil surface [mm/day]</span>
<span class="sd">        * **SoilThickness** map: soil thickness [mm]</span>
<span class="sd">        * **SoilMinThickness** map: minimum soil thickness [mm] (equal to SoilThickness)</span>
<span class="sd">        * **M** map: model parameter [mm] that controls exponential decline of KsatVer with soil depth</span>
<span class="sd">            (fitted with curve_fit (scipy.optimize)), bounds of M are checked</span>
<span class="sd">        * **M_** map: model parameter [mm] that controls exponential decline of KsatVer with soil depth</span>
<span class="sd">            (fitted with numpy linalg regression), bounds of M_ are checked</span>
<span class="sd">        * **M_original** map: M without checking bounds</span>
<span class="sd">        * **M_original_** map: M_ without checking bounds</span>
<span class="sd">        * **f** map: scaling parameter controlling the decline of KsatVer [mm-1] (fitted with curve_fit (scipy.optimize)), bounds are checked</span>
<span class="sd">        * **f_** map: scaling parameter controlling the decline of KsatVer [mm-1] (fitted with numpy linalg regression), bounds are checked</span>
<span class="sd">        * **c_0** map: Brooks Corey coefficient [-] based on pore size distribution index at</span>
<span class="sd">            depth of 1st soil layer (100 mm) wflow_sbm</span>
<span class="sd">        * **c_1** map: idem c_0 at depth 2nd soil layer (400 mm) wflow_sbm</span>
<span class="sd">        * **c_2** map: idem c_0 at depth 3rd soil layer (1200 mm) wflow_sbm</span>
<span class="sd">        * **c_3** map: idem c_0 at depth 4th soil layer (&gt; 1200 mm) wflow_sbm</span>
<span class="sd">        * **KsatVer_[z]cm** map: KsatVer [mm/day] at soil depths [z] of SoilGrids data [0.0, 5.0, 15.0, 30.0, 60.0, 100.0, 200.0]</span>
<span class="sd">        * **wflow_soil** map: soil texture based on USDA soil texture triangle (mapping: [1:Clay, 2:Silty Clay, 3:Silty Clay-Loam, 4:Sandy Clay, 5:Sandy Clay-Loam, 6:Clay-Loam, 7:Silt, 8:Silt-Loam, 9:Loam, 10:Sand, 11: Loamy Sand, 12:Sandy Loam])</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        soil_fn : {&#39;soilgrids&#39;, &#39;soilgrids_2020&#39;}</span>
<span class="sd">            Name of data source for soil parameter maps, see data/data_sources.yml. Should contain info for the</span>
<span class="sd">            7 soil depths of soilgrids (or 6 depths intervals for soilgrids_2020).</span>
<span class="sd">            * Required variables: [&#39;bd_sl*&#39;, &#39;clyppt_sl*&#39;, &#39;sltppt_sl*&#39;, &#39;oc_sl*&#39;, &#39;ph_sl*&#39;, &#39;sndppt_sl*&#39;, &#39;soilthickness&#39;, &#39;tax_usda&#39;]</span>
<span class="sd">        ptf_ksatver : {&#39;brakensiek&#39;, &#39;cosby&#39;}</span>
<span class="sd">            Pedotransfer function (PTF) to use for calculation KsatVer (vertical saturated</span>
<span class="sd">            hydraulic conductivity [mm/day]). By default &#39;brakensiek&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing soil parameter maps.&quot;</span><span class="p">)</span>
        <span class="c1"># TODO add variables list with required variable names</span>
        <span class="n">dsin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_rasterdataset</span><span class="p">(</span><span class="n">soil_fn</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">dsout</span> <span class="o">=</span> <span class="n">soilgrids</span><span class="p">(</span>
            <span class="n">dsin</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">,</span>
            <span class="n">ptf_ksatver</span><span class="p">,</span>
            <span class="n">soil_fn</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_staticmaps</span><span class="p">(</span><span class="n">dsout</span><span class="p">)</span></div>

<div class="viewcode-block" id="WflowModel.setup_glaciers"><a class="viewcode-back" href="../../generated/hydromt_wflow.wflow.WflowModel.setup_glaciers.html#hydromt_wflow.wflow.WflowModel.setup_glaciers">[docs]</a>    <span class="k">def</span> <span class="nf">setup_glaciers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glaciers_fn</span><span class="o">=</span><span class="s2">&quot;rgi&quot;</span><span class="p">,</span> <span class="n">min_area</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This component generates maps of glacier areas, area fraction and volume fraction,</span>
<span class="sd">        as well as tables with temperature thresohld, melting factor and snow-to-ice</span>
<span class="sd">        convertion fraction.</span>

<span class="sd">        The data is generated from features with ``min_area`` [km2]</span>
<span class="sd">        from a database with glacier geometry, IDs and metadata.</span>
<span class="sd">        Currently, &quot;rgi&quot; (Randolph Glacier Inventory) is the only supported ``glaciers_fn``</span>
<span class="sd">        data source and we use a default minimum area of 1 km2.</span>

<span class="sd">        Adds model layers:</span>

<span class="sd">        * **wflow_glacierareas** map: glacier IDs [-]</span>
<span class="sd">        * **wflow_glacierfrac** map: area fraction of glacier per cell [-]</span>
<span class="sd">        * **wflow_glacierstore** map: storage (volume) of glacier per cell [mm]</span>
<span class="sd">        * **G_TT** map: temperature threshold for glacier melt/buildup [Â°C]</span>
<span class="sd">        * **G_Cfmax** map: glacier melting factor [mm/Â°C*day]</span>
<span class="sd">        * **G_SIfrac** map: fraction of snowpack on top of glacier converted to ice, added to glacierstore [-]</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        glaciers_fn : {&#39;rgi&#39;}</span>
<span class="sd">            Name of data source for glaciers, see data/data_sources.yml.</span>

<span class="sd">            * Required variables: [&#39;simple_id&#39;]</span>
<span class="sd">        min_area : float, optional</span>
<span class="sd">            Minimum glacier area threshold [km2], by default 0 (all included)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">glac_toml</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;glacier&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="c1"># retrieve data for basin</span>
        <span class="k">if</span> <span class="n">glaciers_fn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;rgi&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">glaciers_fn</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Invalid source &#39;</span><span class="si">{</span><span class="n">glaciers_fn</span><span class="si">}</span><span class="s2">&#39;, skipping setup_glaciers.&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing glacier maps.&quot;</span><span class="p">)</span>
        <span class="n">gdf_org</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_geodataframe</span><span class="p">(</span>
            <span class="n">glaciers_fn</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;contains&quot;</span>
        <span class="p">)</span>
        <span class="c1"># skip small size glacier</span>
        <span class="k">if</span> <span class="s2">&quot;AREA&quot;</span> <span class="ow">in</span> <span class="n">gdf_org</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">gdf_org</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gdf_org</span> <span class="o">=</span> <span class="n">gdf_org</span><span class="p">[</span><span class="n">gdf_org</span><span class="p">[</span><span class="s2">&quot;AREA&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_area</span><span class="p">]</span>
        <span class="c1"># get glacier maps and parameters</span>
        <span class="n">nb_glac</span> <span class="o">=</span> <span class="n">gdf_org</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">size</span>
        <span class="n">ds_glac</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">nb_glac</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nb_glac</span><span class="si">}</span><span class="s2"> glaciers of sufficient size found within region.&quot;</span>
            <span class="p">)</span>
            <span class="c1"># add glacier maps</span>
            <span class="n">ds_glac</span> <span class="o">=</span> <span class="n">glaciermaps</span><span class="p">(</span>
                <span class="n">gdf</span><span class="o">=</span><span class="n">gdf_org</span><span class="p">,</span>
                <span class="n">ds_like</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">,</span>
                <span class="n">id_column</span><span class="o">=</span><span class="s2">&quot;simple_id&quot;</span><span class="p">,</span>  <span class="c1"># TODO set id as index in data adapter</span>
                <span class="n">elevtn_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;elevtn&quot;</span><span class="p">],</span>
                <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No glaciers of sufficient size found within region!&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Skipping glacier procedures!&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">ds_glac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rmdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ds_glac</span><span class="o">.</span><span class="n">data_vars</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_staticmaps</span><span class="p">(</span><span class="n">ds_glac</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rmdict</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">glac_toml</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">glac_toml</span><span class="p">[</span><span class="n">option</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">set_staticgeoms</span><span class="p">(</span><span class="n">gdf_org</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;glaciers&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="WflowModel.setup_constant_pars"><a class="viewcode-back" href="../../generated/hydromt_wflow.wflow.WflowModel.setup_constant_pars.html#hydromt_wflow.wflow.WflowModel.setup_constant_pars">[docs]</a>    <span class="k">def</span> <span class="nf">setup_constant_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup constant parameter maps.</span>

<span class="sd">        Adds model layer:</span>

<span class="sd">        * **param_name** map: constant parameter map.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name = value : list of opt</span>
<span class="sd">            Will add name in staticmaps with value for every active cell.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">nodatafloat</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
            <span class="n">da_param</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;basins&quot;</span><span class="p">]],</span> <span class="n">value</span><span class="p">,</span> <span class="n">nodatafloat</span>
            <span class="p">)</span>
            <span class="n">da_param</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">set_nodata</span><span class="p">(</span><span class="n">nodatafloat</span><span class="p">)</span>

            <span class="n">da_param</span> <span class="o">=</span> <span class="n">da_param</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_staticmaps</span><span class="p">(</span><span class="n">da_param</span><span class="p">)</span></div>

<div class="viewcode-block" id="WflowModel.setup_precip_forcing"><a class="viewcode-back" href="../../generated/hydromt_wflow.wflow.WflowModel.setup_precip_forcing.html#hydromt_wflow.wflow.WflowModel.setup_precip_forcing">[docs]</a>    <span class="k">def</span> <span class="nf">setup_precip_forcing</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">precip_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;era5&quot;</span><span class="p">,</span>
        <span class="n">precip_clim_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">chunksize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Setup gridded precipitation forcing at model resolution.</span>

<span class="sd">        Adds model layer:</span>

<span class="sd">        * **precip**: precipitation [mm]</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        precip_fn : str, default era5</span>
<span class="sd">            Precipitation data source, see data/forcing_sources.yml.</span>

<span class="sd">            * Required variable: [&#39;precip&#39;]</span>
<span class="sd">        precip_clim_fn : str, default None</span>
<span class="sd">            High resolution climatology precipitation data source to correct precipitation,</span>
<span class="sd">            see data/forcing_sources.yml.</span>

<span class="sd">            * Required variable: [&#39;precip&#39;]</span>
<span class="sd">        chunksize: int, optional</span>
<span class="sd">            Chunksize on time dimension for processing data (not for saving to disk!).</span>
<span class="sd">            If None the data chunksize is used, this can however be optimized for</span>
<span class="sd">            large/small catchments. By default None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">precip_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">starttime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;starttime&quot;</span><span class="p">)</span>
        <span class="n">endtime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;endtime&quot;</span><span class="p">)</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;timestepsecs&quot;</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;basins&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="n">precip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_rasterdataset</span><span class="p">(</span>
            <span class="n">precip_fn</span><span class="p">,</span>
            <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span>
            <span class="n">buffer</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">time_tuple</span><span class="o">=</span><span class="p">(</span><span class="n">starttime</span><span class="p">,</span> <span class="n">endtime</span><span class="p">),</span>
            <span class="n">variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;precip&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">chunksize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">precip</span> <span class="o">=</span> <span class="n">precip</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">chunksize</span><span class="p">})</span>

        <span class="n">clim</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">precip_clim_fn</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_rasterdataset</span><span class="p">(</span>
                <span class="n">precip_clim_fn</span><span class="p">,</span>
                <span class="n">geom</span><span class="o">=</span><span class="n">precip</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">box</span><span class="p">,</span>
                <span class="n">buffer</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;precip&quot;</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="n">precip_out</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">forcing</span><span class="o">.</span><span class="n">precip</span><span class="p">(</span>
            <span class="n">precip</span><span class="o">=</span><span class="n">precip</span><span class="p">,</span>
            <span class="n">da_like</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;elevtn&quot;</span><span class="p">]],</span>
            <span class="n">clim</span><span class="o">=</span><span class="n">clim</span><span class="p">,</span>
            <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span>
            <span class="n">resample_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">),</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Update meta attributes (used for default output filename later)</span>
        <span class="n">precip_out</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;precip_fn&quot;</span><span class="p">:</span> <span class="n">precip_fn</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">precip_clim_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">precip_out</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;precip_clim_fn&quot;</span><span class="p">:</span> <span class="n">precip_clim_fn</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_forcing</span><span class="p">(</span><span class="n">precip_out</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;precip&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="WflowModel.setup_temp_pet_forcing"><a class="viewcode-back" href="../../generated/hydromt_wflow.wflow.WflowModel.setup_temp_pet_forcing.html#hydromt_wflow.wflow.WflowModel.setup_temp_pet_forcing">[docs]</a>    <span class="k">def</span> <span class="nf">setup_temp_pet_forcing</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">temp_pet_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;era5&quot;</span><span class="p">,</span>
        <span class="n">pet_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;debruin&quot;</span><span class="p">,</span>
        <span class="n">press_correction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">temp_correction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">dem_forcing_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;era5_orography&quot;</span><span class="p">,</span>
        <span class="n">skip_pet</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">chunksize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Setup gridded reference evapotranspiration forcing at model resolution.</span>

<span class="sd">        Adds model layer:</span>

<span class="sd">        * **pet**: reference evapotranspiration [mm]</span>
<span class="sd">        * **temp**: temperature [Â°C]</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        temp_pet_fn : str, optional</span>
<span class="sd">            Name or path of data source with variables to calculate temperature and reference evapotranspiration,</span>
<span class="sd">            see data/forcing_sources.yml, by default &#39;era5&#39;.</span>

<span class="sd">            * Required variable for temperature: [&#39;temp&#39;]</span>

<span class="sd">            * Required variables for De Bruin reference evapotranspiration: [&#39;temp&#39;, &#39;press_msl&#39;, &#39;kin&#39;, &#39;kout&#39;]</span>

<span class="sd">            * Required variables for Makkink reference evapotranspiration: [&#39;temp&#39;, &#39;press_msl&#39;, &#39;kin&#39;]</span>
<span class="sd">        pet_method : {&#39;debruin&#39;, &#39;makkink&#39;}, optional</span>
<span class="sd">            Reference evapotranspiration method, by default &#39;debruin&#39;.</span>
<span class="sd">        press_correction, temp_correction : bool, optional</span>
<span class="sd">             If True pressure, temperature are corrected using elevation lapse rate,</span>
<span class="sd">             by default False.</span>
<span class="sd">        dem_forcing_fn : str, default None</span>
<span class="sd">             Elevation data source with coverage of entire meteorological forcing domain.</span>
<span class="sd">             If temp_correction is True and dem_forcing_fn is provided this is used in</span>
<span class="sd">             combination with elevation at model resolution to correct the temperature.</span>
<span class="sd">        skip_pet : bool, optional</span>
<span class="sd">            If True caculate temp only.</span>
<span class="sd">        chunksize: int, optional</span>
<span class="sd">            Chunksize on time dimension for processing data (not for saving to disk!).</span>
<span class="sd">            If None the data chunksize is used, this can however be optimized for</span>
<span class="sd">            large/small catchments. By default None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">temp_pet_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">starttime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;starttime&quot;</span><span class="p">)</span>
        <span class="n">endtime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;endtime&quot;</span><span class="p">)</span>
        <span class="n">timestep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;timestepsecs&quot;</span><span class="p">)</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;basins&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;temp&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_pet</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pet_method</span> <span class="o">==</span> <span class="s2">&quot;debruin&quot;</span><span class="p">:</span>
                <span class="n">variables</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;press_msl&quot;</span><span class="p">,</span> <span class="s2">&quot;kin&quot;</span><span class="p">,</span> <span class="s2">&quot;kout&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">pet_method</span> <span class="o">==</span> <span class="s2">&quot;makkink&quot;</span><span class="p">:</span>
                <span class="n">variables</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;press_msl&quot;</span><span class="p">,</span> <span class="s2">&quot;kin&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;debruin&quot;</span><span class="p">,</span> <span class="s2">&quot;makking&quot;</span><span class="p">]</span>
                <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unkwown pet method </span><span class="si">{</span><span class="n">pet_method</span><span class="si">}</span><span class="s2">, select from </span><span class="si">{</span><span class="n">methods</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_rasterdataset</span><span class="p">(</span>
            <span class="n">temp_pet_fn</span><span class="p">,</span>
            <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span>
            <span class="n">buffer</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">time_tuple</span><span class="o">=</span><span class="p">(</span><span class="n">starttime</span><span class="p">,</span> <span class="n">endtime</span><span class="p">),</span>
            <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span>
            <span class="n">single_var_as_array</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># always return dataset</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">chunksize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">chunksize</span><span class="p">})</span>

        <span class="n">dem_forcing</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">dem_forcing_fn</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dem_forcing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_rasterdataset</span><span class="p">(</span>
                <span class="n">dem_forcing_fn</span><span class="p">,</span>
                <span class="n">geom</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">box</span><span class="p">,</span>  <span class="c1"># clip dem with forcing bbox for full coverage</span>
                <span class="n">buffer</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;elevtn&quot;</span><span class="p">],</span>
            <span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="n">temp_in</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">forcing</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span>
            <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;temp&quot;</span><span class="p">],</span>
            <span class="n">dem_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;elevtn&quot;</span><span class="p">]],</span>
            <span class="n">dem_forcing</span><span class="o">=</span><span class="n">dem_forcing</span><span class="p">,</span>
            <span class="n">lapse_correction</span><span class="o">=</span><span class="n">temp_correction</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
            <span class="n">freq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># resample time after pet workflow</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_pet</span><span class="p">:</span>
            <span class="n">pet_out</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">forcing</span><span class="o">.</span><span class="n">pet</span><span class="p">(</span>
                <span class="n">ds</span><span class="p">[</span><span class="n">variables</span><span class="p">[</span><span class="mi">1</span><span class="p">:]],</span>
                <span class="n">dem_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;elevtn&quot;</span><span class="p">]],</span>
                <span class="n">temp</span><span class="o">=</span><span class="n">temp_in</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">pet_method</span><span class="p">,</span>
                <span class="n">press_correction</span><span class="o">=</span><span class="n">press_correction</span><span class="p">,</span>
                <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span>
                <span class="n">resample_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">),</span>
                <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Update meta attributes with setup opt</span>
            <span class="n">opt_attr</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;pet_fn&quot;</span><span class="p">:</span> <span class="n">temp_pet_fn</span><span class="p">,</span>
                <span class="s2">&quot;pet_method&quot;</span><span class="p">:</span> <span class="n">pet_method</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">pet_out</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">opt_attr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_forcing</span><span class="p">(</span><span class="n">pet_out</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;pet&quot;</span><span class="p">)</span>

        <span class="c1"># resample temp after pet workflow</span>
        <span class="n">temp_out</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">forcing</span><span class="o">.</span><span class="n">resample_time</span><span class="p">(</span>
            <span class="n">temp_in</span><span class="p">,</span>
            <span class="n">freq</span><span class="p">,</span>
            <span class="n">upsampling</span><span class="o">=</span><span class="s2">&quot;bfill&quot;</span><span class="p">,</span>  <span class="c1"># we assume right labeled original data</span>
            <span class="n">downsampling</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
            <span class="n">closed</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
            <span class="n">conserve_mass</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Update meta attributes with setup opt (used for default naming later)</span>
        <span class="n">opt_attr</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;temp_fn&quot;</span><span class="p">:</span> <span class="n">temp_pet_fn</span><span class="p">,</span>
            <span class="s2">&quot;temp_correction&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">temp_correction</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">temp_out</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">opt_attr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_forcing</span><span class="p">(</span><span class="n">temp_out</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;temp&quot;</span><span class="p">)</span></div>

    <span class="c1"># I/O</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to read the complete model schematization and configuration from file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_staticmaps</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_intbl</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_staticgeoms</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_forcing</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Model read&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to write the complete model schematization and configuration to file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Write model data to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># if in r, r+ mode, only write updated components</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot write in read-only mode&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>  <span class="c1"># try to read default if not yet set</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_config</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staticmaps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_staticmaps</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staticgeoms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_staticgeoms</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forcing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_forcing</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">read_staticmaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read staticmaps&quot;&quot;&quot;</span>
        <span class="n">fn_default</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;staticmaps.nc&quot;</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;input.path_static&quot;</span><span class="p">,</span> <span class="n">abs_path</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="n">fn_default</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">:</span>
            <span class="c1"># start fresh in read-only mode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_staticmaps</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">isfile</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Read staticmaps from </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># FIXME: we need a smarter (lazy) solution for big models which also</span>
            <span class="c1"># works when overwriting / apending data in thet same source!</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">mask_and_scale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_staticmaps</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;staticmaps&quot;</span><span class="p">,</span> <span class="s2">&quot;*.map&quot;</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_staticmaps_pcr</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">write_staticmaps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write staticmaps&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Model opened in read-only mode&quot;</span><span class="p">)</span>
        <span class="n">ds_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span>
        <span class="n">fn_default</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;staticmaps.nc&quot;</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;input.path_static&quot;</span><span class="p">,</span> <span class="n">abs_path</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="n">fn_default</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Write staticmaps to </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">ds_out</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;basins&quot;</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ds_out</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
            <span class="n">ds_out</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_out</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">ds_out</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">nodata</span><span class="p">)</span>
        <span class="n">ds_out</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="c1"># self.write_staticmaps_pcr()</span>

    <span class="k">def</span> <span class="nf">read_staticmaps_pcr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="mi">4326</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read and staticmaps at &lt;root/staticmaps&gt; and parse to xarray&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span> <span class="ow">and</span> <span class="s2">&quot;chunks&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">})</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;staticmaps&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;*.map&quot;</span><span class="p">)</span>
        <span class="n">fns</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No staticmaps found at </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_staticmaps</span> <span class="o">=</span> <span class="n">open_mfraster</span><span class="p">(</span><span class="n">fns</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">vars</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">PCR_VS_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;scalar&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;bool&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_staticmaps</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staticmaps</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="c1"># a nodata value is required when writing</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_staticmaps</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">set_nodata</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;staticmaps&quot;</span><span class="p">,</span> <span class="s2">&quot;clim&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;LAI*&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">da_lai</span> <span class="o">=</span> <span class="n">open_mfraster</span><span class="p">(</span>
                <span class="n">path</span><span class="p">,</span> <span class="n">concat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">concat_dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_staticmaps</span><span class="p">(</span><span class="n">da_lai</span><span class="p">,</span> <span class="s2">&quot;LAI&quot;</span><span class="p">)</span>

        <span class="c1"># reorganize c_0 etc maps</span>
        <span class="n">da_c</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">list_c</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staticmaps</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;c_&quot;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_c</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">list_c</span><span class="p">):</span>
                <span class="n">da_c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_staticmaps</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;c_</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
            <span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="n">da_c</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list_c</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;layer&quot;</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_staticmaps</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">crs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">crs</span> <span class="o">=</span> <span class="mi">4326</span>  <span class="c1"># default to 4326</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_crs</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_staticmaps_pcr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write staticmaps at &lt;root/staticmaps&gt; in PCRaster maps format.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Model opened in read-only mode&quot;</span><span class="p">)</span>
        <span class="n">ds_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span>
        <span class="k">if</span> <span class="s2">&quot;LAI&quot;</span> <span class="ow">in</span> <span class="n">ds_out</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
            <span class="n">ds_out</span> <span class="o">=</span> <span class="n">ds_out</span><span class="o">.</span><span class="n">rename_vars</span><span class="p">({</span><span class="s2">&quot;LAI&quot;</span><span class="p">:</span> <span class="s2">&quot;clim/LAI&quot;</span><span class="p">})</span>
        <span class="k">if</span> <span class="s2">&quot;c&quot;</span> <span class="ow">in</span> <span class="n">ds_out</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">ds_out</span><span class="p">[</span><span class="s2">&quot;layer&quot;</span><span class="p">]:</span>
                <span class="n">ds_out</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;c_</span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_out</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">)</span>
                <span class="n">ds_out</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;c_</span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">set_nodata</span><span class="p">(</span>
                    <span class="n">ds_out</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">nodata</span>
                <span class="p">)</span>
            <span class="n">ds_out</span> <span class="o">=</span> <span class="n">ds_out</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;layer&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing (updated) staticmap files.&quot;</span><span class="p">)</span>
        <span class="c1"># add datatypes for maps with same basenames, e.g. wflow_gauges_grdc</span>
        <span class="n">pcr_vs_map</span> <span class="o">=</span> <span class="n">PCR_VS_MAP</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">ds_out</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">vars</span><span class="p">:</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">var_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># clip _&lt;postfix&gt;</span>
            <span class="k">if</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">PCR_VS_MAP</span><span class="p">:</span>
                <span class="n">pcr_vs_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">var_name</span><span class="p">:</span> <span class="n">PCR_VS_MAP</span><span class="p">[</span><span class="n">base_name</span><span class="p">]})</span>
        <span class="n">ds_out</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">to_mapstack</span><span class="p">(</span>
            <span class="n">root</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;staticmaps&quot;</span><span class="p">),</span>
            <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;PCRaster&quot;</span><span class="p">,</span>
            <span class="n">pcr_vs_map</span><span class="o">=</span><span class="n">pcr_vs_map</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_staticgeoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read and staticgeoms at &lt;root/staticgeoms&gt; and parse to geopandas&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_staticgeoms</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># fresh start in read-only mode</span>
        <span class="n">fns</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;staticgeoms&quot;</span><span class="p">,</span> <span class="s2">&quot;*.geojson&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading model staticgeom files.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">fns</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;region&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_staticgeoms</span><span class="p">(</span><span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">fn</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_staticgeoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write staticmaps at &lt;root/staticgeoms&gt; in model ready format&quot;&quot;&quot;</span>
        <span class="c1"># to write use self.staticgeoms[var].to_file()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Model opened in read-only mode&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticgeoms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing model staticgeom to file.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">gdf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticgeoms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">fn_out</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;staticgeoms&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.geojson&quot;</span><span class="p">)</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">fn_out</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_forcing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read forcing&quot;&quot;&quot;</span>
        <span class="n">fn_default</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;inmaps.nc&quot;</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;input.path_forcing&quot;</span><span class="p">,</span> <span class="n">abs_path</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="n">fn_default</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">:</span>
            <span class="c1"># start fresh in read-only mode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_forcing</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">isfile</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Read forcing from </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">})</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_forcing</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">write_forcing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;write forcing at `fn_out` in model ready format.</span>

<span class="sd">        If no `fn_out` path is provided and path_forcing from the  wflow toml exists,</span>
<span class="sd">        the following default filenames are used:</span>

<span class="sd">            * Default name format (with downscaling): inmaps_sourcePd_sourceTd_methodPET_freq_startyear_endyear.nc</span>
<span class="sd">            * Default name format (no downscaling): inmaps_sourceP_sourceT_methodPET_freq_startyear_endyear.nc</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fn_out: str, Path, optional</span>
<span class="sd">            Path to save output netcdf file; if None the name is read from the wflow</span>
<span class="sd">            toml file.</span>
<span class="sd">        chunksize: int, optional</span>
<span class="sd">            Chunksize on time dimension when saving to disk. By default 1.</span>
<span class="sd">        decimals, int, optional</span>
<span class="sd">            Round the ouput data to the given number of decimals.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Model opened in read-only mode&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Write forcing file&quot;</span><span class="p">)</span>

            <span class="c1"># Get default forcing name from forcing attrs</span>
            <span class="n">yr0</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;starttime&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">year</span>
            <span class="n">yr1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;endtime&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">year</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;timestepsecs&quot;</span><span class="p">)</span>

            <span class="c1"># get output filename</span>
            <span class="k">if</span> <span class="n">fn_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="s2">&quot;input.path_forcing&quot;</span><span class="p">,</span> <span class="n">fn_out</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_config</span><span class="p">()</span>  <span class="c1"># re-write config</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fn_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;input.path_forcing&quot;</span><span class="p">,</span> <span class="n">abs_path</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># get deafult filename if file exists</span>
                <span class="k">if</span> <span class="n">fn_out</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">isfile</span><span class="p">(</span><span class="n">fn_out</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Netcdf forcing file from input.path_forcing in the TOML  &quot;</span>
                        <span class="s2">&quot;already exists, using default name.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">sourceP</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">sourceT</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">methodPET</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">if</span> <span class="s2">&quot;precip&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcing</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcing</span><span class="p">[</span><span class="s2">&quot;precip&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;precip_clim_fn&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="n">Pdown</span> <span class="o">=</span> <span class="s2">&quot;d&quot;</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcing</span><span class="p">[</span><span class="s2">&quot;precip&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;precip_fn&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">sourceP</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">val</span><span class="si">}{</span><span class="n">Pdown</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="s2">&quot;temp&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcing</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcing</span><span class="p">[</span><span class="s2">&quot;temp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;temp_correction&quot;</span><span class="p">,</span> <span class="s2">&quot;False&quot;</span><span class="p">)</span>
                        <span class="n">Tdown</span> <span class="o">=</span> <span class="s2">&quot;d&quot;</span> <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcing</span><span class="p">[</span><span class="s2">&quot;temp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;temp_fn&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">sourceT</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">val</span><span class="si">}{</span><span class="n">Tdown</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="s2">&quot;pet&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcing</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcing</span><span class="p">[</span><span class="s2">&quot;pet&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pet_method&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">methodPET</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">fn_default</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;inmaps</span><span class="si">{</span><span class="n">sourceP</span><span class="si">}{</span><span class="n">sourceT</span><span class="si">}{</span><span class="n">methodPET</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">freq</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">yr0</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">yr1</span><span class="si">}</span><span class="s2">.nc&quot;</span>
                    <span class="p">)</span>
                    <span class="n">fn_default_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">fn_default</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">fn_default_path</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;Netcdf default forcing file already exists, skipping write_forcing. &quot;</span>
                            <span class="s2">&quot;To overwrite netcdf forcing file: change name input.path_forcing &quot;</span>
                            <span class="s2">&quot;in setup_config section of the build inifile.&quot;</span>
                        <span class="p">)</span>
                        <span class="k">return</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="s2">&quot;input.path_forcing&quot;</span><span class="p">,</span> <span class="n">fn_default</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_config</span><span class="p">()</span>  <span class="c1"># re-write config</span>
                        <span class="n">fn_out</span> <span class="o">=</span> <span class="n">fn_default_path</span>

            <span class="c1"># merge, process and write forcing</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forcing</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">decimals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="p">)</span>
            <span class="c1"># write with output chunksizes with single timestep and complete</span>
            <span class="c1"># spatial grid to speed up the reading from wflow.jl</span>
            <span class="c1"># dims are always ordered (time, y, x)</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">_check_dimensions</span><span class="p">()</span>
            <span class="n">chunksizes</span> <span class="o">=</span> <span class="p">(</span><span class="n">chunksize</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">ycoords</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">xcoords</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">v</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zlib&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="s2">&quot;chunksizes&quot;</span><span class="p">:</span> <span class="n">chunksizes</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Process forcing; saving to </span><span class="si">{</span><span class="n">fn_out</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># with compute=False we get a delayed object which is executed when</span>
            <span class="c1"># calling .compute where we can pass more arguments to the dask.compute method</span>
            <span class="n">delayed_obj</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span>
                <span class="n">fn_out</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="n">ProgressBar</span><span class="p">():</span>
                <span class="n">delayed_obj</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># TO profile uncomment lines below to replace lines above</span>
            <span class="c1"># from dask.diagnostics import Profiler, CacheProfiler, ResourceProfiler</span>
            <span class="c1"># import cachey</span>
            <span class="c1"># with Profiler() as prof, CacheProfiler(metric=cachey.nbytes) as cprof, ResourceProfiler() as rprof:</span>
            <span class="c1">#     delayed_obj.compute()</span>
            <span class="c1"># visualize([prof, cprof, rprof], file_path=r&#39;c:\Users\eilan_dk\work\profile2.html&#39;)</span>

    <span class="k">def</span> <span class="nf">read_states</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read states at &lt;root/?/&gt; and parse to dict of xr.DataArray&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">:</span>
            <span class="c1"># start fresh in read-only mode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_states</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># raise NotImplementedError()</span>

    <span class="k">def</span> <span class="nf">write_states</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;write states at &lt;root/?/&gt; in model ready format&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Model opened in read-only mode&quot;</span><span class="p">)</span>
        <span class="c1"># raise NotImplementedError()</span>

    <span class="k">def</span> <span class="nf">read_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read results at &lt;root/?/&gt; and parse to dict of xr.DataArray&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">:</span>
            <span class="c1"># start fresh in read-only mode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># raise NotImplementedError()</span>

    <span class="k">def</span> <span class="nf">write_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;write results at &lt;root/?/&gt; in model ready format&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Model opened in read-only mode&quot;</span><span class="p">)</span>
        <span class="c1"># raise NotImplementedError()</span>

    <span class="k">def</span> <span class="nf">read_intbl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read and intbl files at &lt;root/intbl&gt; and parse to xarray&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_intbl</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># start fresh in read-only mode</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading default intbl files.&quot;</span><span class="p">)</span>
            <span class="n">fns</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">DATADIR</span><span class="p">,</span> <span class="s2">&quot;wflow&quot;</span><span class="p">,</span> <span class="s2">&quot;intbl&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;*.tbl&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading model intbl files.&quot;</span><span class="p">)</span>
            <span class="n">fns</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;intbl&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;*.tbl&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">fns</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">tbl</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">tbl</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;expr</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;value&quot;</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
                <span class="p">]</span>  <span class="c1"># rename columns</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_intbl</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_intbl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write intbl at &lt;root/intbl&gt; in PCRaster table format.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Model opened in read-only mode&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intbl</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing intbl files.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intbl</span><span class="p">:</span>
                <span class="n">fn_out</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;intbl&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.tbl&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">intbl</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fn_out</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_intbl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add intbl &lt;pandas.DataFrame&gt; to model.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;df type not recognized, should be pandas.DataFrame.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intbl</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot overwrite intbl </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> in read-only mode&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overwriting intbl: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_intbl</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_configread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">fdict</span> <span class="o">=</span> <span class="n">toml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fdict</span>

    <span class="k">def</span> <span class="nf">_configwrite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">toml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="c1">## WFLOW specific data and methods</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">intbl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary of pandas.DataFrames representing the wflow intbl files.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intbl</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_intbl</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intbl</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">flwdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the pyflwdir.FlwdirRaster object parsed from the wflow ldd.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flwdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_flwdir</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flwdir</span>

<div class="viewcode-block" id="WflowModel.set_flwdir"><a class="viewcode-back" href="../../generated/hydromt_wflow.wflow.WflowModel.set_flwdir.html#hydromt_wflow.wflow.WflowModel.set_flwdir">[docs]</a>    <span class="k">def</span> <span class="nf">set_flwdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s2">&quot;infer&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse pyflwdir.FlwdirRaster object parsed from the wflow ldd&quot;&quot;&quot;</span>
        <span class="n">flwdir_name</span> <span class="o">=</span> <span class="n">flwdir_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;flwdir&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flwdir</span> <span class="o">=</span> <span class="n">flw</span><span class="o">.</span><span class="n">flwdir_from_da</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">[</span><span class="n">flwdir_name</span><span class="p">],</span>
            <span class="n">ftype</span><span class="o">=</span><span class="n">ftype</span><span class="p">,</span>
            <span class="n">check_ftype</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;basins&quot;</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">basins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a basin(s) geometry as a geopandas.GeoDataFrame.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;basins&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticgeoms</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticgeoms</span><span class="p">[</span><span class="s2">&quot;basins&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">flw</span><span class="o">.</span><span class="n">basin_shape</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flwdir</span><span class="p">,</span> <span class="n">basin_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;basins&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_staticgeoms</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;basins&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gdf</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rivers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a river geometry as a geopandas.GeoDataFrame. If available, the</span>
<span class="sd">        stream order and upstream area values are added to the geometry properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;rivers&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticgeoms</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticgeoms</span><span class="p">[</span><span class="s2">&quot;rivers&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;rivmsk&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">:</span>
            <span class="n">rivmsk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;rivmsk&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="c1"># Check if there are river cells in the model before continuing</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">rivmsk</span><span class="p">):</span>
                <span class="n">feats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flwdir</span><span class="o">.</span><span class="n">streams</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="n">rivmsk</span><span class="p">)</span>
                <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="o">.</span><span class="n">from_features</span><span class="p">(</span><span class="n">feats</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;idxs&quot;</span><span class="p">)</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="o">.</span><span class="n">from_user_input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_staticgeoms</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;rivers&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No river cells detected in the selected basin.&quot;</span><span class="p">)</span>
                <span class="n">gdf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">gdf</span>

<div class="viewcode-block" id="WflowModel.clip_staticmaps"><a class="viewcode-back" href="../../generated/hydromt_wflow.wflow.WflowModel.clip_staticmaps.html#hydromt_wflow.wflow.WflowModel.clip_staticmaps">[docs]</a>    <span class="k">def</span> <span class="nf">clip_staticmaps</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">region</span><span class="p">,</span>
        <span class="n">buffer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">align</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">crs</span><span class="o">=</span><span class="mi">4326</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clip staticmaps to subbasin.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        region : dict</span>
<span class="sd">            See :meth:`models.wflow.WflowModel.setup_basemaps`</span>
<span class="sd">        buffer : int, optional</span>
<span class="sd">            Buffer around subbasin in number of pixels, by default 0</span>
<span class="sd">        align : float, optional</span>
<span class="sd">            Align bounds of region to raster with resolution &lt;align&gt;, by default None</span>
<span class="sd">        crs: int, optional</span>
<span class="sd">            Default crs of the staticmaps to clip.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataSet</span>
<span class="sd">            Clipped staticmaps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">basins_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;basins&quot;</span><span class="p">]</span>
        <span class="n">flwdir_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;flwdir&quot;</span><span class="p">]</span>

        <span class="n">kind</span><span class="p">,</span> <span class="n">region</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">parse_region</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        <span class="c1"># translate basin and outlet kinds to geom</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;geom&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bbox&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;basin&quot;</span><span class="p">,</span> <span class="s2">&quot;outlet&quot;</span><span class="p">,</span> <span class="s2">&quot;subbasin&quot;</span><span class="p">]:</span>
            <span class="c1"># supply bbox to avoid getting basin bounds first when clipping subbasins</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;subbasin&quot;</span> <span class="ow">and</span> <span class="n">bbox</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">region</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bbox</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
            <span class="n">geom</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">get_basin_geometry</span><span class="p">(</span>
                <span class="n">ds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">,</span>
                <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
                <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
                <span class="n">basins_name</span><span class="o">=</span><span class="n">basins_name</span><span class="p">,</span>
                <span class="n">flwdir_name</span><span class="o">=</span><span class="n">flwdir_name</span><span class="p">,</span>
                <span class="o">**</span><span class="n">region</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># clip based on subbasin args, geom or bbox</span>
        <span class="k">if</span> <span class="n">geom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ds_staticmaps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">clip_geom</span><span class="p">(</span>
                <span class="n">geom</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="n">align</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span>
            <span class="p">)</span>
            <span class="n">ds_staticmaps</span><span class="p">[</span><span class="n">basins_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_staticmaps</span><span class="p">[</span><span class="n">basins_name</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">ds_staticmaps</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">[</span><span class="n">basins_name</span><span class="p">]</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">nodata</span>
            <span class="p">)</span>
            <span class="n">ds_staticmaps</span><span class="p">[</span><span class="n">basins_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">_FillValue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">[</span><span class="n">basins_name</span><span class="p">]</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">nodata</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">bbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ds_staticmaps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">clip_bbox</span><span class="p">(</span>
                <span class="n">bbox</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="n">align</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span>
            <span class="p">)</span>

        <span class="c1"># Update flwdir staticmaps and staticgeoms</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_crs</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_staticmaps</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_staticmaps</span><span class="p">(</span><span class="n">ds_staticmaps</span><span class="p">)</span>

        <span class="c1"># add pits at edges after clipping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flwdir</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># make sure old flwdir object is removed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;flwdir&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flwdir</span><span class="o">.</span><span class="n">to_array</span><span class="p">(</span><span class="s2">&quot;ldd&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_staticgeoms</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rivers</span>

        <span class="c1"># Update reservoir and lakes</span>
        <span class="n">remove_reservoir</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;resareas&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">:</span>
            <span class="n">reservoir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;resareas&quot;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">reservoir</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">remove_reservoir</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">remove_maps</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;resareas&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;reslocs&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;ResSimpleArea&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ResDemand&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ResTargetFullFrac&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ResTargetMinFrac&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ResMaxRelease&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ResMaxVolume&quot;</span><span class="p">,</span>
                <span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_staticmaps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">remove_maps</span><span class="p">)</span>

        <span class="n">remove_lake</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;lakeareas&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">:</span>
            <span class="n">lake</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;lakeareas&quot;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">lake</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">remove_lake</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">remove_maps</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;lakeareas&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;lakelocs&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;LinkedLakeLocs&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;LakeStorFunc&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;LakeOutflowFunc&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;LakeArea&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;LakeAvgLevel&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;LakeAvgOut&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;LakeThreshold&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Lake_b&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Lake_e&quot;</span><span class="p">,</span>
                <span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_staticmaps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">remove_maps</span><span class="p">)</span>

        <span class="c1"># Update config</span>
        <span class="c1"># Remove the absolute path and if needed remove lakes and reservoirs</span>
        <span class="k">if</span> <span class="n">remove_reservoir</span><span class="p">:</span>
            <span class="c1"># change reservoirs = true to false</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="s2">&quot;model.reservoirs&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="c1"># remove states</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;state.lateral.river.reservoir&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">][</span><span class="s2">&quot;lateral&quot;</span><span class="p">][</span><span class="s2">&quot;river&quot;</span><span class="p">][</span><span class="s2">&quot;reservoir&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">remove_lake</span><span class="p">:</span>
            <span class="c1"># change lakes = true to false</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="s2">&quot;model.lakes&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="c1"># remove states</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;state.lateral.river.lake&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">][</span><span class="s2">&quot;lateral&quot;</span><span class="p">][</span><span class="s2">&quot;river&quot;</span><span class="p">][</span><span class="s2">&quot;lake&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="WflowModel.clip_forcing"><a class="viewcode-back" href="../../generated/hydromt_wflow.wflow.WflowModel.clip_forcing.html#hydromt_wflow.wflow.WflowModel.clip_forcing">[docs]</a>    <span class="k">def</span> <span class="nf">clip_forcing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="mi">4326</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return clippped forcing for subbasin.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataSet</span>
<span class="sd">            Clipped forcing.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forcing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Clipping NetCDF forcing..&quot;</span><span class="p">)</span>
            <span class="n">ds_forcing</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forcing</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">clip_bbox</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">bounds</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_forcing</span><span class="p">(</span><span class="n">ds_forcing</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright Deltares.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>