
<!DOCTYPE html>


<html lang="en" data-content_root="../../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>hydromt_wflow.wflow_base &#8212; HydroMT Wflow  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/theme-deltares.css?v=066b352c" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/hydromt_wflow/wflow_base';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.1';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://raw.githubusercontent.com/Deltares/hydromt_wflow/gh-pages/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '1.0.0';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            false;
        </script>
    <link rel="icon" href="../../_static/hydromt-icon.svg"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="1.0.0.dev" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
    
    <img src="../../_static/hydromt-icon.svg" class="logo__image only-light" alt=""/>
    <img src="../../_static/hydromt-icon.svg" class="logo__image only-dark pst-js-only" alt=""/>
  
  
    <p class="title logo__title">HydroMT Wflow</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../getting_started/intro.html">
    Getting started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../user_guide/index.html">
    User guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api/index.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../dev_guide/intro.html">
    Developments
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://deltares.github.io/hydromt/latest/index.html">
    HydroMT core
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/Deltares/hydromt_wflow" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://deltares.github.io/Wflow.jl/dev/" title="Wflow" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../_static/wflow_logo.png" class="icon-link-image" alt="Wflow"/></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://www.deltares.nl/en/" title="Deltares" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../_static/deltares-blue.svg" class="icon-link-image" alt="Deltares"/></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../getting_started/intro.html">
    Getting started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../user_guide/index.html">
    User guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api/index.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../dev_guide/intro.html">
    Developments
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://deltares.github.io/hydromt/latest/index.html">
    HydroMT core
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/Deltares/hydromt_wflow" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://deltares.github.io/Wflow.jl/dev/" title="Wflow" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../_static/wflow_logo.png" class="icon-link-image" alt="Wflow"/></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://www.deltares.nl/en/" title="Deltares" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../_static/deltares-blue.svg" class="icon-link-image" alt="Deltares"/></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">hydromt_wflow.wflow_base</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for hydromt_wflow.wflow_base</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Implement Wflow base model class.&quot;&quot;&quot;</span>

<span class="c1"># Implement model class following model API</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">os.path</span><span class="w"> </span><span class="kn">import</span> <span class="n">isfile</span><span class="p">,</span> <span class="n">join</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyflwdir</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyproj</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydromt</span><span class="w"> </span><span class="kn">import</span> <span class="n">hydromt_step</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydromt.error</span><span class="w"> </span><span class="kn">import</span> <span class="n">NoDataStrategy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydromt.gis</span><span class="w"> </span><span class="kn">import</span> <span class="n">flw</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydromt.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">Model</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">hydromt_wflow.utils</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">utils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydromt_wflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">workflows</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydromt_wflow.components</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">WflowConfigComponent</span><span class="p">,</span>
    <span class="n">WflowForcingComponent</span><span class="p">,</span>
    <span class="n">WflowGeomsComponent</span><span class="p">,</span>
    <span class="n">WflowOutputCsvComponent</span><span class="p">,</span>
    <span class="n">WflowOutputGridComponent</span><span class="p">,</span>
    <span class="n">WflowOutputScalarComponent</span><span class="p">,</span>
    <span class="n">WflowStatesComponent</span><span class="p">,</span>
    <span class="n">WflowStaticmapsComponent</span><span class="p">,</span>
    <span class="n">WflowTablesComponent</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;WflowBaseModel&quot;</span><span class="p">]</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;hydromt.</span><span class="si">{</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="WflowBaseModel">
<a class="viewcode-back" href="../../api/advanced/base-model.html#hydromt_wflow.WflowBaseModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WflowBaseModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base Class for all Wflow Model implementations.</span>

<span class="sd">    DO NOT USE THIS CLASS DIRECTLY. ONLY USE SUBCLASSES OF THIS CLASS.</span>

<span class="sd">    It provides common functionality (IO, components and workflows).</span>
<span class="sd">    Any specific implementation details for either `sediment` of `sbm` should be</span>
<span class="sd">    handled in the derived classes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    root : str, optional</span>
<span class="sd">        Model root, by default None (current working directory)</span>
<span class="sd">    config_filename : str, optional</span>
<span class="sd">        A path relative to the root where the configuration file will</span>
<span class="sd">        be read and written if user does not provide a path themselves.</span>
<span class="sd">        By default &quot;wflow.toml&quot;</span>
<span class="sd">    mode : {&#39;r&#39;,&#39;r+&#39;,&#39;w&#39;}, optional</span>
<span class="sd">        read/append/write mode, by default &quot;w&quot;</span>
<span class="sd">    data_libs : list[str] | str, optional</span>
<span class="sd">        List of data catalog configuration files, by default None</span>
<span class="sd">    **catalog_keys:</span>
<span class="sd">        Additional keyword arguments to be passed down to the DataCatalog.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;wflow&quot;</span>

    <span class="n">_MODEL_VERSION</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># TODO supported model version should be filled by the plugins</span>
    <span class="c1"># e.g. _MODEL_VERSION = &quot;&gt;=1.0, &lt;1.1</span>

    <span class="n">_DATADIR</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">DATADIR</span>

<div class="viewcode-block" id="WflowBaseModel.__init__">
<a class="viewcode-back" href="../../api/advanced/_generated/hydromt_wflow.WflowBaseModel.html#hydromt_wflow.WflowBaseModel.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span>
        <span class="n">data_libs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">catalog_keys</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="n">WflowBaseModel</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;``WflowBaseModel`` is an abstract class and cannot be instantiated &quot;</span>
                <span class="s2">&quot;directly. Please use one of its subclasses defined as hydromt-entry &quot;</span>
                <span class="s2">&quot;points: [``WflowSbmModel``, ``WflowSedimentModel``]&quot;</span>
            <span class="p">)</span>

        <span class="n">default_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATADIR</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.toml&quot;</span>
        <span class="k">if</span> <span class="n">config_filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config_filename</span> <span class="o">=</span> <span class="n">default_filename</span><span class="o">.</span><span class="n">name</span>

        <span class="n">components</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">WflowConfigComponent</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">config_filename</span><span class="p">),</span>
                <span class="n">default_template_filename</span><span class="o">=</span><span class="n">default_filename</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="p">),</span>
            <span class="s2">&quot;forcing&quot;</span><span class="p">:</span> <span class="n">WflowForcingComponent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_component</span><span class="o">=</span><span class="s2">&quot;staticmaps&quot;</span><span class="p">),</span>
            <span class="s2">&quot;geoms&quot;</span><span class="p">:</span> <span class="n">WflowGeomsComponent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_component</span><span class="o">=</span><span class="s2">&quot;staticmaps&quot;</span><span class="p">),</span>
            <span class="s2">&quot;states&quot;</span><span class="p">:</span> <span class="n">WflowStatesComponent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_component</span><span class="o">=</span><span class="s2">&quot;staticmaps&quot;</span><span class="p">),</span>
            <span class="s2">&quot;staticmaps&quot;</span><span class="p">:</span> <span class="n">WflowStaticmapsComponent</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
            <span class="s2">&quot;tables&quot;</span><span class="p">:</span> <span class="n">WflowTablesComponent</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
            <span class="s2">&quot;output_grid&quot;</span><span class="p">:</span> <span class="n">WflowOutputGridComponent</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">region_component</span><span class="o">=</span><span class="s2">&quot;staticmaps&quot;</span>
            <span class="p">),</span>
            <span class="s2">&quot;output_scalar&quot;</span><span class="p">:</span> <span class="n">WflowOutputScalarComponent</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
            <span class="s2">&quot;output_csv&quot;</span><span class="p">:</span> <span class="n">WflowOutputCsvComponent</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">locations_component</span><span class="o">=</span><span class="s2">&quot;staticmaps&quot;</span>
            <span class="p">),</span>
        <span class="p">}</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">root</span><span class="p">,</span>
            <span class="n">components</span><span class="o">=</span><span class="n">components</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">region_component</span><span class="o">=</span><span class="s2">&quot;staticmaps&quot;</span><span class="p">,</span>
            <span class="n">data_libs</span><span class="o">=</span><span class="n">data_libs</span><span class="p">,</span>
            <span class="o">**</span><span class="n">catalog_keys</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_WFLOW_NAMES</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># wflow specific</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flwdir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">from_yml</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATADIR</span> <span class="o">/</span> <span class="s2">&quot;parameters_data.yml&quot;</span><span class="p">)</span>

        <span class="c1"># Supported Wflow.jl version</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Supported Wflow.jl version v1+&quot;</span><span class="p">)</span></div>


    <span class="c1">## Properties</span>
    <span class="c1"># Components</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WflowConfigComponent</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the config component.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forcing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WflowForcingComponent</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the forcing component.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;forcing&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">geoms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WflowGeomsComponent</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the geoms component.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;geoms&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">states</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WflowStatesComponent</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the states component.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;states&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">staticmaps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WflowStaticmapsComponent</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the staticmaps component.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;staticmaps&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WflowTablesComponent</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the WflowTablesComponent instance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;tables&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">output_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WflowOutputGridComponent</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the WflowOutputGridComponent instance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;output_grid&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">output_scalar</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WflowOutputScalarComponent</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the WflowOutputScalarComponent instance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;output_scalar&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">output_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WflowOutputCsvComponent</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the WflowOutputCsvComponent instance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;output_csv&quot;</span><span class="p">]</span>

    <span class="c1">## SETUP METHODS</span>
<div class="viewcode-block" id="WflowBaseModel.setup_config">
<a class="viewcode-back" href="../../api/advanced/base-model.html#hydromt_wflow.WflowBaseModel.setup_config">[docs]</a>
    <span class="nd">@hydromt_step</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the config dictionary at key(s) with values.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : dict[str, Any]</span>
<span class="sd">            A dictionary with the values to be set. keys can be dotted like in</span>
<span class="sd">            :py:meth:`~hydromt_wflow.components.config.WflowConfigComponent.set`</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Setting data as a nested dictionary::</span>


<span class="sd">            &gt;&gt; self.setup_config({&#39;a&#39;: 1, &#39;b&#39;: {&#39;c&#39;: {&#39;d&#39;: 2}}})</span>
<span class="sd">            &gt;&gt; self.config.data</span>
<span class="sd">            {&#39;a&#39;: 1, &#39;b&#39;: {&#39;c&#39;: {&#39;d&#39;: 2}}}</span>

<span class="sd">        Setting data using dotted notation::</span>

<span class="sd">            &gt;&gt; self.setup_config({&#39;a.d.f.g&#39;: 1, &#39;b&#39;: {&#39;c&#39;: {&#39;d&#39;: 2}}})</span>
<span class="sd">            &gt;&gt; self.config.data</span>
<span class="sd">            {&#39;a&#39;: {&#39;d&#39;:{&#39;f&#39;:{&#39;g&#39;: 1}}}, &#39;b&#39;: {&#39;c&#39;: {&#39;d&#39;: 2}}}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="WflowBaseModel.setup_config_output_timeseries">
<a class="viewcode-back" href="../../api/advanced/base-model.html#hydromt_wflow.WflowBaseModel.setup_config_output_timeseries">[docs]</a>
    <span class="nd">@hydromt_step</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_config_output_timeseries</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mapname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">toml_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span><span class="p">,</span>
        <span class="n">header</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;river_q&quot;</span><span class="p">],</span>
        <span class="n">param</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;river_water__volume_flow_rate&quot;</span><span class="p">],</span>
        <span class="n">reducer</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the default gauge map based on basin outlets.</span>

<span class="sd">        Adds model layers:</span>

<span class="sd">        * **csv.column** config: csv timeseries to save based on mapname locations</span>
<span class="sd">        * **netcdf.variable** config: netcdf timeseries to save based on mapname \</span>
<span class="sd">            locations</span>

<span class="sd">        Required setup methods:</span>

<span class="sd">        * :py:meth:`~WflowBaseModel.setup_basemaps`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mapname : str</span>
<span class="sd">            Name of the gauge map (in staticmaps.nc) to use for scalar output.</span>
<span class="sd">        toml_output : str, optional</span>
<span class="sd">            One of [&#39;csv&#39;, &#39;netcdf_scalar&#39;, None] to update [output.csv] or</span>
<span class="sd">            [output.netcdf_scalar] section of wflow toml file or do nothing. By</span>
<span class="sd">            default, &#39;csv&#39;.</span>
<span class="sd">        header : list, optional</span>
<span class="sd">            Save specific model parameters in csv section. This option defines</span>
<span class="sd">            the header of the csv file.</span>
<span class="sd">            By default saves river_q (for river_water__volume_flow_rate).</span>
<span class="sd">        param: list, optional</span>
<span class="sd">            Save specific model parameters in csv section. This option defines</span>
<span class="sd">            the wflow variable corresponding to the</span>
<span class="sd">            names in gauge_toml_header. By default saves river_water__volume_flow_rate</span>
<span class="sd">            (for river_q).</span>
<span class="sd">        reducer: list, optional</span>
<span class="sd">            If map is an area rather than a point location, provides the reducer</span>
<span class="sd">            for the parameters to save. By default None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># # Add new outputcsv section in the config</span>
        <span class="k">if</span> <span class="n">toml_output</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span> <span class="ow">or</span> <span class="n">toml_output</span> <span class="o">==</span> <span class="s2">&quot;netcdf_scalar&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding </span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">toml_output</span><span class="si">}</span><span class="s2"> section of toml.&quot;</span><span class="p">)</span>
            <span class="c1"># Add map to the input section of config</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;input.</span><span class="si">{</span><span class="n">mapname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mapname</span><span class="p">)</span>
            <span class="c1"># Settings and add csv or netcdf sections if not already in config</span>
            <span class="c1"># csv</span>
            <span class="k">if</span> <span class="n">toml_output</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
                <span class="n">header_name</span> <span class="o">=</span> <span class="s2">&quot;header&quot;</span>
                <span class="n">var_name</span> <span class="o">=</span> <span class="s2">&quot;column&quot;</span>
                <span class="n">current_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;output.csv&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">current_config</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_config</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;output.csv.path&quot;</span><span class="p">,</span> <span class="s2">&quot;output.csv&quot;</span><span class="p">)</span>
            <span class="c1"># netcdf</span>
            <span class="k">if</span> <span class="n">toml_output</span> <span class="o">==</span> <span class="s2">&quot;netcdf_scalar&quot;</span><span class="p">:</span>
                <span class="n">header_name</span> <span class="o">=</span> <span class="s2">&quot;name&quot;</span>
                <span class="n">var_name</span> <span class="o">=</span> <span class="s2">&quot;variable&quot;</span>
                <span class="n">current_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;output.netcdf_scalar&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">current_config</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_config</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;output.netcdf_scalar.path&quot;</span><span class="p">,</span> <span class="s2">&quot;output_scalar.nc&quot;</span><span class="p">)</span>
            <span class="c1"># initialise column / variable section</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;output.</span><span class="si">{</span><span class="n">toml_output</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;output.</span><span class="si">{</span><span class="n">toml_output</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">[])</span>

            <span class="c1"># Add new output column/variable to config</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">)):</span>
                <span class="n">gauge_toml_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">header_name</span><span class="p">:</span> <span class="n">header</span><span class="p">[</span><span class="n">o</span><span class="p">],</span>
                    <span class="s2">&quot;map&quot;</span><span class="p">:</span> <span class="n">mapname</span><span class="p">,</span>
                    <span class="s2">&quot;parameter&quot;</span><span class="p">:</span> <span class="n">param</span><span class="p">[</span><span class="n">o</span><span class="p">],</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="n">reducer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">gauge_toml_dict</span><span class="p">[</span><span class="s2">&quot;reducer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reducer</span><span class="p">[</span><span class="n">o</span><span class="p">]</span>
                <span class="c1"># If the gauge column/variable already exists skip writing twice</span>
                <span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;output.</span><span class="si">{</span><span class="n">toml_output</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">gauge_toml_dict</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
                    <span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gauge_toml_dict</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;output.</span><span class="si">{</span><span class="n">toml_output</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">variables</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;toml_output set to </span><span class="si">{</span><span class="n">toml_output</span><span class="si">}</span><span class="s2">, </span><span class="se">\</span>
<span class="s2">skipping adding gauge specific outputs to the toml.&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="WflowBaseModel.setup_basemaps">
<a class="viewcode-back" href="../../api/advanced/base-model.html#hydromt_wflow.WflowBaseModel.setup_basemaps">[docs]</a>
    <span class="nd">@hydromt_step</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_basemaps</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">region</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">hydrography_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
        <span class="n">basin_index_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">res</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">120.0</span><span class="p">,</span>
        <span class="n">upscale_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ihu&quot;</span><span class="p">,</span>
        <span class="n">output_names</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;basin__local_drain_direction&quot;</span><span class="p">:</span> <span class="s2">&quot;local_drain_direction&quot;</span><span class="p">,</span>
            <span class="s2">&quot;subbasin_location__count&quot;</span><span class="p">:</span> <span class="s2">&quot;subcatchment&quot;</span><span class="p">,</span>
            <span class="s2">&quot;land_surface__slope&quot;</span><span class="p">:</span> <span class="s2">&quot;land_slope&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build the DEM and flow direction for a Wflow model.</span>

<span class="sd">        Setup basemaps sets the `region` of interest and `res`</span>
<span class="sd">        (resolution in degrees) of the model.</span>
<span class="sd">        All DEM and flow direction related maps are then build.</span>

<span class="sd">        We strongly recommend using the region types ``basin`` or ``subbasin`` to build</span>
<span class="sd">        a wflow model. If you know what you are doing, you can also use the ``bbox``</span>
<span class="sd">        region type (e.g for an island) with the bbox coordinates in EPSG 4326 or the</span>
<span class="sd">        ``geom`` region type (e.g. basin polygons have been pre-processed and match</span>
<span class="sd">        EXACTLY with ``hydrography_fn``).</span>

<span class="sd">        E.g. of `region` argument for a subbasin based on a point and snapped using</span>
<span class="sd">        upstream area threshold in `hydrography_fn`, where the maximum boundary box of</span>
<span class="sd">        the output subbasin is known:</span>
<span class="sd">        region = {&#39;subbasin&#39;: [x,y], &#39;uparea&#39;: 10, &#39;bounds&#39;: [xmin, ymin, xmax, ymax]}</span>

<span class="sd">        (Sub)Basin delineation is done using hydromt.workflows.get_basin_geometry</span>
<span class="sd">        method. Because the delineation is computed from the flow direction data in</span>
<span class="sd">        memory, to avoid memory error when using large datasets in `hydrography_fn`, the</span>
<span class="sd">        user can either supply &#39;bounds&#39; in `region` or a basin index dataset in</span>
<span class="sd">        `basin_index_fn` to limit the flow direction data to the region of interest.</span>
<span class="sd">        The basin index dataset is a GeoDataframe containing either basins polygons or</span>
<span class="sd">        bounding boxes of basin boundaries. To select the correct basins, basin ID</span>
<span class="sd">        &#39;basins&#39; in `hydrography_fn` and `basin_index_fn` should match.</span>

<span class="sd">        If the model resolution is larger than the source data resolution,</span>
<span class="sd">        the flow direction is upscaled using the `upscale_method`, by default the</span>
<span class="sd">        Iterative Hydrography Upscaling (IHU).</span>

<span class="sd">        The default `hydrography_fn` is &quot;merit_hydro&quot;</span>
<span class="sd">        (`MERIT hydro &lt;http://hydro.iis.u-tokyo.ac.jp/~yamadai/MERIT_Hydro/index.html&gt;`_</span>
<span class="sd">        at 3 arcsec resolution).</span>
<span class="sd">        Alternative sources include &quot;merit_hydro_1k&quot; at 30 arcsec resolution.</span>
<span class="sd">        Users can also supply their own elevation and flow direction data</span>
<span class="sd">        in any CRS and not only EPSG:4326. The ArcGIS D8 convention is supported</span>
<span class="sd">        (see also `PyFlwDir documentation</span>
<span class="sd">        &lt;https://deltares.github.io/pyflwdir/latest/_examples/flwdir.html&gt;`).</span>

<span class="sd">        Note that in order to define the region, using points or bounding box,</span>
<span class="sd">        the coordinates of the points / bounding box</span>
<span class="sd">        should be in the same CRS than the hydrography data.</span>
<span class="sd">        The wflow model will then also be in the same CRS than the</span>
<span class="sd">        hydrography data in order to avoid assumptions and reprojection errors.</span>
<span class="sd">        If the user wishes to use a different CRS,</span>
<span class="sd">        we recommend first to reproject the hydrography data separately,</span>
<span class="sd">        before calling hydromt build.</span>
<span class="sd">        You can find examples on how to reproject or prepare hydrography data in the</span>
<span class="sd">        `prepare flow directions example notebook</span>
<span class="sd">        &lt;https://deltares.github.io/hydromt_wflow/latest/_examples/prepare_ldd.html&gt;`_.</span>

<span class="sd">        Adds model layers:</span>

<span class="sd">        * **local_drain_direction** map: flow direction in LDD format [-]</span>
<span class="sd">        * **subcatchment** map: basin ID map [-]</span>
<span class="sd">        * **meta_upstream_area** map: upstream area [km2]</span>
<span class="sd">        * **meta_streamorder** map: Strahler stream order [-]</span>
<span class="sd">        * **land_elevation** map: average elevation [m+REF]</span>
<span class="sd">        * **meta_subgrid_elevation** map: subgrid outlet elevation [m+REF]</span>
<span class="sd">        * **land_slope** map: average land surface slope [m/m]</span>
<span class="sd">        * **basins** geom: basins boundary vector</span>
<span class="sd">        * **region** geom: region boundary vector</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        region : dict</span>
<span class="sd">            Dictionary describing region of interest.</span>
<span class="sd">            See :py:meth:`hydromt.workflows.basin_mask.parse_region()` for all options</span>
<span class="sd">        hydrography_fn : str, xarray.Dataset</span>
<span class="sd">            Name of RasterDataset source for basemap parameters.</span>

<span class="sd">            * Required variables: &#39;flwdir&#39; [LLD or D8 or NEXTXY], &#39;elevtn&#39; [m+REF]</span>

<span class="sd">            * Required variables if used with `basin_index_fn`: &#39;basins&#39; [-]</span>

<span class="sd">            * Required variables if used for snapping in `region`: &#39;uparea&#39; [km2],</span>
<span class="sd">                &#39;strord&#39; [-]</span>

<span class="sd">            * Optional variables: &#39;lndslp&#39; [m/m], &#39;mask&#39; [bool]</span>
<span class="sd">        basin_index_fn : str, geopandas.GeoDataFrame, optional</span>
<span class="sd">            Name of GeoDataFrame source for basin_index data linked to hydrography_fn.</span>

<span class="sd">            * Required variables: &#39;basid&#39; [-]</span>
<span class="sd">        res : float, optional</span>
<span class="sd">            Output model resolution</span>
<span class="sd">        upscale_method : {&#39;ihu&#39;, &#39;eam&#39;, &#39;dmm&#39;}, optional</span>
<span class="sd">            Upscaling method for flow direction data, by default &#39;ihu&#39;.</span>
<span class="sd">        output_names : dict, optional</span>
<span class="sd">            Dictionary with output names that will be used in the model netcdf input</span>
<span class="sd">            files. Users should provide the Wflow.jl variable name followed by the name</span>
<span class="sd">            in the netcdf file.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        hydromt.workflows.parse_region</span>
<span class="sd">        hydromt.workflows.get_basin_geometry</span>
<span class="sd">        workflows.hydrography</span>
<span class="sd">        workflows.topography</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Preparing base hydrography basemaps.&quot;</span><span class="p">)</span>
        <span class="c1"># update self._MAPS and self._WFLOW_NAMES with user defined output names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_naming</span><span class="p">(</span><span class="n">output_names</span><span class="p">)</span>

        <span class="n">geometries</span><span class="p">,</span> <span class="n">xy</span><span class="p">,</span> <span class="n">ds_org</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">parse_region</span><span class="p">(</span>
            <span class="n">data_catalog</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="p">,</span>
            <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
            <span class="n">hydrography_fn</span><span class="o">=</span><span class="n">hydrography_fn</span><span class="p">,</span>
            <span class="n">resolution</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
            <span class="n">basin_index_fn</span><span class="o">=</span><span class="n">basin_index_fn</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># setup hydrography maps and set staticmap attribute with renamed maps</span>
        <span class="n">ds_base</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">hydrography</span><span class="p">(</span>
            <span class="n">ds</span><span class="o">=</span><span class="n">ds_org</span><span class="p">,</span>
            <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="n">xy</span><span class="p">,</span>
            <span class="n">upscale_method</span><span class="o">=</span><span class="n">upscale_method</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Rename and add to grid</span>
        <span class="c1"># rename idx_out coords</span>
        <span class="k">if</span> <span class="s2">&quot;idx_out&quot;</span> <span class="ow">in</span> <span class="n">ds_base</span><span class="p">:</span>
            <span class="n">ds_base</span> <span class="o">=</span> <span class="n">ds_base</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;idx_out&quot;</span><span class="p">:</span> <span class="s2">&quot;meta_subgrid_outlet_idx&quot;</span><span class="p">})</span>
            <span class="c1"># Set meta_subgrid as a data variable instead of coordinate</span>
            <span class="n">da_outlet</span> <span class="o">=</span> <span class="n">ds_base</span><span class="p">[</span><span class="s2">&quot;meta_subgrid_outlet_idx&quot;</span><span class="p">]</span>
            <span class="n">ds_base</span> <span class="o">=</span> <span class="n">ds_base</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;meta_subgrid_outlet_idx&quot;</span><span class="p">)</span>
            <span class="n">ds_base</span><span class="p">[</span><span class="s2">&quot;meta_subgrid_outlet_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">da_outlet</span>

        <span class="n">rmdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ds_base</span><span class="o">.</span><span class="n">data_vars</span><span class="p">}</span>
        <span class="k">if</span> <span class="s2">&quot;mask&quot;</span> <span class="ow">in</span> <span class="n">ds_base</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
            <span class="n">ds_base</span> <span class="o">=</span> <span class="n">ds_base</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ds_base</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rmdict</span><span class="p">))</span>

        <span class="c1"># Add basin geometries after grid is set to avoid warning</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding basin shape to staticgeoms.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_geom</span> <span class="ow">in</span> <span class="n">geometries</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">_geom</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># update config</span>
        <span class="c1"># skip adding elevtn to config as it will only be used if floodplain 2d are on</span>
        <span class="n">rmdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rmdict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;elevtn&quot;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_config_variable_name</span><span class="p">(</span><span class="n">ds_base</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rmdict</span><span class="p">)</span><span class="o">.</span><span class="n">data_vars</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Call basins once to set it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basins</span>

        <span class="c1"># setup topography maps</span>
        <span class="n">ds_topo</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">topography</span><span class="p">(</span>
            <span class="n">ds</span><span class="o">=</span><span class="n">ds_org</span><span class="p">,</span>
            <span class="n">ds_like</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;average&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">rmdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ds_topo</span><span class="o">.</span><span class="n">data_vars</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ds_topo</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rmdict</span><span class="p">))</span>

        <span class="c1"># update config</span>
        <span class="c1"># skip adding elevtn to config as it will only be used if floodplain 2d are on</span>
        <span class="n">rmdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rmdict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;elevtn&quot;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_config_variable_name</span><span class="p">(</span><span class="n">ds_topo</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rmdict</span><span class="p">)</span><span class="o">.</span><span class="n">data_vars</span><span class="p">)</span>

        <span class="c1"># update toml for degree/meters if needed</span>
        <span class="k">if</span> <span class="n">ds_base</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">is_projected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;model.cell_length_in_meter__flag&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="WflowBaseModel.setup_rivers">
<a class="viewcode-back" href="../../api/advanced/base-model.html#hydromt_wflow.WflowBaseModel.setup_rivers">[docs]</a>
    <span class="nd">@hydromt_step</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_rivers</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">hydrography_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
        <span class="n">river_geom_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">river_upa</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
        <span class="n">slope_len</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2e3</span><span class="p">,</span>
        <span class="n">min_rivlen_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">smooth_len</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5e3</span><span class="p">,</span>
        <span class="n">min_rivwth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
        <span class="n">rivdph_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;powlaw&quot;</span><span class="p">,</span>
        <span class="n">min_rivdph</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">output_names</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;river_location__mask&quot;</span><span class="p">:</span> <span class="s2">&quot;river_mask&quot;</span><span class="p">,</span>
            <span class="s2">&quot;river__length&quot;</span><span class="p">:</span> <span class="s2">&quot;river_length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;river__width&quot;</span><span class="p">:</span> <span class="s2">&quot;river_width&quot;</span><span class="p">,</span>
            <span class="s2">&quot;river__slope&quot;</span><span class="p">:</span> <span class="s2">&quot;river_slope&quot;</span><span class="p">,</span>
            <span class="s2">&quot;river__depth&quot;</span><span class="p">:</span> <span class="s2">&quot;river_depth&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set all river parameter maps.</span>

<span class="sd">        The river mask is defined by all cells with a minimum upstream area threshold</span>
<span class="sd">        ``river_upa`` [km2].</span>

<span class="sd">        The river length is defined as the distance from the subgrid outlet pixel to</span>
<span class="sd">        the next upstream subgrid outlet pixel. The ``min_rivlen_ratio`` is the minimum</span>
<span class="sd">        global river length to avg. cell resolution ratio and is used as a threshold in</span>
<span class="sd">        window-based smoothing of river length.</span>

<span class="sd">        The river slope is derived from the subgrid elevation difference between pixels</span>
<span class="sd">        at a half distance ``slope_len`` [m] up- and downstream from the subgrid outlet</span>
<span class="sd">        pixel.</span>

<span class="sd">        The river width is derived from the nearest river segment in ``river_geom_fn``.</span>
<span class="sd">        Data gaps are filled by the nearest valid upstream value and averaged along</span>
<span class="sd">        the flow directions over a length ``smooth_len`` [m].</span>

<span class="sd">        Optionally, river depth is derived using ``rivdph_method`` if provided</span>
<span class="sd">        (default is &quot;powlaw&quot;). Data gaps are filled similarly to river width.</span>

<span class="sd">        Adds model layers:</span>

<span class="sd">        * **wflow_river** map: river mask [-]</span>
<span class="sd">        * **river_length** map: river length [m]</span>
<span class="sd">        * **river_width** map: river width [m]</span>
<span class="sd">        * **river_slope** map: river slope [m/m]</span>
<span class="sd">        * **river_depth** map: river depth [m] (if ``rivdph_method`` is not None)</span>
<span class="sd">        * **rivers** geom: river vector based on wflow_river mask</span>

<span class="sd">        Required setup methods:</span>

<span class="sd">        * :py:meth:`~WflowBaseModel.setup_basemaps`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hydrography_fn : str, Path, xarray.Dataset</span>
<span class="sd">            Name of RasterDataset source for hydrography data. Must be same as</span>
<span class="sd">            setup_basemaps for consistent results.</span>

<span class="sd">            * **Required variables**: &#39;flwdir&#39; [LLD or D8 or NEXTXY], &#39;uparea&#39; [km2],</span>
<span class="sd">              &#39;elevtn&#39; [m+REF]</span>

<span class="sd">            * **Optional variables**: &#39;rivwth&#39; [m]</span>

<span class="sd">        river_geom_fn : str, Path, geopandas.GeoDataFrame, optional</span>
<span class="sd">            Name of GeoDataFrame source for river data.</span>

<span class="sd">            * **Required variables**: &#39;rivwth&#39; [m]</span>

<span class="sd">        river_upa : float, optional</span>
<span class="sd">            Minimum upstream area threshold for the river map [km2]. By default 30.0</span>
<span class="sd">        slope_len : float, optional</span>
<span class="sd">            Length [km] over which the river slope is calculated. By default 2.0</span>
<span class="sd">        min_rivlen_ratio: float, optional</span>
<span class="sd">            Ratio of cell resolution used as a minimum length threshold in a moving</span>
<span class="sd">            window-based smoothing of river length, by default 0.0.</span>
<span class="sd">            The river length smoothing is skipped if `min_rivlen_ratio` = 0.</span>
<span class="sd">            For details about the river length smoothing,</span>
<span class="sd">            see :py:meth:`pyflwdir.FlwdirRaster.smooth_rivlen`</span>
<span class="sd">        smooth_len : float, optional</span>
<span class="sd">            Length [m] over which to smooth the output river width and depth,</span>
<span class="sd">            by default 5000.0</span>
<span class="sd">        min_rivwth : float, optional</span>
<span class="sd">            Minimum river width [m], by default 30.0</span>
<span class="sd">        rivdph_method : str, optional</span>
<span class="sd">            Method for estimating river depth. Default is &quot;powlaw&quot;.</span>
<span class="sd">            Set to None to skip river depth estimation.</span>
<span class="sd">        min_rivdph : float, optional</span>
<span class="sd">            Minimum river depth [m], by default 1.0</span>
<span class="sd">        output_names : dict, optional</span>
<span class="sd">            Dictionary with output names that will be used in the model netcdf input</span>
<span class="sd">            files. Users should provide the Wflow.jl variable name followed by the name</span>
<span class="sd">            in the netcdf file. By default, includes river mask, length, width, slope,</span>
<span class="sd">            and depth.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Preparing river maps.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_naming</span><span class="p">(</span><span class="n">output_names</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">river_upa</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;uparea&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;river_upa threshold </span><span class="si">{</span><span class="n">river_upa</span><span class="si">}</span><span class="s2"> should be larger than the maximum &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;uparea </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s1">&#39;uparea&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;to create river cells.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># read hydrography data</span>
        <span class="n">ds_hydro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_rasterdataset</span><span class="p">(</span>
            <span class="n">hydrography_fn</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>
        <span class="n">ds_hydro</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_hydro</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">geometry_mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>

        <span class="c1"># derive rivmsk, rivlen, rivslp</span>
        <span class="n">inv_rename</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">}</span>
        <span class="n">ds_riv</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">river</span><span class="p">(</span>
            <span class="n">ds</span><span class="o">=</span><span class="n">ds_hydro</span><span class="p">,</span>
            <span class="n">ds_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">inv_rename</span><span class="p">),</span>
            <span class="n">river_upa</span><span class="o">=</span><span class="n">river_upa</span><span class="p">,</span>
            <span class="n">slope_len</span><span class="o">=</span><span class="n">slope_len</span><span class="p">,</span>
            <span class="n">channel_dir</span><span class="o">=</span><span class="s2">&quot;up&quot;</span><span class="p">,</span>
            <span class="n">min_rivlen_ratio</span><span class="o">=</span><span class="n">min_rivlen_ratio</span><span class="p">,</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">ds_riv</span><span class="p">[</span><span class="s2">&quot;rivmsk&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_riv</span><span class="p">[</span><span class="s2">&quot;rivmsk&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">(</span>
            <span class="n">river_upa</span><span class="o">=</span><span class="n">river_upa</span><span class="p">,</span> <span class="n">slope_len</span><span class="o">=</span><span class="n">slope_len</span><span class="p">,</span> <span class="n">min_rivlen_ratio</span><span class="o">=</span><span class="n">min_rivlen_ratio</span>
        <span class="p">)</span>
        <span class="n">dvars</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;rivmsk&quot;</span><span class="p">,</span> <span class="s2">&quot;rivlen&quot;</span><span class="p">,</span> <span class="s2">&quot;rivslp&quot;</span><span class="p">]</span>
        <span class="n">rmdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dvars</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ds_riv</span><span class="p">[</span><span class="n">dvars</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rmdict</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">dvar</span> <span class="ow">in</span> <span class="n">dvars</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dvar</span> <span class="o">==</span> <span class="s2">&quot;rivmsk&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_config_variable_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="n">dvar</span><span class="p">],</span> <span class="n">data_type</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_config_variable_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="n">dvar</span><span class="p">])</span>

        <span class="c1"># optional width/depth</span>
        <span class="k">if</span> <span class="n">river_geom_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gdf_riv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_geodataframe</span><span class="p">(</span>
                <span class="n">river_geom_fn</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span>
            <span class="p">)</span>
            <span class="n">inv_rename</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span>
            <span class="p">}</span>
            <span class="n">ds_riv1</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">river_bathymetry</span><span class="p">(</span>
                <span class="n">ds_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">inv_rename</span><span class="p">),</span>
                <span class="n">gdf_riv</span><span class="o">=</span><span class="n">gdf_riv</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">rivdph_method</span><span class="p">,</span>  <span class="c1"># None skips depth</span>
                <span class="n">smooth_len</span><span class="o">=</span><span class="n">smooth_len</span><span class="p">,</span>
                <span class="n">min_rivdph</span><span class="o">=</span><span class="n">min_rivdph</span><span class="p">,</span>
                <span class="n">min_rivwth</span><span class="o">=</span><span class="n">min_rivwth</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">rmdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ds_riv1</span><span class="o">.</span><span class="n">data_vars</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ds_riv1</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rmdict</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_config_variable_name</span><span class="p">(</span><span class="n">ds_riv1</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rmdict</span><span class="p">)</span><span class="o">.</span><span class="n">data_vars</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding rivers vector to geoms.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;rivers&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;rivers&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rivers</span></div>


<div class="viewcode-block" id="WflowBaseModel.setup_riverwidth">
<a class="viewcode-back" href="../../api/advanced/base-model.html#hydromt_wflow.WflowBaseModel.setup_riverwidth">[docs]</a>
    <span class="nd">@hydromt_step</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_riverwidth</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">predictor</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;discharge&quot;</span><span class="p">,</span>
        <span class="n">fill</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">fit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">min_wth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">precip_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span> <span class="o">=</span> <span class="s2">&quot;chelsa&quot;</span><span class="p">,</span>
        <span class="n">climate_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span> <span class="o">=</span> <span class="s2">&quot;koppen_geiger&quot;</span><span class="p">,</span>
        <span class="n">output_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;river_width&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the river width parameter based on power-law relationship with a predictor.</span>

<span class="sd">        By default the riverwidth is estimated based on discharge as ``predictor``</span>
<span class="sd">        and used to set the riverwidth globally based on pre-defined power-law</span>
<span class="sd">        parameters per climate class. With ``fit`` set to True,</span>
<span class="sd">        the power-law relationships parameters are set on-the-fly.</span>
<span class="sd">        With ``fill`` set to True, the estimated river widths are only used</span>
<span class="sd">        to fill gaps in the observed data. Alternative ``predictor`` values</span>
<span class="sd">        are precip (accumulated precipitation) and uparea (upstream area).</span>
<span class="sd">        For these predictors values ``fit`` default to True.</span>
<span class="sd">        By default the predictor is based on discharge which is estimated through</span>
<span class="sd">        multiple linear regression with precipitation and upstream area</span>
<span class="sd">        per climate zone.</span>

<span class="sd">        * **river_width** map: river width [m]</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        predictor : {&quot;discharge&quot;, &quot;precip&quot;, &quot;uparea&quot;}</span>
<span class="sd">            Predictor used in the power-law equation: width = a * predictor ^ b.</span>
<span class="sd">            Discharge is based on multiple linear regression per climate zone.</span>
<span class="sd">            Precip is based on the 10x the daily average</span>
<span class="sd">            accumulated precipitation [m3/s].</span>
<span class="sd">            Uparea is based on the upstream area grid [km2].</span>
<span class="sd">            Other variables, e.g. bankfull discharge, can also be provided if present</span>
<span class="sd">            in the grid</span>
<span class="sd">        fill : bool, optional</span>
<span class="sd">            If True (default), use estimate to fill gaps, outliers and lake/res areas</span>
<span class="sd">            in observed width data (if present);</span>
<span class="sd">            if False, set all riverwidths based on predictor</span>
<span class="sd">            (automatic choice if no observations found)</span>
<span class="sd">        fit : bool, optional</span>
<span class="sd">            If True, the power-law parameters are fitted on the fly</span>
<span class="sd">            By default True for all but &quot;discharge&quot; predictor.</span>
<span class="sd">            A-priori derived parameters will be overwritten if True.</span>
<span class="sd">        a, b : float, optional kwarg</span>
<span class="sd">            Manual power-law parameters</span>
<span class="sd">        min_wth : float, optional</span>
<span class="sd">            Minimum river width, by default 1.0</span>
<span class="sd">        precip_fn : str, xarray.DataArray</span>
<span class="sd">            Source of long term precipitation grid if the predictor</span>
<span class="sd">            is set to &#39;discharge&#39; or &#39;precip&#39;. By default &quot;chelsa&quot;.</span>
<span class="sd">        climate_fn: str, xarray.DataArray</span>
<span class="sd">            Source of long-term climate grid if the predictor is set to &#39;discharge&#39;.</span>
<span class="sd">            By default &quot;koppen_geiger&quot;.</span>
<span class="sd">        output_name : str</span>
<span class="sd">            The name of the output river__width map.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;The &quot;setup_riverwidth&quot; method has been deprecated </span><span class="se">\</span>
<span class="s1">and will soon be removed. &#39;</span>
            <span class="s1">&#39;You can now use the &quot;setup_river&quot; method for all river parameters.&#39;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;rivmsk&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The setup_riverwidth method requires to run setup_river method first.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># update self._MAPS and self._WFLOW_NAMES with user defined output names</span>
        <span class="n">wflow_var</span> <span class="o">=</span> <span class="s2">&quot;river__width&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_naming</span><span class="p">({</span><span class="n">wflow_var</span><span class="p">:</span> <span class="n">output_name</span><span class="p">})</span>

        <span class="c1"># derive river width</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">predictor</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;discharge&quot;</span><span class="p">,</span> <span class="s2">&quot;precip&quot;</span><span class="p">]:</span>
            <span class="n">da_precip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_rasterdataset</span><span class="p">(</span>
                <span class="n">precip_fn</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">da_precip</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">precip_fn</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;da_precip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">da_precip</span>
        <span class="k">if</span> <span class="n">predictor</span> <span class="o">==</span> <span class="s2">&quot;discharge&quot;</span><span class="p">:</span>
            <span class="n">da_climate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_rasterdataset</span><span class="p">(</span>
                <span class="n">climate_fn</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">da_climate</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">climate_fn</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;da_climate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">da_climate</span>

        <span class="n">inv_rename</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">}</span>
        <span class="n">da_rivwth</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">river_width</span><span class="p">(</span>
            <span class="n">ds_like</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">inv_rename</span><span class="p">),</span>
            <span class="n">flwdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flwdir</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">fill</span><span class="o">=</span><span class="n">fill</span><span class="p">,</span>
            <span class="n">fill_outliers</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;fill_outliers&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="p">),</span>
            <span class="n">min_wth</span><span class="o">=</span><span class="n">min_wth</span><span class="p">,</span>
            <span class="n">mask_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lake_area_id&quot;</span><span class="p">,</span> <span class="s2">&quot;reservoir_area_id&quot;</span><span class="p">],</span>
            <span class="n">predictor</span><span class="o">=</span><span class="n">predictor</span><span class="p">,</span>
            <span class="n">a</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">b</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">fit</span><span class="o">=</span><span class="n">fit</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">da_rivwth</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">output_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_config_variable_name</span><span class="p">(</span><span class="n">output_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="WflowBaseModel.setup_lulcmaps">
<a class="viewcode-back" href="../../api/advanced/base-model.html#hydromt_wflow.WflowBaseModel.setup_lulcmaps">[docs]</a>
    <span class="nd">@hydromt_step</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_lulcmaps</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">lulc_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">lulc_mapping_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">lulc_vars</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;landuse&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vegetation_kext&quot;</span><span class="p">,</span>
            <span class="s2">&quot;land_manning_n&quot;</span><span class="p">,</span>
            <span class="s2">&quot;soil_compacted_fraction&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vegetation_root_depth&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vegetation_leaf_storage&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vegetation_wood_storage&quot;</span><span class="p">,</span>
            <span class="s2">&quot;land_water_fraction&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vegetation_crop_factor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vegetation_feddes_alpha_h1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vegetation_feddes_h1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vegetation_feddes_h2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vegetation_feddes_h3_high&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vegetation_feddes_h3_low&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vegetation_feddes_h4&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">output_names_suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Derive several wflow maps based on landuse-landcover (LULC) data.</span>

<span class="sd">        Lookup table `lulc_mapping_fn` columns are converted to lulc classes model</span>
<span class="sd">        parameters based on literature. The data is remapped at its original resolution</span>
<span class="sd">        and then resampled to the model resolution using the average value, unless noted</span>
<span class="sd">        differently.</span>

<span class="sd">        Currently, if `lulc_fn` is set to the &quot;vito&quot;, &quot;globcover&quot;, &quot;esa_worldcover&quot;</span>
<span class="sd">        &quot;corine&quot; or &quot;glmnco&quot;, default lookup tables are available and will be used if</span>
<span class="sd">        `lulc_mapping_fn` is not provided.</span>

<span class="sd">        Adds model layers:</span>

<span class="sd">        * **landuse** map:</span>
<span class="sd">            Landuse class [-]</span>
<span class="sd">        * **vegetation_kext** map:</span>
<span class="sd">            Extinction coefficient in the canopy gap fraction equation [-]</span>
<span class="sd">        * **vegetation_leaf_storage** map:</span>
<span class="sd">            Specific leaf storage [mm]</span>
<span class="sd">        * **vegetation_wood_storage** map:</span>
<span class="sd">            Fraction of wood in the vegetation/plant [-]</span>
<span class="sd">        * **vegetation_root_depth** map:</span>
<span class="sd">            Length of vegetation roots [mm]</span>
<span class="sd">        * **soil_compacted_fraction** map:</span>
<span class="sd">            The fraction of compacted or urban area per grid cell [-]</span>
<span class="sd">        * **land_water_fraction** map:</span>
<span class="sd">            The fraction of open water per grid cell [-]</span>
<span class="sd">        * **land_manning_n** map:</span>
<span class="sd">            Manning Roughness [-]</span>
<span class="sd">        * **vegetation_crop_factor** map:</span>
<span class="sd">            Crop coefficient [-]</span>
<span class="sd">        * **vegetation_feddes_alpha_h1** map:</span>
<span class="sd">            Root water uptake reduction at soil water pressure head</span>
<span class="sd">            h1 (0 or 1) [-]</span>
<span class="sd">        * **vegetation_feddes_h1** map:</span>
<span class="sd">            Soil water pressure head h1 at which root water</span>
<span class="sd">            uptake is reduced (Feddes) [cm]</span>
<span class="sd">        * **vegetation_feddes_h2** map:</span>
<span class="sd">            Soil water pressure head h2 at which root water</span>
<span class="sd">            uptake is reduced (Feddes) [cm]</span>
<span class="sd">        * **vegetation_feddes_h3_high** map:</span>
<span class="sd">            Soil water pressure head h3 (high) at which root water uptake is</span>
<span class="sd">            reduced (Feddes) [cm]</span>
<span class="sd">        * **vegetation_feddes_h3_low** map:</span>
<span class="sd">            Soil water pressure head h3 (low) at which root water uptake is</span>
<span class="sd">            reduced (Feddes) [cm]</span>
<span class="sd">        * **vegetation_feddes_h4** map:</span>
<span class="sd">            Soil water pressure head h4 at which root water</span>
<span class="sd">            uptake is reduced (Feddes) [cm]</span>

<span class="sd">        Required setup methods:</span>

<span class="sd">        * :py:meth:`~WflowBaseModel.setup_basemaps`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lulc_fn : str, xarray.DataArray</span>
<span class="sd">            Name of RasterDataset source in data_sources.yml file.</span>
<span class="sd">        lulc_mapping_fn : str, Path, pd.DataFrame</span>
<span class="sd">            Path to a mapping csv file from landuse in source name to parameter values</span>
<span class="sd">            in lulc_vars. If lulc_fn is one of {&quot;globcover&quot;, &quot;vito&quot;, &quot;corine&quot;,</span>
<span class="sd">            &quot;esa_worldcover&quot;, &quot;glmnco&quot;}, a default mapping is used and this argument</span>
<span class="sd">            becomes optional.</span>
<span class="sd">        lulc_vars : list[str]</span>
<span class="sd">            List of landuse parameters to prepare.</span>
<span class="sd">            The names are the columns of the mapping file.</span>
<span class="sd">            Can be a subset of: [&quot;landuse&quot;, &quot;vegetation_kext&quot;, &quot;land_manning_n&quot;,</span>
<span class="sd">            &quot;soil_compacted_fraction&quot;, &quot;vegetation_root_depth&quot;,</span>
<span class="sd">            &quot;vegetation_leaf_storage&quot;, &quot;vegetation_wood_storage&quot;, &quot;land_water_fraction&quot;,</span>
<span class="sd">            &quot;vegetation_crop_factor&quot;, &quot;vegetation_feddes_alpha_h1&quot;,</span>
<span class="sd">            &quot;vegetation_feddes_h1&quot;, &quot;vegetation_feddes_h2&quot;, &quot;vegetation_feddes_h3_high&quot;,</span>
<span class="sd">            &quot;vegetation_feddes_h3_low&quot;, &quot;vegetation_feddes_h4&quot;]</span>
<span class="sd">        output_names_suffix : str, optional</span>
<span class="sd">            Suffix to be added to the output names to avoid having to rename all the</span>
<span class="sd">            columns of the mapping tables. For example if the suffix is &quot;vito&quot;, all</span>
<span class="sd">            variables in lulc_vars will be renamed to &quot;landuse_vito&quot;, &quot;Kext_vito&quot;, etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">workflows</span><span class="o">.</span><span class="n">validate_lulc_vars</span><span class="p">(</span><span class="n">lulc_vars</span><span class="p">)</span>
        <span class="n">output_names</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">workflows</span><span class="o">.</span><span class="n">LULC_VARS_MAPPING</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">output_names_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">output_names_suffix</span>
            <span class="k">else</span> <span class="n">k</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lulc_vars</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_naming</span><span class="p">(</span><span class="n">output_names</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Preparing LULC parameter maps.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lulc_mapping_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lulc_mapping_fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lulc_fn</span><span class="si">}</span><span class="s2">_mapping_default&quot;</span>

        <span class="c1"># read landuse map to DataArray</span>
        <span class="n">da</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_rasterdataset</span><span class="p">(</span>
            <span class="n">lulc_fn</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;landuse&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">df_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">(</span>
            <span class="n">lulc_mapping_fn</span><span class="p">,</span>
            <span class="n">source_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;pandas&quot;</span><span class="p">,</span> <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;index_col&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}},</span>
        <span class="p">)</span>
        <span class="c1"># process landuse</span>
        <span class="n">ds_lulc_maps</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">landuse</span><span class="p">(</span>
            <span class="n">da</span><span class="o">=</span><span class="n">da</span><span class="p">,</span>
            <span class="n">ds_like</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df_map</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">lulc_vars</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_landuse_on_staticmaps</span><span class="p">(</span><span class="n">ds_lulc_maps</span><span class="p">,</span> <span class="n">lulc_vars</span><span class="p">,</span> <span class="n">output_names_suffix</span><span class="p">)</span></div>


<div class="viewcode-block" id="WflowBaseModel.setup_lulcmaps_from_vector">
<a class="viewcode-back" href="../../api/advanced/base-model.html#hydromt_wflow.WflowBaseModel.setup_lulcmaps_from_vector">[docs]</a>
    <span class="nd">@hydromt_step</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_lulcmaps_from_vector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">lulc_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">lulc_mapping_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">lulc_vars</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;landuse&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vegetation_kext&quot;</span><span class="p">,</span>
            <span class="s2">&quot;land_manning_n&quot;</span><span class="p">,</span>
            <span class="s2">&quot;soil_compacted_fraction&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vegetation_root_depth&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vegetation_leaf_storage&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vegetation_wood_storage&quot;</span><span class="p">,</span>
            <span class="s2">&quot;land_water_fraction&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vegetation_crop_factor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vegetation_feddes_alpha_h1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vegetation_feddes_h1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vegetation_feddes_h2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vegetation_feddes_h3_high&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vegetation_feddes_h3_low&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vegetation_feddes_h4&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">lulc_res</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">all_touched</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">buffer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">save_raster_lulc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">output_names_suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Derive several wflow maps based on vector landuse-landcover (LULC) data.</span>

<span class="sd">        The vector lulc data is first rasterized to a raster map at the model resolution</span>
<span class="sd">        or at a higher resolution specified in ``lulc_res`` (recommended).</span>

<span class="sd">        Lookup table `lulc_mapping_fn` columns are converted to lulc classes model</span>
<span class="sd">        parameters based on literature. The data is remapped at its original resolution</span>
<span class="sd">        and then resampled to the model resolution using the average value, unless noted</span>
<span class="sd">        differently.</span>

<span class="sd">        Adds model layers:</span>

<span class="sd">        * **landuse** map:</span>
<span class="sd">            Landuse class [-]</span>
<span class="sd">        * **vegetation_kext** map:</span>
<span class="sd">            Extinction coefficient in the canopy gap fraction equation [-]</span>
<span class="sd">        * **vegetation_leaf_storage** map:</span>
<span class="sd">            Specific leaf storage [mm]</span>
<span class="sd">        * **vegetation_wood_storage** map:</span>
<span class="sd">            Fraction of wood in the vegetation/plant [-]</span>
<span class="sd">        * **vegetation_root_depth** map:</span>
<span class="sd">            Length of vegetation roots [mm]</span>
<span class="sd">        * **soil_compacted_fraction** map:</span>
<span class="sd">            The fraction of compacted or urban area per grid cell [-]</span>
<span class="sd">        * **land_water_fraction** map:</span>
<span class="sd">            The fraction of open water per grid cell [-]</span>
<span class="sd">        * **land_manning_n** map: Manning Roughness [-]</span>
<span class="sd">        * **vegetation_crop_factor** map:</span>
<span class="sd">            Crop coefficient [-]</span>
<span class="sd">        * **vegetation_feddes_alpha_h1** map:</span>
<span class="sd">            Root water uptake reduction at soil water pressure head</span>
<span class="sd">            h1 (0 or 1) [-]</span>
<span class="sd">        * **vegetation_feddes_h1** map:</span>
<span class="sd">            Soil water pressure head h1 at which root water</span>
<span class="sd">            uptake is reduced (Feddes) [cm]</span>
<span class="sd">        * **vegetation_feddes_h2** map:</span>
<span class="sd">            Soil water pressure head h2 at which root water</span>
<span class="sd">            uptake is reduced (Feddes) [cm]</span>
<span class="sd">        * **vegetation_feddes_h3_high** map:</span>
<span class="sd">            Soil water pressure head h3 (high) at which root water uptake is</span>
<span class="sd">            reduced (Feddes) [cm]</span>
<span class="sd">        * **vegetation_feddes_h3_low** map:</span>
<span class="sd">            Soil water pressure head h3 (low) at which root water uptake is</span>
<span class="sd">            reduced (Feddes) [cm]</span>
<span class="sd">        * **vegetation_feddes_h4** map:</span>
<span class="sd">            Soil water pressure head h4 at which root water</span>
<span class="sd">            uptake is reduced (Feddes) [cm]</span>

<span class="sd">        Required setup methods:</span>

<span class="sd">        * :py:meth:`~WflowBaseModel.setup_basemaps`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lulc_fn : str, gpd.GeoDataFrame</span>
<span class="sd">            GeoDataFrame or name in data catalog / path to (vector) landuse map.</span>

<span class="sd">            * Required columns: &#39;landuse&#39; [-]</span>
<span class="sd">        lulc_mapping_fn : str, Path, pd.DataFrame, None, optional</span>
<span class="sd">            Path to a mapping csv file from landuse in source name to parameter values</span>
<span class="sd">            in lulc_vars. If lulc_fn is one of {&quot;globcover&quot;, &quot;vito&quot;, &quot;corine&quot;,</span>
<span class="sd">            &quot;esa_worldcover&quot;, &quot;glmnco&quot;}, a default mapping is used and this argument</span>
<span class="sd">            becomes optional.</span>
<span class="sd">        lulc_vars : list[str], optional</span>
<span class="sd">            List of landuse parameters to prepare.</span>
<span class="sd">            The names are the columns of the mapping file.</span>
<span class="sd">            Can be a subset of: [&quot;landuse&quot;, &quot;vegetation_kext&quot;, &quot;land_manning_n&quot;,</span>
<span class="sd">            &quot;soil_compacted_fraction&quot;, &quot;vegetation_root_depth&quot;,</span>
<span class="sd">            &quot;vegetation_leaf_storage&quot;, &quot;vegetation_wood_storage&quot;, &quot;land_water_fraction&quot;,</span>
<span class="sd">            &quot;vegetation_crop_factor&quot;, &quot;vegetation_feddes_alpha_h1&quot;,</span>
<span class="sd">            &quot;vegetation_feddes_h1&quot;, &quot;vegetation_feddes_h2&quot;, &quot;vegetation_feddes_h3_high&quot;,</span>
<span class="sd">            &quot;vegetation_feddes_h3_low&quot;, &quot;vegetation_feddes_h4&quot;]</span>
<span class="sd">        lulc_res : float, int, None, optional</span>
<span class="sd">            Resolution of the intermediate rasterized landuse map. The unit (meter or</span>
<span class="sd">            degree) depends on the CRS of lulc_fn (projected or not). By default None,</span>
<span class="sd">            which uses the model resolution.</span>
<span class="sd">        all_touched : bool, optional</span>
<span class="sd">            If True, all pixels touched by the vector will be burned in the raster,</span>
<span class="sd">            by default False.</span>
<span class="sd">        buffer : int, optional</span>
<span class="sd">            Buffer around the bounding box of the vector data to ensure that all</span>
<span class="sd">            landuse classes are included in the rasterized map, by default 1000.</span>
<span class="sd">        save_raster_lulc : bool, optional</span>
<span class="sd">            If True, the (high) resolution rasterized landuse map will be saved to</span>
<span class="sd">            maps/landuse_raster.tif, by default False.</span>
<span class="sd">        output_names_suffix : str, None, optional</span>
<span class="sd">            Suffix to be added to the output names to avoid having to rename all the</span>
<span class="sd">            columns of the mapping tables. For example if the suffix is &quot;vito&quot;, all</span>
<span class="sd">            variables in lulc_vars will be renamed to &quot;landuse_vito&quot;, &quot;Kext_vito&quot;, etc.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        workflows.landuse_from_vector</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Preparing LULC parameter maps.&quot;</span><span class="p">)</span>
        <span class="n">workflows</span><span class="o">.</span><span class="n">validate_lulc_vars</span><span class="p">(</span><span class="n">lulc_vars</span><span class="p">)</span>

        <span class="n">output_names</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">workflows</span><span class="o">.</span><span class="n">LULC_VARS_MAPPING</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">output_names_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">output_names_suffix</span>
            <span class="k">else</span> <span class="n">k</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lulc_vars</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_naming</span><span class="p">(</span><span class="n">output_names</span><span class="p">)</span>

        <span class="c1"># Read mapping table</span>
        <span class="k">if</span> <span class="n">lulc_mapping_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lulc_mapping_fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lulc_fn</span><span class="si">}</span><span class="s2">_mapping_default&quot;</span>
        <span class="n">df_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">(</span>
            <span class="n">lulc_mapping_fn</span><span class="p">,</span>
            <span class="n">source_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;pandas&quot;</span><span class="p">,</span> <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;index_col&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}},</span>
        <span class="p">)</span>
        <span class="c1"># read landuse map</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_geodataframe</span><span class="p">(</span>
            <span class="n">lulc_fn</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>
            <span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">,</span>
            <span class="n">variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;landuse&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">save_raster_lulc</span><span class="p">:</span>
            <span class="n">lulc_out</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;maps&quot;</span><span class="p">,</span> <span class="s2">&quot;landuse_raster.tif&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lulc_out</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># process landuse</span>
        <span class="n">ds_lulc_maps</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">landuse_from_vector</span><span class="p">(</span>
            <span class="n">gdf</span><span class="o">=</span><span class="n">gdf</span><span class="p">,</span>
            <span class="n">ds_like</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df_map</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">lulc_vars</span><span class="p">,</span>
            <span class="n">lulc_res</span><span class="o">=</span><span class="n">lulc_res</span><span class="p">,</span>
            <span class="n">all_touched</span><span class="o">=</span><span class="n">all_touched</span><span class="p">,</span>
            <span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">,</span>
            <span class="n">lulc_out</span><span class="o">=</span><span class="n">lulc_out</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_landuse_on_staticmaps</span><span class="p">(</span><span class="n">ds_lulc_maps</span><span class="p">,</span> <span class="n">lulc_vars</span><span class="p">,</span> <span class="n">output_names_suffix</span><span class="p">)</span></div>


<div class="viewcode-block" id="WflowBaseModel.setup_outlets">
<a class="viewcode-back" href="../../api/advanced/base-model.html#hydromt_wflow.WflowBaseModel.setup_outlets">[docs]</a>
    <span class="nd">@hydromt_step</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_outlets</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">river_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">toml_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span><span class="p">,</span>
        <span class="n">gauge_toml_header</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;river_q&quot;</span><span class="p">],</span>
        <span class="n">gauge_toml_param</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;river_water__volume_flow_rate&quot;</span><span class="p">],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the default gauge map based on basin outlets.</span>

<span class="sd">        If the subcatchment map is available, the catchment outlets IDs will be matching</span>
<span class="sd">        the subcatchment IDs. If not, then IDs from 1 to number of outlets are used.</span>

<span class="sd">        Can also add csv/netcdf_scalar output settings in the TOML.</span>

<span class="sd">        Adds model layers:</span>

<span class="sd">        * **outlets** map: IDs map from catchment outlets [-]</span>
<span class="sd">        * **outlets** geom: polygon of catchment outlets</span>

<span class="sd">        Required setup methods:</span>

<span class="sd">        * :py:meth:`~WflowBaseModel.setup_rivers`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        river_only : bool, optional</span>
<span class="sd">            Only derive outlet locations if they are located on a river instead of</span>
<span class="sd">            locations for all catchments, by default True.</span>
<span class="sd">        toml_output : str, optional</span>
<span class="sd">            One of [&#39;csv&#39;, &#39;netcdf_scalar&#39;, None] to update [output.csv] or</span>
<span class="sd">            [output.netcdf_scalar] section of wflow toml file or do nothing. By</span>
<span class="sd">            default, &#39;csv&#39;.</span>
<span class="sd">        gauge_toml_header : list, optional</span>
<span class="sd">            Save specific model parameters in csv section. This option defines</span>
<span class="sd">            the header of the csv file.</span>
<span class="sd">            By default saves river_q (for river_water__volume_flow_rate).</span>
<span class="sd">        gauge_toml_param: list, optional</span>
<span class="sd">            Save specific model parameters in csv section. This option defines</span>
<span class="sd">            the wflow variable corresponding to the names in gauge_toml_header.</span>
<span class="sd">            By default saves river_water__volume_flow_rate (for river_q).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># read existing geoms; important to get the right basin when updating</span>
        <span class="c1"># fix in geoms.set / geoms.set method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Gauges locations set based on river outlets.&quot;</span><span class="p">)</span>
        <span class="n">idxs_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flwdir</span><span class="o">.</span><span class="n">idxs_pit</span>
        <span class="c1"># Only keep river outlets for gauges</span>
        <span class="k">if</span> <span class="n">river_only</span><span class="p">:</span>
            <span class="n">idxs_out</span> <span class="o">=</span> <span class="n">idxs_out</span><span class="p">[</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;rivmsk&quot;</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">idxs_out</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="c1"># Use the subcatchment ids</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;basins&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;basins&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">idxs_out</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">da_out</span><span class="p">,</span> <span class="n">idxs_out</span><span class="p">,</span> <span class="n">ids_out</span> <span class="o">=</span> <span class="n">flw</span><span class="o">.</span><span class="n">gauge_map</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">idxs</span><span class="o">=</span><span class="n">idxs_out</span><span class="p">,</span>
            <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
            <span class="n">flwdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flwdir</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">da_out</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;outlets&quot;</span><span class="p">)</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">points_from_xy</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">idx_to_xy</span><span class="p">(</span><span class="n">idxs_out</span><span class="p">))</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="n">ids_out</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">geometry</span><span class="o">=</span><span class="n">points</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span>
        <span class="p">)</span>
        <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;fid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ids_out</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;outlets&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Gauges map based on catchment river outlets added.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_config_output_timeseries</span><span class="p">(</span>
            <span class="n">mapname</span><span class="o">=</span><span class="s2">&quot;outlets&quot;</span><span class="p">,</span>
            <span class="n">toml_output</span><span class="o">=</span><span class="n">toml_output</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">gauge_toml_header</span><span class="p">,</span>
            <span class="n">param</span><span class="o">=</span><span class="n">gauge_toml_param</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="WflowBaseModel.setup_gauges">
<a class="viewcode-back" href="../../api/advanced/base-model.html#hydromt_wflow.WflowBaseModel.setup_gauges">[docs]</a>
    <span class="nd">@hydromt_step</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_gauges</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">gauges_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span>
        <span class="n">index_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">snap_to_river</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">snap_uparea</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">max_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10e3</span><span class="p">,</span>
        <span class="n">wdw</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">rel_error</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="n">abs_error</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">50.0</span><span class="p">,</span>
        <span class="n">fillna</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">derive_subcatch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">basename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">toml_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span><span class="p">,</span>
        <span class="n">gauge_toml_header</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;river_q&quot;</span><span class="p">,</span> <span class="s2">&quot;precip&quot;</span><span class="p">],</span>
        <span class="n">gauge_toml_param</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;river_water__volume_flow_rate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;atmosphere_water__precipitation_volume_flux&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set a gauge map based on ``gauges_fn`` data.</span>

<span class="sd">        Supported gauge datasets include data catlog entries, direct GeoDataFrame</span>
<span class="sd">        or &quot;&lt;path_to_source&gt;&quot; for user supplied csv or geometry files</span>
<span class="sd">        with gauge locations. If a csv file is provided, a &quot;x&quot; or &quot;lon&quot; and</span>
<span class="sd">        &quot;y&quot; or &quot;lat&quot; column is required and the first column will be used as</span>
<span class="sd">        IDs in the map.</span>

<span class="sd">        There are four available methods to prepare the gauge map:</span>

<span class="sd">        * no snapping: ``mask=None``, ``snap_to_river=False``, ``snap_uparea=False``.</span>
<span class="sd">          The gauge locations are used as is.</span>
<span class="sd">        * snapping to mask: the gauge locations are snapped to a boolean mask map based</span>
<span class="sd">          on the closest dowsntream cell within the mask:</span>
<span class="sd">          either provide ``mask`` or set ``snap_to_river=True``</span>
<span class="sd">          to snap to the river cells (default).</span>
<span class="sd">          ``max_dist`` can be used to set the maximum distance to snap to the mask.</span>
<span class="sd">        * snapping based on upstream area matching: : ``snap_uparea=True``.</span>
<span class="sd">          The gauge locations are snapped to the closest matching upstream area value.</span>
<span class="sd">          Requires gauges_fn to have an ``uparea`` [km2] column. The closest value will</span>
<span class="sd">          be looked for in a cell window of size ``wdw`` and the absolute and relative</span>
<span class="sd">          differences between the gauge and the closest value should be smaller than</span>
<span class="sd">          ``abs_error`` and ``rel_error``.</span>
<span class="sd">        * snapping based on upstream area matching and mask: ``snap_uparea=True``,</span>
<span class="sd">          ``mask`` or ``snap_to_river=True``. The gauge locations are snapped to the</span>
<span class="sd">          closest matching upstream area value within the mask.</span>

<span class="sd">        If ``derive_subcatch`` is set to True, an additional subcatch map is derived</span>
<span class="sd">        from the gauge locations.</span>

<span class="sd">        Finally the output locations can be added to wflow TOML file sections</span>
<span class="sd">        [output.csv] or [output.netcdf_scalar] using the ``toml_output`` option. The</span>
<span class="sd">        ``gauge_toml_header`` and ``gauge_toml_param`` options can be used to define</span>
<span class="sd">        the header and corresponding wflow variable names in the TOML file.</span>

<span class="sd">        Adds model layers:</span>

<span class="sd">        * **gauges_source** map: gauge IDs map from source [-] (if gauges_fn)</span>
<span class="sd">        * **subcatchment_source** map: subcatchment based on gauge locations [-] \</span>
<span class="sd">(if derive_subcatch)</span>
<span class="sd">        * **gauges_source** geom: polygon of gauges from source</span>
<span class="sd">        * **subcatchment_source** geom: polygon of subcatchment based on \</span>
<span class="sd">gauge locations [-] (if derive_subcatch)</span>

<span class="sd">        Required setup methods:</span>

<span class="sd">        * :py:meth:`~WflowBaseModel.setup_rivers`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        gauges_fn : str, Path, geopandas.GeoDataFrame</span>
<span class="sd">            Catalog source name, path to gauges file geometry file or</span>
<span class="sd">            geopandas.GeoDataFrame.</span>

<span class="sd">            * Required variables if snap_uparea is True: &#39;uparea&#39; [km2]</span>
<span class="sd">        index_col : str, optional</span>
<span class="sd">            Column in gauges_fn to use for ID values, by default None</span>
<span class="sd">            (use the default index column)</span>
<span class="sd">        mask : np.boolean, optional</span>
<span class="sd">            If provided snaps to the mask, else snaps to the river (default).</span>
<span class="sd">        snap_to_river : bool, optional</span>
<span class="sd">            Snap point locations to the closest downstream river cell, by default True</span>
<span class="sd">        snap_uparea: bool, optional</span>
<span class="sd">            Snap gauges based on upstream area. Gauges_fn should have &quot;uparea&quot;</span>
<span class="sd">            in its attributes.</span>
<span class="sd">        max_dist : float, optional</span>
<span class="sd">            Maximum distance [m] between original and snapped point location.</span>
<span class="sd">            A warning is logged if exceeded. By default 10 000m.</span>
<span class="sd">        wdw: int, optional</span>
<span class="sd">            Window size in number of cells around the gauge locations</span>
<span class="sd">            to snap uparea to, only used if ``snap_uparea`` is True. By default 3.</span>
<span class="sd">        rel_error: float, optional</span>
<span class="sd">            Maximum relative error (default 0.05)</span>
<span class="sd">            between the gauge location upstream area and the upstream area of</span>
<span class="sd">            the best fit grid cell, only used if snap_uparea is True.</span>
<span class="sd">        abs_error: float, optional</span>
<span class="sd">            Maximum absolute error (default 50.0)</span>
<span class="sd">            between the gauge location upstream area and the upstream area of</span>
<span class="sd">            the best fit grid cell, only used if snap_uparea is True.</span>
<span class="sd">        fillna: bool, optional</span>
<span class="sd">            Fill missing values in the gauges uparea column with the values from wflow</span>
<span class="sd">            upstream area (ie no snapping). By default False and the gauges with NaN</span>
<span class="sd">            values are skipped.</span>
<span class="sd">        derive_subcatch : bool, optional</span>
<span class="sd">            Derive subcatch map for gauges, by default False</span>
<span class="sd">        basename : str, optional</span>
<span class="sd">            Map name in grid (gauges_basename)</span>
<span class="sd">            if None use the gauges_fn basename.</span>
<span class="sd">        toml_output : str, optional</span>
<span class="sd">            One of [&#39;csv&#39;, &#39;netcdf_scalar&#39;, None] to update [output.csv] or</span>
<span class="sd">            [output.netcdf_scalar] section of wflow toml file or do nothing. By</span>
<span class="sd">            default, &#39;csv&#39;.</span>
<span class="sd">        gauge_toml_header : list, optional</span>
<span class="sd">            Save specific model parameters in csv section.</span>
<span class="sd">            This option defines the header of the csv file.</span>
<span class="sd">            By default saves river_q (for river_water__volume_flow_rate) and</span>
<span class="sd">            precip (for &quot;atmosphere_water__precipitation_volume_flux&quot;).</span>
<span class="sd">        gauge_toml_param: list, optional</span>
<span class="sd">            Save specific model parameters in csv section. This option defines</span>
<span class="sd">            the wflow variable corresponding to the names in gauge_toml_header.</span>
<span class="sd">            By default saves river_water__volume_flow_rate (for river_q) and</span>
<span class="sd">            &quot;atmosphere_water__precipitation_volume_flux&quot; (for precip).</span>
<span class="sd">        kwargs : dict, optional</span>
<span class="sd">            Additional keyword arguments to pass to the get_data method ie</span>
<span class="sd">            get_geodataframe or get_geodataset depending  on the data_type of gauges_fn.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Read data</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gauges_fn</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">):</span>
            <span class="n">gdf_gauges</span> <span class="o">=</span> <span class="n">gauges_fn</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">gdf_gauges</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s2">&quot;Point&quot;</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gauges_fn</span><span class="si">}</span><span class="s2"> contains other geometries than Point&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">isfile</span><span class="p">(</span><span class="n">gauges_fn</span><span class="p">):</span>
            <span class="c1"># hydromt#1243</span>
            <span class="c1"># try to get epsg number directly, important when writing back data_catalog</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="s2">&quot;to_epsg&quot;</span><span class="p">):</span>
                <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">to_epsg</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span>
            <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">}})</span>
            <span class="n">gdf_gauges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_geodataframe</span><span class="p">(</span>
                <span class="n">gauges_fn</span><span class="p">,</span>
                <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="p">,</span>
                <span class="c1"># assert_gtype=&quot;Point&quot;, hydromt#1243</span>
                <span class="n">handle_nodata</span><span class="o">=</span><span class="n">NoDataStrategy</span><span class="o">.</span><span class="n">IGNORE</span><span class="p">,</span>
                <span class="n">source_kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">contains_source</span><span class="p">(</span><span class="n">gauges_fn</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_source</span><span class="p">(</span><span class="n">gauges_fn</span><span class="p">)</span><span class="o">.</span><span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;GeoDataFrame&quot;</span><span class="p">:</span>
                <span class="n">gdf_gauges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_geodataframe</span><span class="p">(</span>
                    <span class="n">gauges_fn</span><span class="p">,</span>
                    <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="p">,</span>
                    <span class="c1"># assert_gtype=&quot;Point&quot;, hydromt#1243</span>
                    <span class="n">handle_nodata</span><span class="o">=</span><span class="n">NoDataStrategy</span><span class="o">.</span><span class="n">IGNORE</span><span class="p">,</span>
                    <span class="n">source_kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_source</span><span class="p">(</span><span class="n">gauges_fn</span><span class="p">)</span><span class="o">.</span><span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;GeoDataset&quot;</span><span class="p">:</span>
                <span class="n">da</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_geodataset</span><span class="p">(</span>
                    <span class="n">gauges_fn</span><span class="p">,</span>
                    <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="p">,</span>
                    <span class="c1"># assert_gtype=&quot;Point&quot;, hydromt#1243</span>
                    <span class="n">handle_nodata</span><span class="o">=</span><span class="n">NoDataStrategy</span><span class="o">.</span><span class="n">IGNORE</span><span class="p">,</span>
                    <span class="n">source_kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">gdf_gauges</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">to_gdf</span><span class="p">()</span>
                <span class="c1"># Check for point geometry</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">gdf_gauges</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s2">&quot;Point&quot;</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gauges_fn</span><span class="si">}</span><span class="s2"> contains other geometries than Point&quot;</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gauges_fn</span><span class="si">}</span><span class="s2"> data source not found or incorrect data_type &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_source</span><span class="p">(</span><span class="n">gauges_fn</span><span class="p">)</span><span class="o">.</span><span class="n">data_type</span><span class="si">}</span><span class="s2"> instead of &quot;</span>
                <span class="s2">&quot;GeoDataFrame or GeoDataset).&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Create basename</span>
        <span class="k">if</span> <span class="n">basename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">gauges_fn</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>

        <span class="c1"># Check if there is data found</span>
        <span class="k">if</span> <span class="n">gdf_gauges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipping method, as no data has been found&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Create the gauges map</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gdf_gauges</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">basename</span><span class="si">}</span><span class="s2"> gauge locations found within domain&quot;</span>
        <span class="p">)</span>

        <span class="c1"># read existing geoms; important to get the right basin when updating</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span>
        <span class="c1"># Reproject to model crs</span>
        <span class="n">gdf_gauges</span> <span class="o">=</span> <span class="n">gdf_gauges</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Get coords, index and ID</span>
        <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))(</span>
            <span class="n">gdf_gauges</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">xy_to_idx</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">index_col</span> <span class="ow">in</span> <span class="n">gdf_gauges</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">gdf_gauges</span> <span class="o">=</span> <span class="n">gdf_gauges</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index_col</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">gdf_gauges</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Gauge ID 0 is not allowed, setting to 1&quot;</span><span class="p">)</span>
            <span class="n">gdf_gauges</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">gdf_gauges</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">gdf_gauges</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># if snap_to_river use river map as the mask</span>
        <span class="k">if</span> <span class="n">snap_to_river</span> <span class="ow">and</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;rivmsk&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="n">snap_uparea</span> <span class="ow">and</span> <span class="s2">&quot;uparea&quot;</span> <span class="ow">in</span> <span class="n">gdf_gauges</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="c1"># Derive gauge map based on upstream area snapping</span>
            <span class="n">da</span><span class="p">,</span> <span class="n">idxs</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">gauge_map_uparea</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="n">gdf_gauges</span><span class="p">,</span>
                <span class="n">uparea_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;uparea&quot;</span><span class="p">],</span>
                <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                <span class="n">wdw</span><span class="o">=</span><span class="n">wdw</span><span class="p">,</span>
                <span class="n">rel_error</span><span class="o">=</span><span class="n">rel_error</span><span class="p">,</span>
                <span class="n">abs_error</span><span class="o">=</span><span class="n">abs_error</span><span class="p">,</span>
                <span class="n">fillna</span><span class="o">=</span><span class="n">fillna</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Derive gauge map</span>
            <span class="n">da</span><span class="p">,</span> <span class="n">idxs</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">flw</span><span class="o">.</span><span class="n">gauge_map</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="n">idxs</span><span class="o">=</span><span class="n">idxs</span><span class="p">,</span>
                <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
                <span class="n">stream</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                <span class="n">flwdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flwdir</span><span class="p">,</span>
                <span class="n">max_dist</span><span class="o">=</span><span class="n">max_dist</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Filter gauges that could not be snapped to rivers</span>
            <span class="k">if</span> <span class="n">snap_to_river</span><span class="p">:</span>
                <span class="n">ids_old</span> <span class="o">=</span> <span class="n">ids</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;rivmsk&quot;</span><span class="p">]]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">nodata</span>
                <span class="p">)</span>
                <span class="n">ids_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">da</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">idxs</span> <span class="o">=</span> <span class="n">idxs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">ids_old</span><span class="p">,</span> <span class="n">ids_new</span><span class="p">)]</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span>

        <span class="c1"># Check if there are gauges left</span>
        <span class="k">if</span> <span class="n">ids</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;No gauges found within domain after snapping, skipping method.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Add to grid</span>
        <span class="n">mapname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;gauges_</span><span class="si">{</span><span class="n">basename</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">mapname</span><span class="p">)</span>

        <span class="c1"># geoms</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">points_from_xy</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">idx_to_xy</span><span class="p">(</span><span class="n">idxs</span><span class="p">))</span>
        <span class="c1"># if csv contains additional columns, these are also written in the geoms</span>
        <span class="n">gdf_snapped</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="n">ids</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">geometry</span><span class="o">=</span><span class="n">points</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span>
        <span class="p">)</span>
        <span class="c1"># Set the index name of gdf snapped based on original gdf</span>
        <span class="k">if</span> <span class="n">gdf_gauges</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gdf_snapped</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">gdf_gauges</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gdf_snapped</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;fid&quot;</span>
            <span class="n">gdf_gauges</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;fid&quot;</span>
        <span class="c1"># Add gdf attributes to gdf_snapped (filter on snapped index before merging)</span>
        <span class="n">df_attrs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">gdf_gauges</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;geometry&quot;</span><span class="p">))</span>
        <span class="n">df_attrs</span> <span class="o">=</span> <span class="n">df_attrs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">df_attrs</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">gdf_snapped</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
        <span class="n">gdf_snapped</span> <span class="o">=</span> <span class="n">gdf_snapped</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_attrs</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">gdf_gauges</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># Add gdf_snapped to geoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">gdf_snapped</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">mapname</span><span class="p">)</span>

        <span class="c1"># Add output timeseries for gauges in the toml</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_config_output_timeseries</span><span class="p">(</span>
            <span class="n">mapname</span><span class="o">=</span><span class="n">mapname</span><span class="p">,</span>
            <span class="n">toml_output</span><span class="o">=</span><span class="n">toml_output</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">gauge_toml_header</span><span class="p">,</span>
            <span class="n">param</span><span class="o">=</span><span class="n">gauge_toml_param</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># add subcatch</span>
        <span class="k">if</span> <span class="n">derive_subcatch</span><span class="p">:</span>
            <span class="n">da_basins</span> <span class="o">=</span> <span class="n">flw</span><span class="o">.</span><span class="n">basin_map</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flwdir</span><span class="p">,</span> <span class="n">idxs</span><span class="o">=</span><span class="n">idxs</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="n">ids</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mapname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;basins&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">basename</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">da_basins</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">mapname</span><span class="p">)</span>
            <span class="n">gdf_basins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">mapname</span><span class="p">]</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">vectorize</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">gdf_basins</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">mapname</span><span class="p">)</span></div>


<div class="viewcode-block" id="WflowBaseModel.setup_constant_pars">
<a class="viewcode-back" href="../../api/advanced/base-model.html#hydromt_wflow.WflowBaseModel.setup_constant_pars">[docs]</a>
    <span class="nd">@hydromt_step</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_constant_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate constant parameter maps for all active model cells.</span>

<span class="sd">        Adds model layer:</span>

<span class="sd">        * **param_name** map: constant parameter map.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dtype: str</span>
<span class="sd">            data type</span>
<span class="sd">        nodata: int or float</span>
<span class="sd">            nodata value</span>
<span class="sd">        kwargs</span>
<span class="sd">            &quot;param_name: value&quot; pairs for constant grid.</span>
<span class="sd">            Param_name should be the Wflow.jl variable name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wflow_variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_WFLOW_NAMES</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">wflow_var</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">wflow_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wflow_variables</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Parameter </span><span class="si">{</span><span class="n">wflow_var</span><span class="si">}</span><span class="s2"> not recognised as a Wflow variable. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Please check the name.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># check if param is already in toml and will be overwritten</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">wflow_var</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Parameter </span><span class="si">{</span><span class="n">wflow_var</span><span class="si">}</span><span class="s2"> already in toml and will be overwritten.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># remove from config</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">wflow_var</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># Add to config</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;input.static.</span><span class="si">{</span><span class="n">wflow_var</span><span class="si">}</span><span class="s2">.value&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="WflowBaseModel.setup_grid_from_raster">
<a class="viewcode-back" href="../../api/advanced/base-model.html#hydromt_wflow.WflowBaseModel.setup_grid_from_raster">[docs]</a>
    <span class="nd">@hydromt_step</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_grid_from_raster</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">raster_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
        <span class="n">reproject_method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">variables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">wflow_variables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fill_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add data variable(s) from ``raster_fn`` to grid object.</span>

<span class="sd">        If raster is a dataset, all variables will be added unless ``variables``</span>
<span class="sd">        list is specified. The config toml can also be updated to include</span>
<span class="sd">        the new maps using ``wflow_variables``.</span>

<span class="sd">        Adds model layers:</span>

<span class="sd">        * **raster.name** or **variables** grid: data from raster_fn</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        raster_fn: str</span>
<span class="sd">            Source name of RasterDataset in data_catalog.</span>
<span class="sd">        reproject_method: str</span>
<span class="sd">            Reprojection method from rasterio.enums.Resampling.</span>
<span class="sd">            Available methods: [&#39;nearest&#39;, &#39;bilinear&#39;, &#39;cubic&#39;, &#39;cubic_spline&#39;, \</span>
<span class="sd">&#39;lanczos&#39;, &#39;average&#39;, &#39;mode&#39;, &#39;gauss&#39;, &#39;max&#39;, &#39;min&#39;, &#39;med&#39;, &#39;q1&#39;, &#39;q3&#39;, \</span>
<span class="sd">&#39;sum&#39;, &#39;rms&#39;]</span>
<span class="sd">        variables: list, optional</span>
<span class="sd">            List of variables to add to grid from raster_fn. By default all.</span>
<span class="sd">        wflow_variables: list, optional</span>
<span class="sd">            List of corresponding wflow variables to update the config toml</span>
<span class="sd">            (e.g: [&quot;vegetation_root__depth&quot;]).</span>
<span class="sd">            Should match the variables list. variables list should be provided unless</span>
<span class="sd">            raster_fn contains a single variable (len 1).</span>
<span class="sd">        fill_method : str, optional</span>
<span class="sd">            If specified, fills nodata values using fill_nodata method.</span>
<span class="sd">            Available methods are {&#39;linear&#39;, &#39;nearest&#39;, &#39;cubic&#39;, &#39;rio_idw&#39;}.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing grid data from raster source </span><span class="si">{</span><span class="n">raster_fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Read raster data and select variables</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_rasterdataset</span><span class="p">(</span>
            <span class="n">raster_fn</span><span class="p">,</span>
            <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span>
            <span class="n">buffer</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span>
            <span class="n">single_var_as_array</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Fill nodata</span>
        <span class="k">if</span> <span class="n">fill_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">interpolate_na</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">fill_method</span><span class="p">)</span>
        <span class="c1"># Reprojection</span>
        <span class="n">ds_out</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">reproject_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">reproject_method</span><span class="p">)</span>
        <span class="c1"># Add to grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ds_out</span><span class="p">)</span>

        <span class="c1"># Update config</span>
        <span class="k">if</span> <span class="n">wflow_variables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating the config for wflow_variables: </span><span class="si">{</span><span class="n">wflow_variables</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">variables</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds_out</span><span class="o">.</span><span class="n">data_vars</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ds_out</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Cannot update the toml if raster_fn has more than </span><span class="se">\</span>
<span class="s2">one variable and variables list is not provided.&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Check on len</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wflow_variables</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Length of variables </span><span class="si">{</span><span class="n">variables</span><span class="si">}</span><span class="s2"> do not match wflow_variables </span><span class="se">\</span>
<span class="si">{</span><span class="n">wflow_variables</span><span class="si">}</span><span class="s2">. Cannot update the toml.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;input.static.</span><span class="si">{</span><span class="n">wflow_variables</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">variables</span><span class="p">[</span><span class="n">i</span><span class="p">])</span></div>


<div class="viewcode-block" id="WflowBaseModel.setup_areamap">
<a class="viewcode-back" href="../../api/advanced/base-model.html#hydromt_wflow.WflowBaseModel.setup_areamap">[docs]</a>
    <span class="nd">@hydromt_step</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_areamap</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">area_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span>
        <span class="n">col2raster</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">nodata</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">output_names</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set area map from vector data to save wflow outputs for specific area.</span>

<span class="sd">        Adds model layer:</span>

<span class="sd">        * **col2raster** map:  output area data map</span>

<span class="sd">        Required setup methods:</span>

<span class="sd">        * :py:meth:`~WflowBaseModel.setup_basemaps`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        area_fn : str, geopandas.GeoDataFrame</span>
<span class="sd">            Name of GeoDataFrame data corresponding to wflow output area.</span>
<span class="sd">        col2raster : str</span>
<span class="sd">            Name of the column from `area_fn` to rasterize.</span>
<span class="sd">        nodata : int/float, optional</span>
<span class="sd">            Nodata value to use when rasterizing. Should match the dtype of `col2raster`</span>
<span class="sd">            . By default -1.</span>
<span class="sd">        output_names : dict, optional</span>
<span class="sd">            Dictionary with output names that will be used in the model netcdf input</span>
<span class="sd">            files. Users should provide the Wflow.jl variable name followed by the name</span>
<span class="sd">            in the netcdf file. If another name is provided than col2raster, this name</span>
<span class="sd">            will be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing &#39;</span><span class="si">{</span><span class="n">col2raster</span><span class="si">}</span><span class="s2">&#39; map from &#39;</span><span class="si">{</span><span class="n">area_fn</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_naming</span><span class="p">(</span><span class="n">output_names</span><span class="p">)</span>
        <span class="n">gdf_org</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_geodataframe</span><span class="p">(</span>
            <span class="n">area_fn</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="p">,</span> <span class="n">dst_crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">gdf_org</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No shapes of </span><span class="si">{</span><span class="n">area_fn</span><span class="si">}</span><span class="s2"> found within region, skipping areamap.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">da_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span>
                <span class="n">gdf</span><span class="o">=</span><span class="n">gdf_org</span><span class="p">,</span>
                <span class="n">col_name</span><span class="o">=</span><span class="n">col2raster</span><span class="p">,</span>
                <span class="n">nodata</span><span class="o">=</span><span class="n">nodata</span><span class="p">,</span>
                <span class="n">all_touched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">output_names</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Only one output name is allowed for areamap, </span><span class="se">\</span>
<span class="s2">                    please provide a dictionary with one key.&quot;</span>
                <span class="p">)</span>
            <span class="n">col2raster_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">output_names</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_config_variable_name</span><span class="p">(</span><span class="n">col2raster_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">col2raster_name</span> <span class="o">=</span> <span class="n">col2raster</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">da_area</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">col2raster_name</span><span class="p">))</span></div>


    <span class="c1">## WFLOW other step methods (clip and upgrade)</span>
<div class="viewcode-block" id="WflowBaseModel.clip">
<a class="viewcode-back" href="../../api/advanced/base-model.html#hydromt_wflow.WflowBaseModel.clip">[docs]</a>
    <span class="nd">@hydromt_step</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">clip</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">region</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">inverse_clip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">clip_forcing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">clip_states</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">reservoir_maps</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="n">reservoir_states</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="n">crs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4326</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clip model to region.</span>

<span class="sd">        First the staticmaps are clipped to the region.</span>
<span class="sd">        Then the staticgeoms are re-generated to match the new grid for basins and</span>
<span class="sd">        rivers and clipped for the others.</span>
<span class="sd">        Finally the forcing and states are clipped to the new grid extent.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        region : dict</span>
<span class="sd">            See :meth:`models.wflow_base.WflowBaseModel.setup_basemaps`</span>
<span class="sd">        inverse_clip: bool, optional</span>
<span class="sd">            Flag to perform &quot;inverse clipping&quot;: removing an upstream part of the model</span>
<span class="sd">            instead of the subbasin itself, by default False</span>
<span class="sd">        clip_forcing: bool, optional</span>
<span class="sd">            Flag to clip the forcing to the new grid extent, by default True</span>
<span class="sd">        clip_states: bool, optional</span>
<span class="sd">            Flag to clip the states to the new grid extent, by default True</span>
<span class="sd">        reservoir_maps: dict[str, str | None] = {},</span>
<span class="sd">            Dictionnary of staticmap names in the wflow model staticmaps and</span>
<span class="sd">            corresponding wflow input variables to be treated as</span>
<span class="sd">            reservoirs. These maps are removed if empty after clipping.</span>
<span class="sd">        reservoir_states: dict[str, str | None] = {},</span>
<span class="sd">            Dictionnary of state names in the wflow model states and corresponding</span>
<span class="sd">            wflow state variables to be treated as reservoirs.</span>
<span class="sd">            These states are removed if no reservoir was found after clipping.</span>
<span class="sd">        crs: int, optional</span>
<span class="sd">            Default crs of the model in case it cannot be read.</span>
<span class="sd">            By default 4326 (WGS84)</span>
<span class="sd">        **kwargs: dict</span>
<span class="sd">            Additional keyword arguments passed to</span>
<span class="sd">            :py:meth:`~hydromt.raster.Raster.clip_geom`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 0. Read the model in case not done yet</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">is_reading_mode</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading full model before clipping..&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="c1"># 1. Clip staticmaps</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Clipping staticmaps..&quot;</span><span class="p">)</span>
        <span class="n">basins_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;basins&quot;</span><span class="p">]</span>
        <span class="n">flwdir_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;flwdir&quot;</span><span class="p">]</span>
        <span class="n">reservoir_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;reservoir_area_id&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
            <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
            <span class="n">inverse_clip</span><span class="o">=</span><span class="n">inverse_clip</span><span class="p">,</span>
            <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span>
            <span class="n">basins_name</span><span class="o">=</span><span class="n">basins_name</span><span class="p">,</span>
            <span class="n">flwdir_name</span><span class="o">=</span><span class="n">flwdir_name</span><span class="p">,</span>
            <span class="n">reservoir_name</span><span class="o">=</span><span class="n">reservoir_name</span><span class="p">,</span>
            <span class="n">reservoir_maps</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">reservoir_maps</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Re-derive flwdir after clipping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flwdir</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># make sure old flwdir object is removed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flwdir</span>

        <span class="c1"># 2. Reinitialize geoms, re-create basins/rivers/outlets and clip the rest</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Re-generating/clipping staticgeoms..&quot;</span><span class="p">)</span>
        <span class="n">old_geoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rivers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_outlets</span><span class="p">()</span>
        <span class="n">exclude_geoms</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;basins&quot;</span><span class="p">,</span> <span class="s2">&quot;basins_highres&quot;</span><span class="p">,</span> <span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="s2">&quot;rivers&quot;</span><span class="p">,</span> <span class="s2">&quot;outlets&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">gdf</span> <span class="ow">in</span> <span class="n">old_geoms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_geoms</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clipping geometry </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">..&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                    <span class="n">geom</span><span class="o">=</span><span class="n">gdf</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="p">,</span> <span class="n">keep_geom_type</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># 3. Clip states</span>
        <span class="k">if</span> <span class="n">clip_states</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
                <span class="n">reservoir_name</span><span class="o">=</span><span class="n">reservoir_name</span><span class="p">,</span>
                <span class="n">reservoir_states</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">reservoir_states</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">()</span>  <span class="c1"># clear states</span>

        <span class="c1"># 4. Clip forcing</span>
        <span class="k">if</span> <span class="n">clip_forcing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forcing</span><span class="o">.</span><span class="n">clip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forcing</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">()</span>  <span class="c1"># clear forcing</span>

        <span class="c1"># 5. Update config</span>
        <span class="k">if</span> <span class="n">reservoir_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">remove_reservoirs</span><span class="p">(</span>
                <span class="nb">input</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">reservoir_maps</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                <span class="n">state</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">reservoir_states</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="p">)</span></div>


    <span class="c1"># I/O</span>
<div class="viewcode-block" id="WflowBaseModel.write">
<a class="viewcode-back" href="../../api/advanced/base-model.html#hydromt_wflow.WflowBaseModel.write">[docs]</a>
    <span class="nd">@hydromt_step</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">grid_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">geoms_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;staticgeoms&quot;</span><span class="p">,</span>
        <span class="n">forcing_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">states_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the complete model schematization and configuration to file.</span>

<span class="sd">        From this function, the output filenames/folder of the different components can</span>
<span class="sd">        be set. If not set, the default filenames/folder are used.</span>

<span class="sd">        To change more advanced settings, use the specific write methods directly.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        config_filename : str, optional</span>
<span class="sd">            Name of the config file, relative to model root. By default None to use the</span>
<span class="sd">            default name.</span>
<span class="sd">        grid_filename : str, optional</span>
<span class="sd">            Name of the grid file, relative to model root/dir_input. By default None</span>
<span class="sd">            to use the name as defined in the model config file.</span>
<span class="sd">        geoms_folder : str, optional</span>
<span class="sd">            Name of the geoms folder relative to grid_filename (ie model</span>
<span class="sd">            root/dir_input). By default &#39;staticgeoms&#39;.</span>
<span class="sd">        forcing_filename : str, optional</span>
<span class="sd">            Name of the forcing file relative to model root/dir_input. By default None</span>
<span class="sd">            to use the name as defined in the model config file.</span>
<span class="sd">        states_filename : str, optional</span>
<span class="sd">            Name of the states file relative to model root/dir_input. By default None</span>
<span class="sd">            to use the name as defined in the model config file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Write model data to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># if in r, r+ mode, only write updated components</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">is_writing_mode</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot write in read-only mode&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_data_catalog</span><span class="p">()</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># try to read default if not yet set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">grid_filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">write_region</span><span class="p">(</span>
            <span class="n">filename</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">geoms_folder</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;region.geojson&quot;</span><span class="p">),</span> <span class="n">to_wgs84</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">geoms_folder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forcing</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">forcing_filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">states_filename</span><span class="p">)</span>

        <span class="c1"># Write the config last as variables can get set in other write methods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">config_filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="WflowBaseModel.read">
<a class="viewcode-back" href="../../api/advanced/base-model.html#hydromt_wflow.WflowBaseModel.read">[docs]</a>
    <span class="nd">@hydromt_step</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">geoms_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;staticgeoms&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read components from disk.</span>

<span class="sd">        From this function, the input filenames/folder of the config and geoms</span>
<span class="sd">        components can be set. For the others, the filenames/folder as defined in the</span>
<span class="sd">        config file are used.</span>

<span class="sd">        To change more advanced settings, use the specific read methods directly.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        config_filename : str | None, optional</span>
<span class="sd">            Name of the config file, relative to model root. By default None to use the</span>
<span class="sd">            default name.</span>
<span class="sd">        geoms_folder : str | None, optional</span>
<span class="sd">            Name of the geoms folder relative to grid_filename (ie model</span>
<span class="sd">            root/dir_input). By default &#39;staticgeoms&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">config_filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">geoms_folder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forcing</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>


<div class="viewcode-block" id="WflowBaseModel.set_states">
<a class="viewcode-back" href="../../api/advanced/base-model.html#hydromt_wflow.WflowBaseModel.set_states">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_states</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span> <span class="o">|</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add data to states.</span>

<span class="sd">        All layers of states must have identical spatial coordinates. This is an</span>
<span class="sd">        inherited method from HydroMT-core&#39;s StatesModel.set_states with some fixes.</span>
<span class="sd">        If basin data is available the states will be masked to that upon setting.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: xarray.DataArray or xarray.Dataset</span>
<span class="sd">            new map layer to add to states</span>
<span class="sd">        name: str, optional</span>
<span class="sd">            Name of new map layer, this is used to overwrite the name of a DataArray and</span>
<span class="sd">            ignored if data is a Dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;basins&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mask_raster_from_layer</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;basins&quot;</span><span class="p">]]</span>
            <span class="p">)</span>
        <span class="c1"># fall back on default set_states behaviour</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="WflowBaseModel.read_outputs">
<a class="viewcode-back" href="../../api/advanced/base-model.html#hydromt_wflow.WflowBaseModel.read_outputs">[docs]</a>
    <span class="nd">@hydromt_step</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read outputs at &lt;root/dir_output&gt;.</span>

<span class="sd">        Reads netcdf_grid at ``output.netcdf_grid.path``, netcdf_scalar at</span>
<span class="sd">        ``output.netcdf_scalar.path`` and csv outputs at ``output.csv.path``.</span>

<span class="sd">        Checks if ``dir_output`` is present.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_grid</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_scalar</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_csv</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_update_naming</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rename_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the naming of the model variables.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rename_dict: dict</span>
<span class="sd">            Dictionary with the wflow variable and new output name in file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_wflow_names_inv</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_WFLOW_NAMES</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">_hydromt_names_inv</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">wflow_var</span><span class="p">,</span> <span class="n">new_name</span> <span class="ow">in</span> <span class="n">rename_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">wflow_var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Find the previous name in self._WFLOW_NAMES</span>
            <span class="n">old_name</span> <span class="o">=</span> <span class="n">_wflow_names_inv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wflow_var</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Rename the variable in self._WFLOW_NAMES</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_WFLOW_NAMES</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_WFLOW_NAMES</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">wflow_var</span>
                <span class="c1"># Rename the variable in self._MAPS</span>
                <span class="n">hydromt_name</span> <span class="o">=</span> <span class="n">_hydromt_names_inv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">old_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">hydromt_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="n">hydromt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wflow variable </span><span class="si">{</span><span class="n">wflow_var</span><span class="si">}</span><span class="s2"> not found, check spelling.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_config_variable_name</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">data_vars</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">data_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;static&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the variable names in the config file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_vars: list of str</span>
<span class="sd">            List of variable names to update in the config file.</span>
<span class="sd">        data_type: str, optional</span>
<span class="sd">            Type of data (static, forcing, cyclic, None), by default &quot;static&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_vars</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_vars</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">data_vars</span>
        <span class="n">_prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;input.</span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">data_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;input&quot;</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">data_vars</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_WFLOW_NAMES</span><span class="p">:</span>
                <span class="c1"># Get the name from the Wflow variable name</span>
                <span class="n">wflow_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_WFLOW_NAMES</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
                <span class="c1"># Update the config variable name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_prefix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">wflow_var</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
            <span class="c1"># else not a wflow variable</span>
            <span class="c1"># (spelling mistakes should have been checked in _update_naming)</span>

    <span class="c1">## WFLOW specific data and method</span>
    <span class="c1"># Non model component properties</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">basins</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a basin(s) geometry as a geopandas.GeoDataFrame.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;basins&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;basins&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;basins&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;basins&quot;</span><span class="p">]]</span>
                <span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">vectorize</span><span class="p">()</span>
                <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;basins&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Basin map </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s1">&#39;basins&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found in grid.&quot;</span><span class="p">)</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">gdf</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">basins_highres</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a high resolution basin(s) geometry.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;basins_highres&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;basins_highres&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basins</span>
        <span class="k">return</span> <span class="n">gdf</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rivers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a river geometry as a geopandas.GeoDataFrame.</span>

<span class="sd">        If available, the stream order and upstream area values are added to</span>
<span class="sd">        the geometry properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;rivers&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rivers&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;rivmsk&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">rivmsk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;rivmsk&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="c1"># Check if there are river cells in the model before continuing</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">rivmsk</span><span class="p">):</span>
                <span class="c1"># add stream order &#39;strord&#39; column</span>
                <span class="n">strord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flwdir</span><span class="o">.</span><span class="n">stream_order</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="n">rivmsk</span><span class="p">)</span>
                <span class="n">feats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flwdir</span><span class="o">.</span><span class="n">streams</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="n">rivmsk</span><span class="p">,</span> <span class="n">strord</span><span class="o">=</span><span class="n">strord</span><span class="p">)</span>
                <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="o">.</span><span class="n">from_features</span><span class="p">(</span><span class="n">feats</span><span class="p">)</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="o">.</span><span class="n">from_user_input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;rivers&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No river cells detected in the selected basin.&quot;</span><span class="p">)</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">gdf</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">flwdir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyflwdir</span><span class="o">.</span><span class="n">FlwdirRaster</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the pyflwdir.FlwdirRaster object parsed from wflow ldd.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flwdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_flwdir</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flwdir</span>

<div class="viewcode-block" id="WflowBaseModel.set_flwdir">
<a class="viewcode-back" href="../../api/advanced/base-model.html#hydromt_wflow.WflowBaseModel.set_flwdir">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_flwdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s2">&quot;infer&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse pyflwdir.FlwdirRaster object parsed from the wflow ldd.&quot;&quot;&quot;</span>
        <span class="n">flwdir_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;flwdir&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flwdir</span> <span class="o">=</span> <span class="n">flw</span><span class="o">.</span><span class="n">flwdir_from_da</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">flwdir_name</span><span class="p">],</span>
            <span class="n">ftype</span><span class="o">=</span><span class="n">ftype</span><span class="p">,</span>
            <span class="n">check_ftype</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;basins&quot;</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_set_landuse_on_staticmaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds_lulc_maps</span><span class="p">,</span> <span class="n">lulc_vars</span><span class="p">,</span> <span class="n">output_names_suffix</span><span class="p">):</span>
        <span class="c1"># As landuse is not a wflow variable, we update the name manually</span>
        <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;landuse&quot;</span><span class="p">:</span> <span class="s2">&quot;meta_landuse&quot;</span><span class="p">}</span> <span class="k">if</span> <span class="s2">&quot;landuse&quot;</span> <span class="ow">in</span> <span class="n">lulc_vars</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">output_names_suffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="s2">&quot;landuse&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;meta_landuse_</span><span class="si">{</span><span class="n">output_names_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># rename dict for the staticmaps (hydromt names are not used in that case)</span>
            <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">output_names_suffix</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lulc_vars</span><span class="p">}</span>
            <span class="k">if</span> <span class="s2">&quot;landuse&quot;</span> <span class="ow">in</span> <span class="n">lulc_vars</span><span class="p">:</span>
                <span class="n">rename_dict</span><span class="p">[</span><span class="s2">&quot;landuse&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;meta_landuse_</span><span class="si">{</span><span class="n">output_names_suffix</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">staticmaps</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ds_lulc_maps</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rename_dict</span><span class="p">))</span>
        <span class="c1"># Add entries to the config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_config_variable_name</span><span class="p">(</span><span class="n">ds_lulc_maps</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rename_dict</span><span class="p">)</span><span class="o">.</span><span class="n">data_vars</span><span class="p">)</span></div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
       Copyright Deltares.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>